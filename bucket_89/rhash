# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		rhash
VERSION=		1.3.4
KEYWORDS=		security
VARIANTS=		standard
SDESC[standard]=	File digest library and utility
HOMEPAGE=		http://rhash.anz.ru/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		SF/rhash/rhash/1.3.4
DISTFILE[1]=		rhash-1.3.4-src.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

LICENSE=		MIT:single
LICENSE_SCHEME=		solo
LICENSE_FILE=		MIT:{{WRKSRC}}/COPYING

BUILD_TARGET=		build-shared
MAKE_ARGS=		INSTALL_PROGRAM="{{INSTALL_PROGRAM}}"
			INSTALL_SHARED="{{INSTALL_PROGRAM}}"
			MANDIR="{{MANPREFIX}}/man"

INSTALL_TARGET=		install-shared
INSTALL_REQ_TOOLCHAIN=	yes

post-patch:
	@${REINPLACE_CMD} -e 's,/etc/,${PREFIX}&,' ${WRKSRC}/parse_cmdline.c
	@${REINPLACE_CMD} -e '/BYTE_ORDER/s,__,_,g' \
		${WRKSRC}/librhash/byte_order.h

do-test:
	cd ${WRKSRC}/tests && ${SH} test_rhash.sh --full

[FILE:606:descriptions/desc.single]
RHash is a console utility and library for computing and verifying hash sums
of files.  It supports CRC32, MD4, MD5, SHA1, SHA256, SHA512, SHA3, Tiger,
TTH, Torrent BTIH, AICH, ED2K, GOST R 34.11-94, RIPEMD-160, HAS-160, EDON-R
256/512, Whirlpool, and Snefru-128/256 hash sums.  Its features are:

  * Can calculate Magnet links
  * Output in a predefined (SFV, BSD-like) or a user-defined format
  * Ability to process directories recursively
  * Updating existing hash-files (adding hash sums of files missing in a
    hash-file)
  * Portable, written in pure C, small in size, open source (MIT license)


[FILE:101:distinfo]
406662c4703bd4cb1caae26f32700951a5e12adf39f141d3f40e0b461b1e9e49       249357 rhash-1.3.4-src.tar.gz


[FILE:379:manifests/plist.single]
@sample etc/rhashrc.sample
bin/
 ed2k-link
 gost-hash
 has160-hash
 magnet-link
 rhash
 sfv-hash
 tiger-hash
 tth-hash
 whirlpool-hash
include/
 rhash.h
 rhash_torrent.h
lib/
 librhash.a
 librhash.so
 librhash.so.0
share/man/man1/
 ed2k-link.1.gz
 gost-hash.1.gz
 has160-hash.1.gz
 magnet-link.1.gz
 rhash.1.gz
 sfv-hash.1.gz
 tiger-hash.1.gz
 tth-hash.1.gz
 whirlpool-hash.1.gz


[FILE:1733:patches/patch-Makefile]
--- Makefile.orig	2016-11-05 23:22:07 UTC
+++ Makefile
@@ -6,10 +6,10 @@ VERSION = 1.3.4
 PREFIX  ?= /usr/local
 CC      ?= gcc
 # using OPTFLAGS/OPTLDFLAGS for compatibilty with old scripts using this makefile
-OPTFLAGS = -O2 -DNDEBUG -fomit-frame-pointer -ffunction-sections -fdata-sections
+OPTFLAGS = -DNDEBUG -fomit-frame-pointer -ffunction-sections -fdata-sections
 OPTLDFLAGS =
-CFLAGS = $(OPTFLAGS)
-LDFLAGS = $(OPTLDFLAGS)
+CFLAGS += $(OPTFLAGS)
+LDFLAGS += $(OPTLDFLAGS)
 ADDCFLAGS =
 ADDLDFLAGS =
 ALLCFLAGS = -pipe $(CFLAGS) $(ADDCFLAGS) \
@@ -71,7 +71,7 @@ lib-shared: $(SHAREDLIB)
 lib-static: $(LIBRHASH)
 
 install: all install-binary install-data install-symlinks
-install-shared: $(SHARED_TRG) install-shared-binary install-data install-symlinks
+install-shared: $(SHARED_TRG) install-shared-binary install-lib-static install-lib-shared install-data install-symlinks
 install-data: install-man install-conf
 uninstall: uninstall-binary uninstall-data uninstall-symlinks
 
@@ -105,8 +105,8 @@ install-man:
 	$(INSTALL_DATA) dist/rhash.1 $(DESTDIR)$(MANDIR)/man1/rhash.1
 
 install-conf:
-	$(INSTALL) -d $(DESTDIR)/etc
-	tr -d \\r < dist/rhashrc.sample > rc.tmp && $(INSTALL_DATA) rc.tmp $(DESTDIR)/etc/rhashrc
+	$(INSTALL) -d $(DESTDIR)$(PREFIX)/etc
+	tr -d \\r < dist/rhashrc.sample > rc.tmp && $(INSTALL_DATA) rc.tmp $(DESTDIR)$(PREFIX)/etc/rhashrc.sample
 	rm -f rc.tmp
 
 # dependencies should be properly set, otherwise 'make -j<n>' can fail
@@ -127,7 +127,7 @@ install-lib-static: $(LIBRHASH)
 	+make -C librhash install-lib-static
 
 install-lib-shared: $(SHAREDLIB)
-	+make -C librhash install-lib-shared
+	+make -C librhash install-lib-shared install-so-link
 
 $(SHAREDLIB):
 	+make -C librhash lib-shared


[FILE:1000:patches/patch-librhash_Makefile]
--- librhash/Makefile.orig	2016-11-06 15:49:40 UTC
+++ librhash/Makefile
@@ -2,9 +2,9 @@
 CC      ?= gcc
 AR      ?= ar
 #NOTE: NDEBUG turns off asserts
-OPTFLAGS   = -O2 -DNDEBUG -fomit-frame-pointer -ffunction-sections -fdata-sections
+OPTFLAGS   = -DNDEBUG -fomit-frame-pointer -ffunction-sections -fdata-sections
 OPTLDFLAGS =
-CFLAGS     = $(OPTFLAGS)
+CFLAGS     += $(OPTFLAGS)
 LDFLAGS    = $(OPTLDFLAGS)
 ADDCFLAGS  =
 LIBCFLAGS  =
@@ -187,7 +187,7 @@ test-dll: $(DLLNAME) test_hashes.o
 
 # shared and static libraries
 $(SONAME): $(SOURCES)
-	sed -n '1s/.*/{ global:/p; s/^RHASH_API.* \([a-z0-9_]\+\)(.*/  \1;/p; $$s/.*/local: *; };/p' $(SO_HEADERS) > exports.sym
+	sed -nE '1s/.*/{ global:/p; s/^RHASH_API.* ([a-z0-9_]+)\(.*/  \1;/p; $$s/.*/local: *; };/p' $(SO_HEADERS) > exports.sym
 	$(CC) -fpic $(ALLCFLAGS) -shared $(SOURCES) -Wl,--version-script,exports.sym,-soname,$(SONAME) $(LIBLDFLAGS) -o $@
 	ln -s $(SONAME) $(SOLINK)
 # use 'nm -Cg --defined-only $@' to view exported symbols

