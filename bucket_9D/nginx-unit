# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		nginx-unit
VERSION=		1.34.2
KEYWORDS=		www
VARIANTS=		std
SDESC[std]=		Dynamic web application server
HOMEPAGE=		https://unit.nginx.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://unit.nginx.org/download/
DISTFILE[1]=		unit-1.34.2.tar.gz:main
DF_INDEX=		1
SPKGS[std]=		set
			unitd
			unitpython
			unitperl
			man
			php82
			php83
			php84

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		php82:primary:std
			php84:primary:std
			php83:primary:std
			php82:dev:std
			php84:dev:std
			php83:dev:std
EXRUN[php82]=		php82:primary:std
EXRUN[php83]=		php83:primary:std
EXRUN[php84]=		php84:primary:std
EXRUN[unitpython]=	python
EXRUN[unitperl]=	perl

USES=			cpe pcre2 gettext perl:build python:build

DISTNAME=		unit-1.34.2

LICENSE=		APACHE20:unitd
LICENSE_TERMS=		unitd:{{WRKSRC}}/NOTICE
LICENSE_FILE=		APACHE20:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

CPE_PRODUCT=		unit
CPE_VENDOR=		nginx
FPC_EQUIVALENT=		www/unit

MUST_CONFIGURE=		yes
CONFIGURE_ARGS=		--prefix={{PREFIX}}
			--modulesdir={{PREFIX}}/libexec/unit/modules
			--statedir={{PREFIX}}/libexec/unit
			--localstatedir=/var
			--runstatedir=/var/run/nginx-unit
			--logdir=/var/log/nginx-unit
			--control=unix:/var/run/nginx-unit/control.unit.sock
			--ld-opt="-L{{LOCALBASE}}/lib -Wl,-rpath,{{LOCALBASE}}/lib"

SINGLE_JOB=		yes

PLIST_SUB=		PY3VER={{PYTHON_VER}}
RC_SUBR=		unitd:unitd
SUB_LIST=		UNIT_PIDFILE=/var/log/nginx-unit/unit.log
			UNIT_SOCK=/var/run/nginx-unit/control.unit.sock

post-patch:
	# disable Werror
	${REINPLACE_CMD} -e '/Werror/d' ${WRKSRC}/auto/cc/test

post-install:
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/sbin/unitd
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/libexec/unit/modules/*.so

post-configure:
	(cd ${CONFIGURE_WRKSRC} \
	  && ./configure python --config=python${PYTHON_VER}-config \
	  && ./configure perl --module=perl${PERL_VER} \
	  && ./configure php --module=php82\
			--config=php-config82\
			--lib-path=${PREFIX}/lib/php82 \
	  && ./configure php --module=php83\
			--config=php-config83\
			--lib-path=${PREFIX}/lib/php83 \
	  && ./configure php --module=php84\
			--config=php-config84\
			--lib-path=${PREFIX}/lib/php84 \
	)

[FILE:337:descriptions/desc.unitd]
NGINX Unit is a dynamic web application server, designed to run
applications in multiple languages. Unit is lightweight, polyglot, and
dynamically configured via API. The design of the server allows
reconfiguration of specific application parameters as needed by the
engineering or operations.

This subpackage contains the Unit server.


[FILE:74:descriptions/desc.unitpython]
This subpackage contains NGINX Unit server module for the default python.


[FILE:72:descriptions/desc.unitperl]
This subpackage contains NGINX Unit server module for the default perl.


[FILE:67:descriptions/desc.php82]
This subpackage contains NGINX Unit server module for the PHP 8.2.


[FILE:67:descriptions/desc.php83]
This subpackage contains NGINX Unit server module for the PHP 8.3.


[FILE:67:descriptions/desc.php84]
This subpackage contains NGINX Unit server module for the PHP 8.4.


[FILE:97:distinfo]
49ffb49d7ead1b9e64602f07f8b615839c099a9324943dedad40d057ce109504      1054961 unit-1.34.2.tar.gz


[FILE:36:manifests/plist.unitd]
sbin/unitd
@dir /var/log/nginx-unit


[FILE:61:manifests/plist.unitpython]
libexec/unit/modules/python%%PY3VER%%.unit.%%SHARED_OBJECT%%


[FILE:61:manifests/plist.unitperl]
libexec/unit/modules/perl%%PERL_VER%%.unit.%%SHARED_OBJECT%%


[FILE:23:manifests/plist.man]
share/man/man8/unitd.8


[FILE:35:manifests/plist.php82]
libexec/unit/modules/php82.unit.so


[FILE:35:manifests/plist.php83]
libexec/unit/modules/php83.unit.so


[FILE:35:manifests/plist.php84]
libexec/unit/modules/php84.unit.so


[FILE:429:patches/patch-auto_sched]
--- auto/sched.orig	2025-01-10 16:45:42 UTC
+++ auto/sched
@@ -13,6 +13,9 @@ nxt_feature_test="#define _GNU_SOURCE
                   int main(void) {
                       cpu_set_t set;
 
+                  #if defined(__DragonFly__)
+                  #error not-really-supported
+                  #endif
                       sched_getaffinity(0, sizeof(set), &set);
                       return 0;
                   }"


[FILE:405:patches/patch-auto_sendfile]
--- auto/sendfile.orig	2025-01-10 16:45:42 UTC
+++ auto/sendfile
@@ -43,6 +43,10 @@ if [ $nxt_found = no ]; then
                       #include <sys/uio.h>
                       #include <stdlib.h>
 
+                      #ifdef __DragonFly__
+                      #define SF_NODISKIO 0
+                      #endif
+
                       int main(void) {
                           off_t  sent;
 


[FILE:467:patches/patch-auto_shmem]
$NetBSD: patch-auto_shmem,v 1.1 2021/12/13 23:10:22 gutteridge Exp $

Fix sandboxed builds on NetBSD, where /var/shm typically doesn't exist.

--- auto/shmem.orig	2025-01-10 16:45:42 UTC
+++ auto/shmem
@@ -9,7 +9,11 @@ NXT_SHM_PREFIX="/"
 
 nxt_feature="shm_open()"
 nxt_feature_name=NXT_HAVE_SHM_OPEN
+if [ $NXT_SYSTEM = NetBSD ]; then
+nxt_feature_run=no
+else
 nxt_feature_run=yes
+fi
 nxt_feature_incs=
 nxt_feature_libs=
 nxt_feature_test="#include <sys/mman.h>


[FILE:259:patches/patch-src_nxt__kqueue__engine.c]
--- src/nxt_kqueue_engine.c.orig	2025-02-27 22:02:21 UTC
+++ src/nxt_kqueue_engine.c
@@ -39,7 +39,7 @@
 #endif
 
 
-#if (NXT_NETBSD)
+#if (0)
 /* NetBSD defines the kevent.udata field as intptr_t. */
 
 #define nxt_kevent_set_udata(udata)  (intptr_t) (udata)


[FILE:877:files/unitd.in]
#!/bin/sh
#
# PROVIDE: unitd
# REQUIRE: LOGIN cleanvar
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable nginx:
# unitd_enable (bool):          Set to "NO" by default.
#                               Set it to "YES" to enable unit
# unitd_sockfile (str):         Set to "" by default.
#                               Set it to "127.0.0.1:8443" to enable the unit control
#                               socket on the network address

. /etc/rc.subr

name="unitd"
rcvar=unitd_enable

command="%%PREFIX%%/sbin/unitd"
start_precmd=start_precmd

start_precmd()
{
    rm -f %%UNIT_SOCK%%
}

load_rc_config $name

# Default value
: ${unitd_sockfile=""}

pidfile=${unit_pidfile:-"%%UNIT_PIDFILE%%"}
unitd_enable=${unitd_enable:-"NO"}
sockfile=${unitd_sockfile}

if [ x${sockfile} != "x" ]
then
    command_args="--control ${sockfile}"
fi

run_rc_command "$1"

