# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		nginx-unit
VERSION=		1.28.0
KEYWORDS=		www
VARIANTS=		standard
SDESC[standard]=	Dynamic web application server
HOMEPAGE=		https://unit.nginx.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://unit.nginx.org/download/
DISTFILE[1]=		unit-1.28.0.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			unitd
			python
			perl
			php80
			php81
			php82

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		php82:single:standard
			php81:single:standard
			php80:single:standard
EXRUN[php80]=		php80:single:standard
EXRUN[php81]=		php81:single:standard
EXRUN[php82]=		php82:single:standard
EXRUN[python]=		python
EXRUN[perl]=		perl

USES=			cpe perl:build python:build

DISTNAME=		unit-1.28.0

LICENSE=		APACHE20:unitd
LICENSE_TERMS=		unitd:{{WRKSRC}}/NOTICE
LICENSE_FILE=		APACHE20:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

CPE_PRODUCT=		unit
CPE_VENDOR=		nginx
FPC_EQUIVALENT=		www/unit

MUST_CONFIGURE=		yes
CONFIGURE_ARGS=		--prefix={{PREFIX}}
			--modules=libexec/unit/modules
			--state=libexec/unit
			--log=/var/log/nginx-unit/unit.log
			--pid=/var/run/nginx-unit/unit.pid
			--control=unix:/var/run/nginx-unit/control.unit.sock
			--ld-opt="-L{{LOCALBASE}}/lib -Wl,-rpath,{{LOCALBASE}}/lib"

SINGLE_JOB=		yes

PLIST_SUB=		PY3VER={{PYTHON_VER}}
RC_SUBR=		unitd:unitd
SUB_LIST=		UNIT_PIDFILE=/var/log/nginx-unit/unit.log
			UNIT_SOCK=/var/run/nginx-unit/control.unit.sock

post-patch:
	# disable Werror
	${REINPLACE_CMD} -e '/Werror/d' ${WRKSRC}/auto/cc/test

post-install:
	${MKDIR} ${STAGEDIR}/var/log/nginx-unit
	${MKDIR} ${STAGEDIR}/var/run/nginx-unit
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/sbin/unitd
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/libexec/unit/modules/*.so

post-configure:
	(cd ${CONFIGURE_WRKSRC} \
	  && ./configure python --config=python${PYTHON_VER}-config \
	  && ./configure perl --module=perl${PERL_VER} \
	  && ./configure php --module=php82\
			--config=php-config82\
			--lib-path=${PREFIX}/lib/php82 \
	  && ./configure php --module=php80\
			--config=php-config80\
			--lib-path=${PREFIX}/lib/php80 \
	  && ./configure php --module=php81\
			--config=php-config81\
			--lib-path=${PREFIX}/lib/php81 \
	)

[FILE:337:descriptions/desc.unitd]
NGINX Unit is a dynamic web application server, designed to run
applications in multiple languages. Unit is lightweight, polyglot, and
dynamically configured via API. The design of the server allows
reconfiguration of specific application parameters as needed by the
engineering or operations.

This subpackage contains the Unit server.


[FILE:74:descriptions/desc.python]
This subpackage contains NGINX Unit server module for the default python.


[FILE:72:descriptions/desc.perl]
This subpackage contains NGINX Unit server module for the default perl.


[FILE:67:descriptions/desc.php80]
This subpackage contains NGINX Unit server module for the PHP 8.0.


[FILE:67:descriptions/desc.php81]
This subpackage contains NGINX Unit server module for the PHP 8.1.


[FILE:67:descriptions/desc.php82]
This subpackage contains NGINX Unit server module for the PHP 8.2.


[FILE:97:distinfo]
69779208ed2d1687b5d26f8c4e0f8460444eb285fb6ced2443652e0c584a80b0       878878 unit-1.28.0.tar.gz


[FILE:87:manifests/plist.unitd]
sbin/unitd
share/man/man8/unitd.8.gz
@dir /var/log/nginx-unit
@dir /var/run/nginx-unit


[FILE:61:manifests/plist.python]
libexec/unit/modules/python%%PY3VER%%.unit.%%SHARED_OBJECT%%


[FILE:61:manifests/plist.perl]
libexec/unit/modules/perl%%PERL_VER%%.unit.%%SHARED_OBJECT%%


[FILE:50:manifests/plist.php80]
libexec/unit/modules/php80.unit.%%SHARED_OBJECT%%


[FILE:50:manifests/plist.php81]
libexec/unit/modules/php81.unit.%%SHARED_OBJECT%%


[FILE:50:manifests/plist.php82]
libexec/unit/modules/php82.unit.%%SHARED_OBJECT%%


[FILE:401:patches/patch-auto_sendfile]
--- auto/sendfile.orig	2022-06-02 12:31:55 UTC
+++ auto/sendfile
@@ -43,6 +43,10 @@ if [ $nxt_found = no ]; then
                       #include <sys/uio.h>
                       #include <stdlib.h>
 
+                      #ifdef __DragonFly__
+                      #define SF_NODISKIO 0
+                      #endif
+
                       int main() {
                           off_t  sent;
 


[FILE:1436:patches/patch-fix-php82]
From 48b6a7b311272896be9212e170fcee8d1da25e79 Mon Sep 17 00:00:00 2001
From: Remi Collet <remi@remirepo.net>
Date: Thu, 2 Jun 2022 16:16:35 +0200
Subject: [PATCH] PHP: Fixed php_module_startup() call for PHP 8.2.

PHP 8.2 changed the prototype of the function, removing the last
parameter.

Signed-off-by: Remi Collet <remi@remirepo.net>
Cc: Timo Stark <t.stark@nginx.com>
Cc: George Peter Banyard <girgias@php.net>
Tested-by: Andy Postnikov <apostnikov@gmail.com>
Acked-by: Andy Postnikov <apostnikov@gmail.com>
Reviewed-by: Andrew Clayton <a.clayton@nginx.com>
Signed-off-by: Alejandro Colomar <alx@nginx.com>
---
 auto/modules/php   | 4 ++++
 docs/changes.xml   | 6 ++++++
 src/nxt_php_sapi.c | 4 ++++
 3 files changed, 14 insertions(+)

--- auto/modules/php.orig
+++ auto/modules/php
@@ -149,7 +149,11 @@ nxt_feature_test="
     #include <php_main.h>
 
     int main() {
+    #if (PHP_VERSION_ID < 80200)
         php_module_startup(NULL, NULL, 0);
+    #else
+        php_module_startup(NULL, NULL);
+    #endif
         return 0;
     }"
 
--- src/nxt_php_sapi.c.orig
+++ src/nxt_php_sapi.c
@@ -1150,7 +1150,11 @@ nxt_php_vcwd_chdir(nxt_unit_request_info_t *req, u_char *dir)
 static int
 nxt_php_startup(sapi_module_struct *sapi_module)
 {
+#if (PHP_VERSION_ID < 80200)
     return php_module_startup(sapi_module, &nxt_php_unit_module, 1);
+#else
+    return php_module_startup(sapi_module, &nxt_php_unit_module);
+#endif
 }
 
 


[FILE:877:files/unitd.in]
#!/bin/sh
#
# PROVIDE: unitd
# REQUIRE: LOGIN cleanvar
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable nginx:
# unitd_enable (bool):          Set to "NO" by default.
#                               Set it to "YES" to enable unit
# unitd_sockfile (str):         Set to "" by default.
#                               Set it to "127.0.0.1:8443" to enable the unit control
#                               socket on the network address

. /etc/rc.subr

name="unitd"
rcvar=unitd_enable

command="%%PREFIX%%/sbin/unitd"
start_precmd=start_precmd

start_precmd()
{
    rm -f %%UNIT_SOCK%%
}

load_rc_config $name

# Default value
: ${unitd_sockfile=""}

pidfile=${unit_pidfile:-"%%UNIT_PIDFILE%%"}
unitd_enable=${unitd_enable:-"NO"}
sockfile=${unitd_sockfile}

if [ x${sockfile} != "x" ]
then
    command_args="--control ${sockfile}"
fi

run_rc_command "$1"

