# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		mbedtls
VERSION=		4.0.0
REVISION=		1
KEYWORDS=		security devel
VARIANTS=		std
SDESC[std]=		Light-weight cryptographic and SSL/TLS library
HOMEPAGE=		https://www.trustedfirmware.org/projects/mbed-tls/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://github.com/Mbed-TLS/mbedtls/releases/download/mbedtls-4.0.0/
DISTFILE[1]=		mbedtls-4.0.0.tar.bz2:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			tools
			dev

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		python-Jinja2:single:python_used
EXRUN[tools]=		mbedtls:primary:std

USES=			cpe cmake perl:build python:build

LICENSE=		APACHE20:primary GPLv2+:primary
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_FILE=		APACHE20:stock
			GPLv2+:stock
LICENSE_AWK=		TERMS:"^The full text of each"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		dual

CPE_PRODUCT=		mbed_tls
CPE_VENDOR=		arm
FPC_EQUIVALENT=		security/mbedtls3

SOVERSION=		4.0.0
PLIST_SUB=		SO_TLS=22
			SO_509=8
			SO_CRYPTO=17
			SO_TFPSA=1.0.0
			SO_TFPSAMAJ=1

CMAKE_ARGS=		-DENABLE_TESTING:BOOL=OFF
			-DUSE_SHARED_MBEDTLS_LIBRARY:BOOL=ON
VAR_OPSYS[sunos]=	LDFLAGS=-lsocket

post-install:
	# correct obvious bug in CMakeList.txt wrt DESTDIR
	${MV} ${PREFIX}/lib/libmbedcrypto.so ${STAGEDIR}${PREFIX}/lib/
	${MV} ${PREFIX}/lib/libmbedcrypto.so.17 ${STAGEDIR}${PREFIX}/lib/
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/lib/lib*.so
	${FIND} ${STAGEDIR}${PREFIX}/bin -type f | while read f; \
	do \
	  check=$$(file "$$f" | grep "dynamically linked"); \
	  if [ -n "$$check" ]; then \
	    ${STRIP_CMD} "$$f"; \
	  fi; \
	done

[FILE:273:descriptions/desc.primary]
Mbed TLS is a C library that implements cryptographic primitives, X.509
certificate manipulation and the SSL/TLS and DTLS protocols. Its small
code footprint makes it suitable for embedded systems.

Mbed TLS includes a reference implementation of the PSA Cryptography API.


[FILE:58:descriptions/desc.tools]
This packages contains tools powered by Mbed TLS library.


[FILE:100:distinfo]
2f3a47f7b3a541ddef450e4867eeecb7ce2ef7776093f3a11d6d43ead6bf2827      6342607 mbedtls-4.0.0.tar.bz2


[FILE:248:manifests/plist.primary]
lib/
 libmbedcrypto.so.%%SOVERSION%%
 libmbedcrypto.so.%%SO_CRYPTO%%
 libmbedtls.so.%%SOVERSION%%
 libmbedtls.so.%%SO_TLS%%
 libmbedx509.so.%%SOVERSION%%
 libmbedx509.so.%%SO_509%%
 libtfpsacrypto.so.%%SO_TFPSA%%
 libtfpsacrypto.so.%%SO_TFPSAMAJ%%


[FILE:445:manifests/plist.tools]
bin/
 aead_demo
 cert_app
 cert_req
 cert_write
 crl_app
 crypto_examples
 dtls_client
 dtls_server
 hmac_demo
 key_ladder_demo
 key_ladder_demo.sh
 load_roots
 metatest
 mini_client
 pem2der
 psa_constant_names
 psa_hash
 query_compile_time_config
 query_included_headers
 req_app
 selftest
 ssl_client1
 ssl_client2
 ssl_context_info
 ssl_fork_server
 ssl_mail_client
 ssl_pthread_server
 ssl_server
 ssl_server2
 strerror
 udp_proxy
 zeroize


[FILE:2523:manifests/plist.dev]
include/mbedtls/
 asn1.h
 asn1write.h
 base64.h
 build_info.h
 compat-3-crypto.h
 config_adjust_legacy_crypto.h
 constant_time.h
 debug.h
 error.h
 lms.h
 mbedtls_config.h
 md.h
 memory_buffer_alloc.h
 net_sockets.h
 nist_kw.h
 oid.h
 pem.h
 pk.h
 pkcs7.h
 platform.h
 platform_time.h
 platform_util.h
 private_access.h
 psa_util.h
 ssl.h
 ssl_cache.h
 ssl_ciphersuites.h
 ssl_cookie.h
 ssl_ticket.h
 threading.h
 timing.h
 version.h
 x509.h
 x509_crl.h
 x509_crt.h
 x509_csr.h
include/mbedtls/private/
 aes.h
 aria.h
 bignum.h
 block_cipher.h
 camellia.h
 ccm.h
 chacha20.h
 chachapoly.h
 cipher.h
 cmac.h
 config_adjust_legacy_from_psa.h
 config_adjust_ssl.h
 config_adjust_test_accelerators.h
 config_adjust_x509.h
 config_psa.h
 ctr_drbg.h
 ecdh.h
 ecdsa.h
 ecjpake.h
 ecp.h
 entropy.h
 error_common.h
 gcm.h
 hmac_drbg.h
 md5.h
 pkcs5.h
 poly1305.h
 ripemd160.h
 rsa.h
 sha1.h
 sha256.h
 sha3.h
 sha512.h
include/psa/
 crypto.h
 crypto_adjust_auto_enabled.h
 crypto_adjust_config_dependencies.h
 crypto_adjust_config_derived.h
 crypto_adjust_config_key_pair_types.h
 crypto_adjust_config_synonyms.h
 crypto_builtin_composites.h
 crypto_builtin_key_derivation.h
 crypto_builtin_primitives.h
 crypto_compat.h
 crypto_config.h
 crypto_driver_common.h
 crypto_driver_contexts_composites.h
 crypto_driver_contexts_key_derivation.h
 crypto_driver_contexts_primitives.h
 crypto_driver_random.h
 crypto_extra.h
 crypto_platform.h
 crypto_sizes.h
 crypto_struct.h
 crypto_types.h
 crypto_values.h
include/tf-psa-crypto/
 build_info.h
 version.h
include/tf-psa-crypto/private/everest/everest/
 Hacl_Curve25519.h
 everest.h
 kremlib.h
 x25519.h
include/tf-psa-crypto/private/everest/everest/kremlib/
 FStar_UInt128.h
 FStar_UInt64_FStar_UInt32_FStar_UInt16_FStar_UInt8.h
include/tf-psa-crypto/private/everest/everest/kremlin/c_endianness.h
include/tf-psa-crypto/private/everest/everest/kremlin/internal/
 builtin.h
 callconv.h
 compat.h
 debug.h
 target.h
 types.h
 wasmsupport.h
include/tf-psa-crypto/private/everest/everest/vs2013/Hacl_Curve25519.h
lib/
 libmbedcrypto.a
 libmbedcrypto.so
 libmbedtls.a
 libmbedtls.so
 libmbedx509.a
 libmbedx509.so
 libtfpsacrypto.a
 libtfpsacrypto.so
lib/cmake/MbedTLS/
 MbedTLSConfig.cmake
 MbedTLSConfigVersion.cmake
 MbedTLSTargets-release.cmake
 MbedTLSTargets.cmake
lib/cmake/TF-PSA-Crypto/
 TF-PSA-CryptoConfig.cmake
 TF-PSA-CryptoConfigVersion.cmake
 TF-PSA-CryptoTargets-release.cmake
 TF-PSA-CryptoTargets.cmake
lib/pkgconfig/
 mbedcrypto.pc
 mbedtls.pc
 mbedx509.pc
 tfpsacrypto.pc


[FILE:1675:patches/patch-0001]
From 0ff335d715540a164c906a58f850f00c79627b51 Mon Sep 17 00:00:00 2001
From: Ben Taylor <ben.taylor@linaro.org>
Date: Mon, 13 Oct 2025 15:17:44 +0100
Subject: [PATCH] Remove uses of mbedtls_pk_verify_new

Signed-off-by: Ben Taylor <ben.taylor@linaro.org>
---
 library/ssl_tls12_client.c  | 2 +-
 library/ssl_tls13_generic.c | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

--- library/ssl_tls12_client.c.orig
+++ library/ssl_tls12_client.c
@@ -1995,7 +1995,7 @@ static int ssl_parse_server_key_exchange(mbedtls_ssl_context *ssl)
 
 #if defined(MBEDTLS_X509_RSASSA_PSS_SUPPORT)
         if (pk_alg == MBEDTLS_PK_RSASSA_PSS) {
-            ret = mbedtls_pk_verify_new(pk_alg, peer_pk,
+            ret = mbedtls_pk_verify_ext((mbedtls_pk_sigalg_t) pk_alg, peer_pk,
                                         md_alg, hash, hashlen,
                                         p, sig_len);
         } else
--- library/ssl_tls13_generic.c.orig
+++ library/ssl_tls13_generic.c
@@ -300,13 +300,13 @@ static int ssl_tls13_parse_certificate_verify(mbedtls_ssl_context *ssl,
 
     MBEDTLS_SSL_DEBUG_BUF(3, "verify hash", verify_hash, verify_hash_len);
 
-    if ((ret = mbedtls_pk_verify_new(sig_alg,
+    if ((ret = mbedtls_pk_verify_ext((mbedtls_pk_sigalg_t) sig_alg,
                                      &ssl->session_negotiate->peer_cert->pk,
                                      md_alg, verify_hash, verify_hash_len,
                                      p, signature_len)) == 0) {
         return 0;
     }
-    MBEDTLS_SSL_DEBUG_RET(1, "mbedtls_pk_verify_new", ret);
+    MBEDTLS_SSL_DEBUG_RET(1, "mbedtls_pk_verify_ext", ret);
 
 error:
     /* RFC 8446 section 4.4.3


[FILE:1039:patches/patch-library_CMakeLists.txt]
--- library/CMakeLists.txt.orig	2025-10-14 16:14:11 UTC
+++ library/CMakeLists.txt
@@ -195,12 +195,14 @@ if(USE_STATIC_MBEDTLS_LIBRARY)
     set_base_compile_options(${mbedx509_static_target})
     target_compile_options(${mbedx509_static_target} PRIVATE ${LIBS_C_FLAGS})
     set_target_properties(${mbedx509_static_target} PROPERTIES OUTPUT_NAME mbedx509)
+    set_target_properties(${mbedx509_static_target} PROPERTIES POSITION_INDEPENDENT_CODE ON)
     target_link_libraries(${mbedx509_static_target} PUBLIC ${libs} ${tfpsacrypto_static_target})
 
     add_library(${mbedtls_static_target} STATIC ${src_tls})
     set_base_compile_options(${mbedtls_static_target})
     target_compile_options(${mbedtls_static_target} PRIVATE ${LIBS_C_FLAGS})
     set_target_properties(${mbedtls_static_target} PROPERTIES OUTPUT_NAME mbedtls)
+    set_target_properties(${mbedtls_static_target} PROPERTIES POSITION_INDEPENDENT_CODE ON)
     target_link_libraries(${mbedtls_static_target} PUBLIC ${libs} ${mbedx509_static_target})
 
     if(GEN_FILES)


[FILE:600:patches/patch-tf-psa-crypto_core_CMakeLists.txt]
--- tf-psa-crypto/core/CMakeLists.txt.orig	2025-10-01 15:29:27 UTC
+++ tf-psa-crypto/core/CMakeLists.txt
@@ -140,6 +140,7 @@ if(USE_STATIC_TF_PSA_CRYPTO_LIBRARY)
     tf_psa_crypto_set_base_compile_options(${tfpsacrypto_static_target})
     target_compile_options(${tfpsacrypto_static_target} PRIVATE ${LIBS_C_FLAGS})
     set_target_properties(${tfpsacrypto_static_target} PROPERTIES OUTPUT_NAME tfpsacrypto)
+    set_target_properties(${tfpsacrypto_static_target} PROPERTIES POSITION_INDEPENDENT_CODE ON)
     target_link_libraries(${tfpsacrypto_static_target} PUBLIC ${libs})
 
     if(GEN_FILES)


[FILE:453:patches/patch-tf-psa-crypto_drivers_builtin_CMakeLists.txt]
--- tf-psa-crypto/drivers/builtin/CMakeLists.txt.orig	2025-10-01 15:29:27 UTC
+++ tf-psa-crypto/drivers/builtin/CMakeLists.txt
@@ -55,6 +55,7 @@ endforeach(target)
 
 if(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)
     set_property(TARGET ${builtin_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
+    set_property(TARGET ${builtin_static_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
 endif(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)
 
 if(INSTALL_TF_PSA_CRYPTO_HEADERS)


[FILE:478:patches/patch-tf-psa-crypto_drivers_builtin_src_platform__util.c]
--- tf-psa-crypto/drivers/builtin/src/platform_util.c.orig	2025-10-01 15:21:30 UTC
+++ tf-psa-crypto/drivers/builtin/src/platform_util.c
@@ -369,7 +369,7 @@ static int getrandom_wrapper(void *buf,
  *
  * Documentation: https://netbsd.gw.com/cgi-bin/man-cgi?sysctl+7
  */
-#if (defined(__FreeBSD__) || defined(__NetBSD__)) && !defined(HAVE_GETRANDOM)
+#if defined(__FreeBSD__) && !defined(HAVE_GETRANDOM)
 #include <sys/param.h>
 #include <sys/sysctl.h>
 #if defined(KERN_ARND)


[FILE:453:patches/patch-tf-psa-crypto_drivers_everest_CMakeLists.txt]
--- tf-psa-crypto/drivers/everest/CMakeLists.txt.orig	2025-10-01 15:29:27 UTC
+++ tf-psa-crypto/drivers/everest/CMakeLists.txt
@@ -27,6 +27,7 @@ endforeach(target)
 
 if(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)
     set_property(TARGET ${everest_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
+    set_property(TARGET ${everest_static_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
 endif(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)
 
 if(INSTALL_TF_PSA_CRYPTO_HEADERS)


[FILE:410:patches/patch-tf-psa-crypto_drivers_p256-m_CMakeLists.txt]
--- tf-psa-crypto/drivers/p256-m/CMakeLists.txt.orig	2025-10-01 15:29:27 UTC
+++ tf-psa-crypto/drivers/p256-m/CMakeLists.txt
@@ -26,4 +26,5 @@ endforeach(target)
 
 if(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)
     set_property(TARGET ${p256m_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
+    set_property(TARGET ${p256m_static_target} PROPERTY POSITION_INDEPENDENT_CODE ON)
 endif(USE_SHARED_TF_PSA_CRYPTO_LIBRARY)

