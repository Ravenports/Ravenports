# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		mpv
VERSION=		0.38.0
KEYWORDS=		multimedia
VARIANTS=		std
SDESC[std]=		Advanced general-purpose multimedia player
HOMEPAGE=		https://mpv.io/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main waf
SITES[main]=		GITHUB/mpv-player:mpv:v0.38.0
SITES[waf]=		https://gitlab.com/ita1024/waf/-/archive/waf-2.0.24/
DISTFILE[1]=		generated:main
DISTFILE[2]=		waf-waf-2.0.24.tar.bz2:waf
DF_INDEX=		1 2
SPKGS[std]=		set
			primary
			dev
			tools
			docs
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		python-docutils:single:python_used
			libarchive:dev:std
			ffmpeg:dev:std
			libdvdnav:dev:std
			libplacebo:dev:std
			xorg-xpresent:dev:std
BUILDRUN_DEPENDS=	ffmpeg:primary:std
			libarchive:primary:std
			libass:primary:std
			libdvdnav:primary:std
			libvdpau:primary:std
			libva:primary:std
			libplacebo:primary:std
			uchardet:single:std
			xorg-xpresent:primary:std
RUN_DEPENDS=		youtube-dl:single:std
EXRUN[tools]=		primary

USES=			cpe iconv jpeg lua:5.2 pkgconfig meson perl:build
			python:build,sutools ssl:build desktop-utils:primary
			gnome-icons:primary
SDL_COMPONENTS=		sdl2
XORG_COMPONENTS=	xinerama xscrnsaver xv xxf86vm

LICENSE=		GPLv2+:primary
LICENSE_TERMS=		primary:{{WRKSRC}}/Copyright
LICENSE_FILE=		GPLv2+:{{WRKSRC}}/LICENSE.GPL
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		multimedia/mpv
MESON_ARGS=		-Dlua=lua-5.2
			-Dx11=enabled
			-Dlibmpv=true

SOVERSION=		2.3.0

post-patch:
	${FIND} ${WRKSRC}/DOCS/man -name '*.rst' | \
		${XARGS} ${REINPLACE_CMD} -e 's|/usr/local|${PREFIX}|g'

[FILE:364:descriptions/desc.primary]
Mpv is based on the MPlayer and mplayer2 projects which it greatly improves.
It supports a wide variety of video file formats, audio and video codecs, and
subtitle types. Special input URL types are available to read input from
a variety of sources other than disk files. Depending on platform, a variety of
different video and audio output methods are supported.


[FILE:55:descriptions/desc.tools]
This package contains the MPV player and related files


[FILE:208:distinfo]
86d9ef40b6058732f67b46d0bbda24a074fae860b3eaae05bab3145041303066      3419741 mpv-player-mpv-0.38.0.tar.gz
599ab1903b6f12f0683878d2cd4f73546e0ce26031efd05f3fbe5178e4ef8cda       582903 waf-waf-2.0.24.tar.bz2


[FILE:53:manifests/plist.primary]
lib/
 libmpv.so.%%SOVERSION%%
 libmpv.so.%%SOMAJOR%%


[FILE:94:manifests/plist.dev]
lib/pkgconfig/mpv.pc
lib/libmpv.so
include/mpv/
 client.h
 render.h
 render_gl.h
 stream_cb.h


[FILE:421:manifests/plist.tools]
bin/mpv
etc/mpv/encoding-profiles.conf
share/applications/mpv.desktop
share/bash-completion/completions/mpv
share/icons/hicolor/128x128/apps/mpv.png
share/icons/hicolor/16x16/apps/mpv.png
share/icons/hicolor/32x32/apps/mpv.png
share/icons/hicolor/64x64/apps/mpv.png
share/icons/hicolor/scalable/apps/mpv.svg
share/icons/hicolor/symbolic/apps/mpv-symbolic.svg
share/metainfo/mpv.metainfo.xml
share/zsh/site-functions/_mpv


[FILE:84:manifests/plist.docs]
share/doc/mpv/
 mpv.conf
 input.conf
 mplayer-input.conf
 restore-old-bindings.conf


[FILE:24:manifests/plist.man]
share/man/man1/mpv.1.gz


[FILE:2524:patches/patch-meson.build]

- Instruct about NetBSD pthread_setname_np(3).
  Maybe pthread_setname_np(3) should be checked in order to distinguish
  based on the argument supported instead of special-casing based on the
  platform... workaround that for the moment in the simplest way.
- Enable support for DRM on NetBSD.
- Install configuration files to examples, per pkgsrc conventions.

--- meson.build.orig	2024-04-17 19:18:44 UTC
+++ meson.build
@@ -303,6 +303,7 @@ if cc.get_id() == 'clang'
 endif
 
 darwin = host_machine.system() == 'darwin'
+netbsd = host_machine.system() == 'netbsd'
 win32 = host_machine.system() == 'cygwin' or host_machine.system() == 'windows'
 posix = not win32
 
@@ -527,17 +528,22 @@ features += {'vt.h': cc.has_header_symbo
 
 features += {'consio.h': not features['vt.h'] and cc.has_header_symbol('sys/consio.h', 'VT_GETMODE')}
 
+features += {'wsdisplay_usl_io.h': not features['vt.h'] and not features['consio.h'] and cc.has_header_symbol('dev/wscons/wsdisplay_usl_io.h', 'VT_GETMODE')}
+
 # macOS's pthread_setname_np is a special snowflake and differs from literally every other platform.
 features += {'mac-thread-name': darwin}
 
+# NetBSD pthread_setname_np differs from macOS and Linux
+features += {'netbsd-thread-name': netbsd}
+
 features += {'glibc-thread-name': false}
-if not features['mac-thread-name']
+if not features['mac-thread-name'] and not features['netbsd-thread-name']
     features += {'glibc-thread-name': posix and cc.has_function('pthread_setname_np', args: '-D_GNU_SOURCE',
                                                                 dependencies: pthreads, prefix: '#include <pthread.h>')}
 endif
 
 features += {'bsd-thread-name': false}
-if not features['mac-thread-name'] and not features['glibc-thread-name']
+if not features['mac-thread-name'] and not features['glibc-thread-name'] and not features['netbsd-thread-name']
     features += {'bsd-thread-name': posix and cc.has_function('pthread_set_name_np', dependencies: pthreads,
                                                               prefix: '#include <pthread.h>\n#include <pthread_np.h>')}
 endif
@@ -922,7 +928,7 @@ if features['direct3d']
 endif
 
 drm = dependency('libdrm', version: '>= 2.4.105', required: get_option('drm'))
-features += {'drm': drm.found() and (features['vt.h'] or features['consio.h'])}
+features += {'drm': drm.found() and (features['vt.h'] or features['consio.h'] or features['wsdisplay_usl_io.h'])}
 if features['drm']
     dependencies += drm
     sources += files('video/drmprime.c',


[FILE:458:patches/patch-osdep_threads-posix.h]
$NetBSD: patch-osdep_threads-posix.h,v 1.1 2024/01/01 15:50:14 leot Exp $

Add support for NetBSD.

--- osdep/threads-posix.h.orig	2023-12-31 11:13:03.078250654 +0000
+++ osdep/threads-posix.h
@@ -232,6 +232,8 @@ static inline void mp_thread_set_name(co
     pthread_set_name_np(pthread_self(), name);
 #elif HAVE_OSX_THREAD_NAME
     pthread_setname_np(name);
+#elif HAVE_NETBSD_THREAD_NAME
+    pthread_setname_np(pthread_self(), "%s", name);
 #endif
 }
 


[FILE:573:patches/patch-stream_stream__libarchive.c]
$NetBSD: patch-stream_stream__libarchive.c,v 1.1 2022/05/17 13:12:13 ryoon Exp $

* NetBSD does not implement uselocale().

--- stream/stream_libarchive.c.orig	2023-11-21 18:47:46 UTC
+++ stream/stream_libarchive.c
@@ -29,6 +29,10 @@
 #define MP_ARCHIVE_FLAG_MAYBE_RAR       (MP_ARCHIVE_FLAG_PRIV << 1)
 #define MP_ARCHIVE_FLAG_MAYBE_VOLUMES   (MP_ARCHIVE_FLAG_PRIV << 2)
 
+#if defined(__NetBSD__)
+#define uselocale(locale) NULL
+#endif
+
 struct mp_archive_volume {
     struct mp_archive *mpa;
     int index; // volume number (starting with 0, mp_archive.primary_src)


[FILE:392:patches/patch-video_out_drm__common.c]
$NetBSD: patch-video_out_drm__common.c,v 1.4 2020/12/19 11:27:51 leot Exp $

Enable support for DRM on NetBSD.

--- video/out/drm_common.c.orig	2023-11-21 18:47:46 UTC
+++ video/out/drm_common.c
@@ -31,6 +31,9 @@
 
 #if HAVE_CONSIO_H
 #include <sys/consio.h>
+#elif HAVE_WSDISPLAY_USL_IO_H
+#include <sys/types.h>
+#include <dev/wscons/wsdisplay_usl_io.h>
 #else
 #include <sys/vt.h>
 #endif


[FILE:178:files/special.mk]
# Emulate USES=waf
MAKE_CMD=	${PYTHON_CMD} ${WRKDIR}/waf-*/waf-light
CONFIGURE_CMD=	${PYTHON_CMD} ${WRKDIR}/waf-*/waf-light configure
MAKEFILE=
MAKE_FLAGS=
MAKE_ARGS+=	--verbose

