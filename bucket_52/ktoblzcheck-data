# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		ktoblzcheck-data
VERSION=		1.0.0.20251208
KEYWORDS=		finance
VARIANTS=		std
SDESC[std]=		Bank data used by ktoblzcheck
HOMEPAGE=		https://ktoblzcheck.sourceforge.net
CONTACT=		nobody

DOWNLOAD_GROUPS=	main bankdata
SITES[main]=		SF/ktoblzcheck
SITES[bankdata]=	FREELOCAL/jhale/ktoblzcheck
DISTFILE[1]=		ktoblzcheck-data-20250515.tar.gz:main
DISTFILE[2]=		ktoblzcheck-bankdata-20251208.tar.gz:bankdata
DF_INDEX=		1 2
SPKGS[std]=		single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILDRUN_DEPENDS=	python-openpyxl:single:python_used

USES=			cmake python:build,sqlite

DISTNAME=		ktoblzcheck-data-20250515

FPC_EQUIVALENT=		finance/ktoblzcheck-data

PLIST_SUB=		BANKDATA_START_DATE=20251208

CMAKE_ARGS=		-DINSTALL_RAW_BANKDATA_FILE:BOOL=ON
			-DINSTALL_SEPA_BANKDATA_FILE:BOOL=ON
			-DENABLE_BANKDATA_DOWNLOAD:BOOL=OFF
			-DDATA_FILEPATH_sepa:PATH="../data/sepa_20251208.txt"

pre-configure:
	# See comment in patches/patch-src_CMakeLists.txt.
	${REINPLACE_CMD} -e 's|%%BANKDATA_END_DATE%%|07.09.2025|' \
		${WRKSRC}/src/CMakeLists.txt

post-extract:
	# Out of an abundance of caution, remove the pre-built DBs and shipped SEPA data.
	(cd ${WRKSRC}/data && ${RM} bankdata* sepa*)
	# Populate ${WRKSRC}/data with the contents of our bankdata archive.
.for f in blz_20251208.txt ch_data.txt nl_data.xlsx sepa_20251208.txt
	${CP} ${WRKDIR}/ktoblzcheck-bankdata-20251208/${f} ${WRKSRC}/data
.endfor

[FILE:218:descriptions/desc.single]
ktoblzcheck-data converts raw bank code data published by several
financial institutions including Deutsche Bundesbank, SIX Group, and
Betaalvereniging Nederland, into SQLite databases used by the ktoblzcheck
library.


[FILE:226:distinfo]
307479cd3c487ba6d6c4f5966634a6023c1f29d4386b93a5e96cea7541bebe4c       267821 ktoblzcheck-data-20250515.tar.gz
8cfbe82f18461aa182fcc7201a9337ae34c93dd652df874f9018adc7ef1463eb       425612 ktoblzcheck-bankdata-20251208.tar.gz


[FILE:148:manifests/plist.single]
share/ktoblzcheck/
 bankdata.ch.db
 bankdata.de.db
 bankdata.nl.db
 blz_%%BANKDATA_START_DATE%%.txt
 ibandata.txt
 sepa_%%BANKDATA_START_DATE%%.txt


[FILE:719:patches/patch-src_CMakeLists.txt]
Set VALID_END_DATE via the port Makefile. This would otherwise only be set
if the CMake argument ENABLE_BANKDATA_DOWNLOAD is true, but we cannot download
files during the build process. This value needs to be defined as the last day
the bank data is valid in %d.%m.%Y format to enable the custom commands/targets
that build that databases.

--- src/CMakeLists.txt.orig	2025-05-15 11:18:20 UTC
+++ src/CMakeLists.txt
@@ -40,7 +40,7 @@ message(STATUS "Using bank data db ${BAN
 message(STATUS "Using bank data db ${BANKDATA_CH_DBPATH}")
 message(STATUS "Using bank data db ${BANKDATA_TEST_DBPATH}")
 
-set(VALID_END_DATE "")
+set(VALID_END_DATE "%%BANKDATA_END_DATE%%")
 
 if(ENABLE_BANKDATA_DOWNLOAD)
     extract_date(


[FILE:4541:patches/patch-src_switzerland.py]
- Adapt to SIX Group converting their bankdata to CSV (semicolon separated).
- Don't use codecs.open(); deprecated in Python 3.14.

--- src/switzerland.py.orig	2025-05-15 11:18:20 UTC
+++ src/switzerland.py
@@ -24,12 +24,11 @@ KMyMoney
 @author: Christian David
 """
 
-import sqlite3
-import codecs
 import argparse
-import os
+import csv
+import sqlite3
 
-def createTable():
+def create_table():
     """ Create table structure
     """
     cursor = db.cursor()
@@ -45,59 +44,65 @@ def createTable():
     )
     db.commit()
 
-
-def processFile(fileName):
+def process_file(filename):
     """ Fills the database with institutions saved in fileName
     """
+    with open(filename, 'r', newline='') as institutes_file:
+        reader = list(csv.reader(institutes_file, delimiter=';'))
+        rows = reader[1:]
+
+    bank_map = {row[0]: {"bic": row[14], "name": f"{row[8]} ({row[12]})"} for row in rows}
+
+    to_insert = []
+    for row in rows:
+        bankcode = row[0].zfill(5)
+
+        # Non-concatenated "parent" entries
+        if row[2] == 'N':
+            bic = row[14]
+            name = f"{row[8]} ({row[12]})"
+        # Some bankcodes are concatenated onto other bankcodes without the BIC or other
+        # institution info on their line, so we must get these from the parent entry
+        else:
+            parent_bankcode = row[3]
+            parent_info = bank_map.get(parent_bankcode)
+            if parent_info:
+                bic = parent_info["bic"]
+                name = parent_info["name"]
+            else:
+                continue
+
+        to_insert.append((bankcode, bic, name))
 
-    rowsInserted = 0
     cursor = db.cursor()
     cursor.execute("BEGIN")
-
-    def existCode(bankCode, bic):
-        cursor.execute("SELECT bankcode,bic FROM institutions WHERE bankcode = ? and bic = ?",(bankCode,bic,))
-        row_exist = cursor.fetchone()
-        if row_exist is None:
-            return False
-
-        return True
-
-    def submitInstitute(bankCode, bankName, bic):
-        if(not existCode(bankCode, bic)):
-            try:
-                cursor.execute("INSERT INTO institutions (bankcode, bic, name) VALUES(?,?,?)", (bankCode, bic, bankName))
-            except sqlite3.Error as e:
-                print("Error: {0} while inserting {1} ({2})".format(e.args[0], bankCode, bic))
-
-    institutesFile = codecs.open(fileName, "r", encoding=args.encoding)
-    for institute in institutesFile:
-        bic = institute[284:295].strip()
-        if len(bic) > 0:
-            bcNumber = "{:0>5}".format(institute[2:7].strip() if institute[11:16] == "     " else institute[11:16].strip())
-            name = "%s (%s)" % (institute[54:114].strip(), institute[194:229].strip())
-            submitInstitute(bcNumber, name, bic)
-            rowsInserted += 1
-
-    db.commit()
-    return rowsInserted
-
+    try:
+        cursor.executemany(
+            "INSERT OR IGNORE INTO institutions (bankcode, bic, name) VALUES (?, ?, ?)",
+            to_insert
+        )
+        db.commit()
+        return cursor.rowcount
+    except sqlite3.Error as e:
+        db.rollback()
+        print(f"Database error: {e}")
+        return 0
 
 if __name__ == '__main__':
     parser = argparse.ArgumentParser(description="Creates a SQLite database for KMyMoney with information about IBAN and BICs based on a swiss BC-Bankenstamm file."
-        " You can get the BC-Bankenstamm file from https://www.six-group.com/interbank-clearing/de/home/bank-master-data/download-bc-bank-master.html"
+        " You can get the BC-Bankenstamm file from https://api.six-group.com/api/epcd/bankmaster/v2/public/downloads/bcbankenstamm"
     )
 
     parser.add_argument(dest='file', help='File to load')
     parser.add_argument('-o', '--output', default="bankdata.ch.db", help='SQLite database to open/generate')
-    parser.add_argument('-e', '--encoding', default="iso 8859-15", help='Charset of file')
     args = parser.parse_args()
 
-    print("Read data from \"{0}\" with \"{1}\" encoding".format(args.file, args.encoding))
+    print(f'Read data from "{args.file}"')
     db = sqlite3.connect(args.output)
 
-    createTable()
-    institutions = processFile(args.file)
-    print("Inserted {0} institutions into database \"{1}\"".format(institutions, args.output))
+    create_table()
+    institutions = process_file(args.file)
+    print(f'Inserted {institutions} institutions into database "{args.output}"')
 
     cursor = db.cursor()
     cursor.execute("ANALYZE institutions")

