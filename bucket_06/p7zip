# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		p7zip
VERSION=		17.05
KEYWORDS=		archivers
VARIANTS=		std
SDESC[std]=		File archiver with high compression ratio
HOMEPAGE=		https://p7zip.sourceforge.net/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/p7zip-project:p7zip:v17.05
DISTFILE[1]=		generated:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			man
			docs

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

USES=			cpe gmake c++:primary

LICENSE=		LGPL21+:primary CUSTOM1:primary
LICENSE_TERMS=		primary:{{WRKSRC}}/DOC/License.txt
LICENSE_NAME=		CUSTOM1:"unRAR Restriction"
LICENSE_FILE=		LGPL21+:{{WRKSRC}}/DOC/copying.txt
			CUSTOM1:{{WRKSRC}}/DOC/unRarLicense.txt
LICENSE_SCHEME=		multi

CPE_VENDOR=		7-zip

BUILD_TARGET=		all3
MAKEFILE=		makefile
MAKE_ARGS=		OPTFLAGS="{{CXXFLAGS}}"
SINGLE_JOB=		yes

post-patch:
	${REINPLACE_CMD} -e 's|{DEST_SHARE_DOC}|${STD_DOCDIR}|' \
		${WRKSRC}/man1/*
	${MV} ${WRKSRC}/README ${WRKSRC}/DOC/readme.unix

do-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/libexec/p7zip
.for BINARY in 7z 7za 7zr 7zCon.sfx
	${INSTALL_PROGRAM} ${WRKSRC}/bin/${BINARY} ${STAGEDIR}${PREFIX}/libexec/p7zip
.endfor
	${INSTALL_LIB} ${WRKSRC}/bin/7z.so ${STAGEDIR}${PREFIX}/libexec/p7zip
	${INSTALL_SCRIPT} ${FILESDIR}/7z ${STAGEDIR}${PREFIX}/bin
	${LN} -sf 7z ${STAGEDIR}${PREFIX}/bin/7za
	${LN} -sf 7z ${STAGEDIR}${PREFIX}/bin/7zr
	(cd ${WRKSRC}/man1 && \
		${INSTALL_MAN} 7z*.1 ${STAGEDIR}${MAN1PREFIX}/man/man1)
	(cd ${WRKSRC}/DOC && \
		${COPYTREE_SHARE} . ${STAGEDIR}${STD_DOCDIR})
.for LIC in Licence.txt copying.txt unRarLicense.txt
	${RM} ${STAGEDIR}${STD_DOCDIR}/${LIC}
.endfor

[FILE:727:descriptions/desc.primary]
p7zip is a Unix port of 7-Zip, a file archiver with high compression
ratio (www.7-zip.org) with lots of features:

* 7-Zip is free software distributed under the GNU LGPL
* High compression ratio in new 7z format with LZMA compression
  o Unicode file names
  o Variable dictionary size (up to 4 GB)
  o Compressing speed: about 1 MB/s on 2 GHz CPU
  o Decompressing speed: about 10-20 MB/s on 2 GHz CPU
* Supported formats:
  o Packing / unpacking: 7z, ZIP, GZIP, BZIP2 and TAR
  o Unpacking only: RAR, CAB, ISO, ARJ, LZH, CHM, Z, CPIO, RPM, DEB
    and NSIS
* For ZIP and GZIP formats 7-Zip provides compression ratio that is
  2-10 % better than ratio provided by PKZip and WinZip
* Self-extracting capability for 7z format


[FILE:111:distinfo]
d2788f892571058c08d27095c22154579dfefb807ebe357d145ab2ddddefb1a6      6722154 p7zip-project-p7zip-17.05.tar.gz


[FILE:66:manifests/plist.primary]
bin/
 7z
 7za
 7zr
libexec/p7zip/
 7z
 7z.so
 7zCon.sfx
 7za
 7zr


[FILE:36:manifests/plist.man]
share/man/man1/
 7z.1
 7za.1
 7zr.1


[FILE:554:patches/patch-CPP_7zip_Archive_Zip_ZipItem.cpp]
--- CPP/7zip/Archive/Zip/ZipItem.cpp.orig	2023-03-03 12:16:28 UTC
+++ CPP/7zip/Archive/Zip/ZipItem.cpp
@@ -425,7 +425,11 @@ void CItem::GetUnicodeString(UString &re
       size_t dlen = slen * 4;
       const char* dest = s_utf8.GetBuf_SetEnd(dlen + 1); // (source length * 4) + null termination
 
+#if defined(__sun)
+      size_t done = iconv(cd, (const char**)&src, &slen, (char**)&dest, &dlen);
+#else
       size_t done = iconv(cd, (char**)&src, &slen, (char**)&dest, &dlen);
+#endif
       bzero((size_t*)dest + done, 1);
 
       iconv_close(cd);


[FILE:386:patches/patch-CPP_Windows_System.cpp]
--- CPP/Windows/System.cpp.orig	2023-03-03 12:16:28 UTC
+++ CPP/Windows/System.cpp
@@ -44,7 +44,7 @@ namespace NWindows
 		#elif defined (__FreeBSD__) || defined (__FreeBSD_kernel__)
 		UInt32 GetNumberOfProcessors() {
 		  	int nbcpu = 1;
-			size_t value;
+			int value;
 			size_t len = sizeof(value);
 			if (sysctlbyname("hw.ncpu", &value, &len, NULL, 0) == 0)
 				nbcpu = value;


[FILE:277:patches/patch-C_hashes_hash.h]
--- C/hashes/hash.h.orig	2023-03-03 12:16:28 UTC
+++ C/hashes/hash.h
@@ -42,6 +42,11 @@
 
 #include "../7zTypes.h"
 
+#ifdef __NetBSD__
+#include <stdint.h>
+#define _UINT64_T_DECLARED
+#endif
+
 #ifndef _UINT32_T_DECLARED
 typedef UInt32 uint32_t;
 #define _UINT32_T_DECLARED


[FILE:351:patches/patch-makefile.machine]
--- makefile.machine.orig	2023-03-03 12:16:28 UTC
+++ makefile.machine
@@ -6,13 +6,9 @@ OPTFLAGS=-O2 -s
 #OPTFLAGS=-O0 -ggdb
 
 ALLFLAGS=${OPTFLAGS} -pipe \
-    	-D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE \
 	-DNDEBUG -D_REENTRANT -DENV_UNIX \
-	-D_7ZIP_LARGE_PAGES \
 	$(LOCAL_FLAGS)
 
-CXX=g++
-CC=gcc
 CC_SHARED=-fPIC
 LINK_SHARED=-fPIC -shared
 


[FILE:112:files/7z]
#!/bin/sh

PROGNAME=${0##*/}
BINPATH=$(dirname $(realpath $0))/../libexec/p7zip

exec "$BINPATH/$PROGNAME" "$@"


[FILE:223:files/special.mk]
# Strip -ldl from all platforms except linux

.if "${OPSYS}" != "Linux"
_USES_configure+= 452:remove_libdl
.endif

remove_libdl:
	@echo "BSD: Remove -ldl linkage"
	${REINPLACE_CMD} -e 's| -ldl||' ${WRKSRC}/makefile.machine

