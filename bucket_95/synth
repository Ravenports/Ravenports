# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		synth
VERSION=		3.12
KEYWORDS=		sysutils
VARIANTS=		std
SDESC[std]=		Custom package repository builder for FreeBSD
HOMEPAGE=		https://github.com/jrmarino/synth
CONTACT=		John_Marino[draco@marino.st]

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/jrmarino:synth:v3.12
DISTFILE[1]=		generated:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			man

OPTIONS_AVAILABLE=	WATCHDOG
OPTIONS_STANDARD=	WATCHDOG

ONLY_FOR_OPSYS=		freebsd dragonfly

BUILD_DEPENDS=		adacurses:primary:std
			ini_file_manager:set:std

USES=			gprbuild ncurses

LICENSE=		ISCL:primary
LICENSE_FILE=		ISCL:{{WRKSRC}}/License.txt
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		ports-mgmt/synth

MAKE_ENV=		NCURSES_LINK=static

[WATCHDOG].DESCRIPTION=			Build with watchdog monitor
[WATCHDOG].EXTRA_PATCHES_OFF=		{{FILESDIR}}/extrapatch-nowatchdog-portscan-buildcycle.adb

do-build:
	(cd ${WRKSRC}/synthexec && ${SETENV} ${MAKE_ENV} \
		gcc synthexec.c -o ../build/synthexec)
	(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} gprbuild -p -P default)

pre-configure:
	${REINPLACE_CMD} -e "s|/usr/local|${LOCALBASE}|" \
		${WRKSRC}/src/definitions.ads
	# Support Ini-File-Manager 09
	${REINPLACE_CMD} -e "s|(File_Name =>|(Config_File_Name =>|" \
		${WRKSRC}/src/parameters.adb
	# Fix paths in the man page
	${REINPLACE_CMD} -e "s|/usr/local|${PREFIX}|g" ${WRKSRC}/synth.1

do-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/bash_completion.d \
		${STAGEDIR}${PREFIX}/share/zsh/site-functions \
		${STAGEDIR}${PREFIX}/share/synth \
		${STAGEDIR}/var/log/synth \
		${STAGEDIR}/var/synth/live_packages
	${INSTALL_PROGRAM} ${WRKSRC}/build/synth \
		${STAGEDIR}${PREFIX}/bin
	${INSTALL_PROGRAM} ${WRKSRC}/build/synthexec \
		${STAGEDIR}${PREFIX}/libexec
	${INSTALL_MAN} ${WRKSRC}/synth.1 ${STAGEDIR}${MANPREFIX}/man/man1
	${INSTALL_SCRIPT} ${WRKSRC}/shell-completers/_synth.bash \
		${STAGEDIR}${PREFIX}/etc/bash_completion.d
	${INSTALL_DATA} ${WRKSRC}/shell-completers/_synth \
		${STAGEDIR}${PREFIX}/share/zsh/site-functions
	${INSTALL_DATA} ${WRKSRC}/www/* ${STAGEDIR}${PREFIX}/share/synth
	# synth expects pkg to be at ${PREFIX}/sbin/pkg so symlink to it
	(cd ${STAGEDIR}${PREFIX}/sbin && ln -s /usr/local/sbin/pkg)

[FILE:1155:descriptions/desc.primary]
Synth is a custom packge repository builder for FreeBSD and DragonFly.

It is intended to replace Portmaster, portupgrade, and poudriere for
the average user.  It is simple to learn (the powerful options are
limited in number) and user-friendly, but it is extremely fast due
to its parallel building capability.  It will "drop-in" on any system
as it leverages the stock pkg(8) facilities.  All ports are built
in a clean environment, so it is finally safe to build ports as
needed on a live system.  The default profile is the system itself, not
a new jail, which can be a valuable feature for some environments.

To bring a system up-to-date only requires one command after the ports
tree is updated:

  > synth upgrade-system

During the building process, a curses-based display will show the status
of all the builders and the entire bulk run process. A dynamic and
searchable web-based report is generated simultaneously. Synth is intended
to be grasped and utilized by novice users within minutes, but offers
most of the same powerful features as Poudriere for the power users.
Synth requires no preparation; it works immediately upon installation.


[FILE:105:distinfo]
ae837652ed4afed57db36587c25b8d866a922332f2981f7d901792297ecc8d22       175454 jrmarino-synth-3.12.tar.gz


[FILE:251:manifests/plist.primary]
bin/synth
etc/bash_completion.d/_synth.bash
libexec/synthexec
sbin/pkg
share/synth/
 favicon.png
 progress.css
 progress.html
 progress.js
 synth.png
 synth_ncurses.png
share/zsh/site-functions/_synth
@dir /var/log/synth
@dir /var/synth/live_packages


[FILE:23:manifests/plist.man]
share/man/man1/synth.1


[FILE:595:files/extrapatch-nowatchdog-portscan-buildcycle.adb]
--- src/portscan-buildcycle.adb.orig	2017-04-20 10:12:27.241713000 +1200
+++ src/portscan-buildcycle.adb	2017-04-20 10:12:38.218162000 +1200
@@ -570,7 +570,7 @@
       status      : Unix.process_exit;
       lock_lines  : Natural;
       quartersec  : one_minute := one_minute'First;
-      hangmonitor : constant Boolean := True;
+      hangmonitor : constant Boolean := False;
       synthexec   : constant String := host_localbase & "/libexec/synthexec";
       truecommand : constant String := synthexec & " " &
                              log_name (trackers (id).seq_id) & " " & command;

