# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		libarchive
VERSION=		3.5.0
KEYWORDS=		archivers
VARIANTS=		standard static extended ravensw
SDESC[standard]=	Library to handle many streaming archive formats
SDESC[extended]=	Extended libarchive with lzo and lz4 capability
SDESC[static]=		Static build of libarchive
SDESC[ravensw]=		Zstd-only libarchive for ravensw
HOMEPAGE=		http://libarchive.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		http://libarchive.org/downloads/
			https://www.libarchive.de/downloads/
DISTFILE[1]=		libarchive-3.5.0.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	single
SPKGS[extended]=	single
SPKGS[static]=		single
SPKGS[ravensw]=		single

OPTIONS_AVAILABLE=	NOT_STD STATIC EXTENDED RAVENSW
OPTIONS_STANDARD=	none
VOPTS[extended]=	NOT_STD=ON STATIC=OFF EXTENDED=ON RAVENSW=OFF
VOPTS[static]=		NOT_STD=ON STATIC=ON EXTENDED=OFF RAVENSW=OFF
VOPTS[ravensw]=		NOT_STD=ON STATIC=OFF EXTENDED=OFF RAVENSW=ON

BUILD_DEPENDS=		expat:static:standard
			Zstandard:static:standard

USES=			cpe libtool

LICENSE=		BSD2CLAUSE:single BSD3CLAUSE:single PUBDOM:single
LICENSE_FILE=		BSD2CLAUSE:{{WRKSRC}}/COPYING
			BSD3CLAUSE:{{WRKSRC}}/COPYING
			PUBDOM:{{WRKSRC}}/COPYING
LICENSE_SCHEME=		multi

FPC_EQUIVALENT=		archivers/libarchive

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--without-xml2
			--without-iconv
			--disable-acl
CONFIGURE_ENV=		ac_cv_lib_md_MD5Init=no

INSTALL_TARGET=		install-strip
SOVERSION=		13.5.0

LDFLAGS=		-lpthread

[STATIC].DESCRIPTION=			Build version for raven sysroots
[STATIC].BUILD_DEPENDS_ON=		libressl:single:static
					xz:single:static
					bzip2:static:standard
					zlib:static:standard
[STATIC].CONFIGURE_ARGS_ON=		--enable-shared=no
					--enable-static=yes

[RAVENSW].DESCRIPTION=			Build zstd-only version for ravensw
[RAVENSW].BUILD_DEPENDS_ON=		libressl:single:static
					Zstandard:shared:standard
					expat:shared:standard
[RAVENSW].CONFIGURE_ARGS_ON=		--enable-shared=yes
					--enable-static=yes
					--without-zlib
					--without-bz2lib
					--without-libb2
					--without-lz4
					--without-lzo2
					--without-lzma
					--enable-bsdtar=no
					--enable-bsdcat=no
					--enable-bsdcpio=no

[EXTENDED].DESCRIPTION=			Build loaded version (common + lzo + lz4)
[EXTENDED].BUILDRUN_DEPENDS_ON=		expat:shared:standard
					Zstandard:shared:standard
					libressl:single:standard
					xz:single:standard
					bzip2:shared:standard
					zlib:shared:standard
					lzo:shared:standard
					lz4:shared:standard
[EXTENDED].BUILD_DEPENDS_ON=		bzip2:static:standard
					zlib:static:standard
					lzo:static:standard
					lz4:static:standard
[EXTENDED].CONFIGURE_ARGS_ON=		--enable-shared=yes
					--with-lzo2
					--with-lz4

[NOT_STD].DESCRIPTION=			Don't build common user version
[NOT_STD].BUILDRUN_DEPENDS_OFF=		libressl:single:standard
					expat:shared:standard
					xz:single:standard
					bzip2:shared:standard
					zlib:shared:standard
					Zstandard:shared:standard
[NOT_STD].BUILD_DEPENDS_OFF=		bzip2:static:standard
					zlib:static:standard
[NOT_STD].CONFIGURE_ARGS_OFF=		--enable-shared=yes

post-build-RAVENSW-ON:
	# assemble PIC library
	(cd ${WRKSRC}/libarchive/.libs &&\
	 ${AR} -cruv libarchive_pic.a *.o &&\
	 ranlib libarchive_pic.a)

do-test:
	(cd ${WRKSRC} && ${SETENV} ${MAKE_ENV} ${MAKE_CMD} check)

post-install-RAVENSW-ON:
	${RM} -r ${STAGEDIR}${MANPREFIX}/man/man[135]
	${RM} ${STAGEDIR}${PREFIX}/lib/libarchive.so*
	# install our PIC library
	${INSTALL_DATA} ${WRKSRC}/libarchive/.libs/libarchive_pic.a \
		${STAGEDIR}${PREFIX}/lib/

[FILE:1042:descriptions/desc.single]
The libarchive library features:
 * Support for a variety of archive and compression formats.
 * Robust automatic format detection, including archive/compression
   combinations such as tar.gz.
 * Zero-copy internal architecture for high performance.
 * Streaming architecture eliminates all limits on size of archive,
   limits on entry sizes depend on particular formats.
 * Carefully factored code to minimize bloat when programs are
   statically linked.
 * Growing test suite to verify correctness of new ports.
 * Works on most POSIX-like systems (including FreeBSD, Linux,
   Solaris, etc.)

The bsdtar and bsdcpio command-line utilities are feature- and
performance-competitive with other tar and cpio implementations:
 * Reads a variety of formats, including tar, pax, cpio, zip, xar,
   lha, ar, cab, mtree, rar, and ISO images.
 * Writes tar, pax, cpio, zip, xar, ar, ISO, mtree, and shar archives.
 * Automatically handles archives compressed with gzip, bzip2, lzip,
   xz, lzma, or compress.
 * Unique format conversion feature.


[FILE:102:distinfo]
fc4bc301188376adc18780d35602454cc8df6396e1b040fbcbb0d4c0469faf54      7017726 libarchive-3.5.0.tar.gz


[FILE:1281:manifests/plist.single]
bin/
 bsdcat
 bsdcpio
 bsdtar
include/
 archive.h
 archive_entry.h
lib/
 libarchive.a
 libarchive.so
 libarchive.so.%%SOMAJOR%%
 libarchive.so.%%SOVERSION%%
lib/pkgconfig/libarchive.pc
share/man/man1/
 bsdcat.1.gz
 bsdcpio.1.gz
 bsdtar.1.gz
share/man/man3/
 archive_entry.3.gz
 archive_entry_acl.3.gz
 archive_entry_linkify.3.gz
 archive_entry_misc.3.gz
 archive_entry_paths.3.gz
 archive_entry_perms.3.gz
 archive_entry_stat.3.gz
 archive_entry_time.3.gz
 archive_read.3.gz
 archive_read_add_passphrase.3.gz
 archive_read_data.3.gz
 archive_read_disk.3.gz
 archive_read_extract.3.gz
 archive_read_filter.3.gz
 archive_read_format.3.gz
 archive_read_free.3.gz
 archive_read_header.3.gz
 archive_read_new.3.gz
 archive_read_open.3.gz
 archive_read_set_options.3.gz
 archive_util.3.gz
 archive_write.3.gz
 archive_write_blocksize.3.gz
 archive_write_data.3.gz
 archive_write_disk.3.gz
 archive_write_filter.3.gz
 archive_write_finish_entry.3.gz
 archive_write_format.3.gz
 archive_write_free.3.gz
 archive_write_header.3.gz
 archive_write_new.3.gz
 archive_write_open.3.gz
 archive_write_set_options.3.gz
 archive_write_set_passphrase.3.gz
 libarchive.3.gz
 libarchive_changes.3.gz
 libarchive_internals.3.gz
share/man/man5/
 cpio.5.gz
 libarchive-formats.5.gz
 mtree.5.gz
 tar.5.gz


[FILE:1208:manifests/plist.single.static]
bin/
 bsdcat
 bsdcpio
 bsdtar
include/
 archive.h
 archive_entry.h
lib/libarchive.a
lib/pkgconfig/libarchive.pc
share/man/man1/
 bsdcat.1.gz
 bsdcpio.1.gz
 bsdtar.1.gz
share/man/man3/
 archive_entry.3.gz
 archive_entry_acl.3.gz
 archive_entry_linkify.3.gz
 archive_entry_misc.3.gz
 archive_entry_paths.3.gz
 archive_entry_perms.3.gz
 archive_entry_stat.3.gz
 archive_entry_time.3.gz
 archive_read.3.gz
 archive_read_add_passphrase.3.gz
 archive_read_data.3.gz
 archive_read_disk.3.gz
 archive_read_extract.3.gz
 archive_read_filter.3.gz
 archive_read_format.3.gz
 archive_read_free.3.gz
 archive_read_header.3.gz
 archive_read_new.3.gz
 archive_read_open.3.gz
 archive_read_set_options.3.gz
 archive_util.3.gz
 archive_write.3.gz
 archive_write_blocksize.3.gz
 archive_write_data.3.gz
 archive_write_disk.3.gz
 archive_write_filter.3.gz
 archive_write_finish_entry.3.gz
 archive_write_format.3.gz
 archive_write_free.3.gz
 archive_write_header.3.gz
 archive_write_new.3.gz
 archive_write_open.3.gz
 archive_write_set_options.3.gz
 archive_write_set_passphrase.3.gz
 libarchive.3.gz
 libarchive_changes.3.gz
 libarchive_internals.3.gz
share/man/man5/
 cpio.5.gz
 libarchive-formats.5.gz
 mtree.5.gz
 tar.5.gz


[FILE:102:manifests/plist.single.ravensw]
include/
 archive.h
 archive_entry.h
lib/
 libarchive.a
 libarchive_pic.a
lib/pkgconfig/libarchive.pc


[FILE:879:patches/patch-fix-without-lzma]
From a9c656eb704b44baaeb5aeae9be438081be62377 Mon Sep 17 00:00:00 2001
From: Martin Matuska <martin@matuska.org>
Date: Fri, 4 Dec 2020 12:04:52 +0100
Subject: [PATCH] Add missing ifdef to unbreak build withot lzma

Fixes #1461
---
 libarchive/archive_read_support_format_zip.c | 2 ++
 1 file changed, 2 insertions(+)

--- libarchive/archive_read_support_format_zip.c
+++ libarchive/archive_read_support_format_zip.c
@@ -899,6 +899,7 @@ process_extra(struct archive_read *a, struct archive_entry *entry,
 	return ARCHIVE_OK;
 }
 
+#if HAVE_LZMA_H && HAVE_LIBLZMA
 /*
  * Auxiliary function to uncompress data chunk from zipx archive
  * (zip with lzma compression).
@@ -971,6 +972,7 @@ zipx_lzma_uncompress_buffer(const char *compressed_buffer,
 	free(lzma_alone_compressed_buffer);
 	return status;
 }
+#endif
 
 /*
  * Assumes file pointer is at beginning of local file header.


[FILE:483:patches/patch-libarchive_archive__write__add__filter__zstd.c]
--- libarchive/archive_write_add_filter_zstd.c.orig	2020-04-16 00:20:43 UTC
+++ libarchive/archive_write_add_filter_zstd.c
@@ -62,7 +62,7 @@ struct private_data {
 /* If we don't have the library use default range values (zstdcli.c v1.4.0) */
 #define CLEVEL_MIN -99
 #define CLEVEL_STD_MIN 0 /* prior to 1.3.4 and more recent without using --fast */
-#define CLEVEL_DEFAULT 3
+#define CLEVEL_DEFAULT 7
 #define CLEVEL_STD_MAX 19 /* without using --ultra */
 #define CLEVEL_MAX 22
 

