# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		stunnel
VERSION=		5.72
KEYWORDS=		security
VARIANTS=		standard
SDESC[standard]=	SSL/TLS offloading and load-balancing proxy
HOMEPAGE=		https://www.stunnel.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://www.stunnel.org/downloads/archive/5.x/
DISTFILE[1]=		stunnel-5.72.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			primary
			dev
			docs
			examples
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

USERS=			stunnel
GROUPS=			stunnel
USERGROUP_SPKG=		primary

USES=			cpe libtool perl:build shebangfix ssl:openssl30
			mbsdfix

LICENSE=		GPLv2+:primary
LICENSE_TERMS=		primary:{{WRKSRC}}/COPYING.md
LICENSE_FILE=		GPLv2+:stock
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		security/stunnel
SHEBANG_FILES=		src/stunnel3.in

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--localstatedir=/var/tmp
			--enable-static
			--disable-systemd
			--with-ssl="{{OPENSSLBASE}}"
			--with-threads=pthread
			--enable-fips
			--enable-ipv6

INSTALL_TARGET=		install-strip
RC_SUBR=		stunnel:primary

LDFLAGS=		-lpthread

post-patch:
	# place files under /var/tmp so that this can be run by an unprivileged
	# user stunnel and group stunnel
	${REINPLACE_CMD} -E -e 's|\@prefix\@/var/lib/stunnel/|/var/tmp/stunnel|; \
		s|nobody|stunnel|;s|nogroup|stunnel|;s|;include |include |' \
		${WRKSRC}/tools/stunnel.conf-sample.in
	${REINPLACE_CMD} -E -e 's|\$$\(prefix\)/var/run/stunnel/stunnel.pid|$$(localstatedir)/stunnel.pid|' \
		${WRKSRC}/src/Makefile.in
	${FIND} ${WRKSRC} -type f -name Makefile.in | ${XARGS} \
		${REINPLACE_CMD} -E \
		-e 's,@(ACLOCAL|AUTO(MAKE|CONF|HEADER))@,/usr/bin/true,' \
		-e 's,(COPYING|COPYRIGHT)[.]md,,g'
	${REINPLACE_CMD} -E -e \
		's|install-confDATA install-data-local|install-confDATA|g' \
		${WRKSRC}/tools/Makefile.in
	# don't add stack-protector
	${REINPLACE_CMD} -e 's|-fstack-protector||' ${WRKSRC}/configure
	# relocate examples
	${REINPLACE_CMD} -E -e 's|\$$\(docdir\)/examples|${STD_EXAMPLESDIR}|g' \
		${WRKSRC}/tools/Makefile.in

post-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/stunnel/conf.d/
	${INSTALL_DATA} ${FILESDIR}/pid.conf \
		${STAGEDIR}${PREFIX}/etc/stunnel/conf.d/00-pid.conf

[FILE:440:descriptions/desc.primary]
The stunnel program is designed to work as SSL encryption wrapper between
remote client and local (inetd-startable) or remote server. The concept is
that having non-SSL aware daemons running on your system you can easily
setup them to communicate with clients over secure SSL channel.

stunnel can be used to add SSL functionality to commonly used inetd
daemons like POP-2, POP-3 and IMAP servers without any changes in the
programs' code.


[FILE:98:distinfo]
3d532941281ae353319735144e4adb9ae489a10b7e309c58a48157f08f42e949       900872 stunnel-5.72.tar.gz


[FILE:113:manifests/plist.primary]
bin/
 stunnel
 stunnel3
etc/stunnel/stunnel.conf-sample
etc/stunnel/conf.d/00-pid.conf
lib/stunnel/libstunnel.so


[FILE:25:manifests/plist.dev]
lib/stunnel/libstunnel.a


[FILE:171:manifests/plist.docs]
share/doc/stunnel/
 AUTHORS.md
 BUGS.md
 CREDITS.md
 INSTALL.FIPS.md
 INSTALL.W32.md
 INSTALL.WCE.md
 NEWS.md
 PORTS.md
 README.md
 TODO.md
 stunnel.html
 stunnel.pl.html


[FILE:160:manifests/plist.examples]
share/examples/stunnel/
 ca.html
 ca.pl
 importCA.html
 importCA.sh
 script.sh
 stunnel.init
 stunnel.logrotate
 stunnel.rh.init
 stunnel.service
 stunnel.spec


[FILE:47:manifests/plist.man]
share/man/man8/
 stunnel.8.gz
 stunnel.pl.8.gz


[FILE:571:patches/patch-configure.ac]
--- configure.ac.orig	2023-09-19 20:09:36 UTC
+++ configure.ac
@@ -97,13 +97,6 @@ if test "${GCC}" = yes; then
     AX_APPEND_COMPILE_FLAGS([-Wconversion])
     AX_APPEND_COMPILE_FLAGS([-Wno-deprecated-declarations])
     AX_APPEND_COMPILE_FLAGS([-fPIE])
-    case "${host}" in
-        avr-*.* | powerpc-*-aix* | rl78-*.* | visium-*.*)
-            ;;
-        *)
-            AX_APPEND_COMPILE_FLAGS([-fstack-protector])
-            ;;
-    esac
     AX_APPEND_LINK_FLAGS([-fPIE -pie])
     AX_APPEND_LINK_FLAGS([-Wl,-z,relro])
     AX_APPEND_LINK_FLAGS([-Wl,-z,now])


[FILE:27:files/pid.conf]
pid = /var/run/stunnel.pid


[FILE:912:files/stunnel.in]
#!/bin/sh

# PROVIDE: stunnel
# REQUIRE: NETWORKING SERVERS
# BEFORE: DAEMON
# KEYWORD: shutdown

#
# Add some of the following variables to /etc/rc.conf to configure stunnel:
# stunnel_enable (bool):	Set to "NO" by default.
#				Set it to "YES" to enable stunnel.
# stunnel_config (str):		Default "%%ETCDIR%%/stunnel.conf"
#				Set it to the full path to the config file
#				that stunnel will use during the automated
#				start-up.
# stunnel_pidfile (str):	Default "%%PREFIX%%/var/stunnel/stunnel.pid"
#				Set it to the value of 'pid' in
#				the stunnel.conf file.
#

. /etc/rc.subr

name="stunnel"
rcvar=stunnel_enable

load_rc_config $name

: ${stunnel_enable="NO"}
: ${stunnel_config="%%ETCDIR%%/${name}.conf"}
: ${stunnel_pidfile="/var/run/${name}.pid"}

command="%%PREFIX%%/bin/stunnel"
command_args=${stunnel_config}
pidfile=${stunnel_pidfile}

required_files="${stunnel_config}"

run_rc_command "$1"

