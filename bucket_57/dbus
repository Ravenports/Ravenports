# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		dbus
VERSION=		1.14.10
KEYWORDS=		devel
VARIANTS=		standard
SDESC[standard]=	Message bus system for IPC communication
HOMEPAGE=		http://www.freedesktop.org/Software/dbus
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://dbus.freedesktop.org/releases/dbus/
DISTFILE[1]=		dbus-1.14.10.tar.xz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			primary
			dev
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		minixmlto:single:standard
RUN_DEPENDS=		xmlcatmgr:single:standard

USERS=			messagebus
GROUPS=			messagebus
USERGROUP_SPKG=		primary

USES=			cpe gmake libtool expat python:build shebangfix
XORG_COMPONENTS=	ice sm x11

LICENSE=		CUSTOM1:primary GPLv2+:primary
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_NAME=		CUSTOM1:"Academic Free License version 2.1"
LICENSE_FILE=		GPLv2+:stock
			CUSTOM1:{{WRKDIR}}/LICENSE_AFL
LICENSE_AWK=		TERMS:"^The Academic"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/COPYING
LICENSE_SCHEME=		dual

CPE_VENDOR=		freedesktop
FPC_EQUIVALENT=		devel/dbus
SHEBANG_FILES=		tools/GetAllMatchRules.py

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--with-x
			--with-test-socket-dir={{WRKDIR}}
			--disable-doxygen-docs
			--disable-selinux
			--disable-apparmor
			--disable-systemd
CONFIGURE_ENV=		XMLTO={{LOCALBASE}}/bin/minixmlto

INSTALL_TARGET=		install-strip
SOVERSION=		3.32.4
PLIST_SUB=		VERSION="1.0"
			GROUPS={{GROUPS}}
			DTDDIR=share/xml/dbus-1
RC_SUBR=		dbus:primary
SUB_FILES=		catalog
			catalog.xml
SUB_LIST=		DTDDIR={{PREFIX}}/share/xml/dbus-1

post-patch:
	${REINPLACE_CMD} -e 's|/usr/local|${LOCALBASE}|g' \
		${WRKSRC}/dbus/dbus-sysdeps-unix.c
	${REINPLACE_CMD} '/^SUBDIRS =/s|test||' ${WRKSRC}/Makefile.in

post-install:
	# delete examples
	${RM} -r ${STAGEDIR}${STD_DOCDIR}
	# install xmlcat catalogs
	(cd ${WRKDIR} && ${INSTALL_DATA} catalog* \
		${STAGEDIR}${PREFIX}/share/xml/dbus-1/)
	# Workaround for software looking for machine-id in wrong place (lumina)
	${MKDIR} ${STAGEDIR}${PREFIX}/var/lib
	${MKDIR} ${STAGEDIR}${PREFIX}/var/run
	${LN} -s /var/lib/dbus ${STAGEDIR}${PREFIX}/var/lib/dbus
	${LN} -s /var/run/dbus ${STAGEDIR}${PREFIX}/var/run/dbus

post-extract:
	${AWK} '/^The Academic Free License/,/^but the BSD, MIT/' \
		${WRKSRC}/COPYING > ${WRKDIR}/LICENSE_AFL

[FILE:392:descriptions/desc.primary]
D-BUS supplies both a system daemon (for events such as "new hardware device
added" or "printer queue changed") and a per-user-login-session daemon (for
general IPC needs among user applications). Also, the message bus is built on
top of a general one-to-one message passing framework, which can be used by
any two apps to communicate directly (without going through the message bus
daemon).


[FILE:98:distinfo]
ba1f21d2bd9d339da2d4aa8780c09df32fea87998b73da24f49ab9df1e36a50f      1372328 dbus-1.14.10.tar.xz


[FILE:648:manifests/plist.primary]
bin/
 dbus-cleanup-sockets
 dbus-daemon
 dbus-launch
 dbus-monitor
 dbus-run-session
 dbus-send
 dbus-test-tool
 dbus-update-activation-environment
 dbus-uuidgen
etc/dbus-1/
 session.conf
 system.conf
lib/
 libdbus-1.so.%%SOMAJOR%%
 libdbus-1.so.%%SOVERSION%%
@(,%%GROUPS%%,4750) libexec/dbus-daemon-launch-helper
share/dbus-1/
 session.conf
 system.conf
share/xml/dbus-1/
 busconfig.dtd
 introspect.dtd
var/lib/dbus
var/run/dbus
@dir /var/lib/dbus
@dir /var/run/dbus
@dir share/dbus-1/services
@dir share/dbus-1/session.d
@dir share/dbus-1/system-services
@dir share/dbus-1/system.d
@xmlcatmgr %%DTDDIR%%/catalog
@xmlcatmgr %%DTDDIR%%/catalog.xml


[FILE:460:manifests/plist.dev]
include/dbus-%%VERSION%%/dbus/
 dbus-address.h
 dbus-bus.h
 dbus-connection.h
 dbus-errors.h
 dbus-macros.h
 dbus-memory.h
 dbus-message.h
 dbus-misc.h
 dbus-pending-call.h
 dbus-protocol.h
 dbus-server.h
 dbus-shared.h
 dbus-signature.h
 dbus-syntax.h
 dbus-threads.h
 dbus-types.h
 dbus.h
lib/
 libdbus-1.a
 libdbus-1.so
lib/cmake/DBus1/
 DBus1Config.cmake
 DBus1ConfigVersion.cmake
lib/dbus-%%VERSION%%/include/dbus/dbus-arch-deps.h
lib/pkgconfig/dbus-1.pc


[FILE:218:manifests/plist.man]
share/man/man1/
 dbus-cleanup-sockets.1.gz
 dbus-daemon.1.gz
 dbus-launch.1.gz
 dbus-monitor.1.gz
 dbus-run-session.1.gz
 dbus-send.1.gz
 dbus-test-tool.1.gz
 dbus-update-activation-environment.1.gz
 dbus-uuidgen.1.gz


[FILE:1126:patches/patch-configure]
--- configure.orig	2023-09-01 14:31:27 UTC
+++ configure
@@ -25462,7 +25462,7 @@ fi
 done
 
 
-    if test "$ax_enable_compile_warnings" != "no"
+    if test "$ax_enable_compile_warnings" == "skipme"
 then :
 
         if test "$ax_compiler_cxx" = "no" ; then
@@ -26054,7 +26054,7 @@ fi
 done
 
 
-    if test "$ax_enable_compile_warnings" != "no"
+    if test "$ax_enable_compile_warnings" != "yes"
 then :
 
         # "yes" flags
@@ -27133,7 +27133,7 @@ then :
 
 
 
-for flag in    ; do
+for flag in ""   ; do
   as_CACHEVAR=`printf "%s\n" "ax_cv_check_ldflags_$ax_compiler_flags_test_$flag" | $as_tr_sh`
 { printf "%s\n" "$as_me:${as_lineno-$LINENO}: checking whether the linker accepts $flag" >&5
 printf %s "checking whether the linker accepts $flag... " >&6; }
@@ -27318,8 +27318,6 @@ case $host_os in
         CFLAGS="$CFLAGS -D_POSIX_PTHREAD_SEMANTICS -D_REENTRANT"
         # ... this opt-in to get sockaddr_in6 and sockaddr_storage...
         CFLAGS="$CFLAGS -D__EXTENSIONS__"
-        # ... and this opt-in to get file descriptor passing support
-        CFLAGS="$CFLAGS -D_XOPEN_SOURCE=500"
         ;;
 esac
 


[FILE:3151:patches/patch-dbus_dbus-connection.c]
--- dbus/dbus-connection.c.orig	2023-06-06 13:00:36 UTC
+++ dbus/dbus-connection.c
@@ -2397,7 +2397,7 @@ _dbus_connection_block_pending_call (DBu
   DBusConnection *connection;
   dbus_uint32_t client_serial;
   DBusTimeout *timeout;
-  int timeout_milliseconds, elapsed_milliseconds;
+  int timeout_milliseconds, elapsed_milliseconds, remain_milliseconds;
 
   _dbus_assert (pending != NULL);
 
@@ -2478,7 +2478,11 @@ _dbus_connection_block_pending_call (DBu
   _dbus_get_monotonic_time (&tv_sec, &tv_usec);
   elapsed_milliseconds = (tv_sec - start_tv_sec) * 1000 +
 	  (tv_usec - start_tv_usec) / 1000;
-  
+  if (timeout_milliseconds != -1)
+    remain_milliseconds = timeout_milliseconds - elapsed_milliseconds;
+  else
+    remain_milliseconds = -1;
+
   if (!_dbus_connection_get_is_connected_unlocked (connection))
     {
       DBusMessage *error_msg;
@@ -2506,7 +2510,7 @@ _dbus_connection_block_pending_call (DBu
            */
           _dbus_verbose ("dbus_connection_send_with_reply_and_block() waiting for more memory\n");
 
-          _dbus_memory_pause_based_on_timeout (timeout_milliseconds - elapsed_milliseconds);
+          _dbus_memory_pause_based_on_timeout (remain_milliseconds);
         }
       else
         {          
@@ -2515,7 +2519,7 @@ _dbus_connection_block_pending_call (DBu
                                                   pending,
                                                   DBUS_ITERATION_DO_READING |
                                                   DBUS_ITERATION_BLOCK,
-                                                  timeout_milliseconds - elapsed_milliseconds);
+                                                  remain_milliseconds);
         }
 
       goto recheck_status;
@@ -2524,7 +2528,7 @@ _dbus_connection_block_pending_call (DBu
     _dbus_verbose ("dbus_connection_send_with_reply_and_block(): clock set backward\n");
   else if (elapsed_milliseconds < timeout_milliseconds)
     {
-      _dbus_verbose ("dbus_connection_send_with_reply_and_block(): %d milliseconds remain\n", timeout_milliseconds - elapsed_milliseconds);
+      _dbus_verbose ("dbus_connection_send_with_reply_and_block(): %d milliseconds remain\n", remain_milliseconds);
       
       if (status == DBUS_DISPATCH_NEED_MEMORY)
         {
@@ -2534,7 +2538,7 @@ _dbus_connection_block_pending_call (DBu
            */
           _dbus_verbose ("dbus_connection_send_with_reply_and_block() waiting for more memory\n");
 
-          _dbus_memory_pause_based_on_timeout (timeout_milliseconds - elapsed_milliseconds);
+          _dbus_memory_pause_based_on_timeout (remain_milliseconds);
         }
       else
         {          
@@ -2543,7 +2547,7 @@ _dbus_connection_block_pending_call (DBu
                                                   pending,
                                                   DBUS_ITERATION_DO_READING |
                                                   DBUS_ITERATION_BLOCK,
-                                                  timeout_milliseconds - elapsed_milliseconds);
+                                                  remain_milliseconds);
         }
 
       goto recheck_status;


[FILE:354:patches/patch-dbus_dbus-sysdeps-unix.c]
--- dbus/dbus-sysdeps-unix.c.orig	2023-08-16 10:29:50 UTC
+++ dbus/dbus-sysdeps-unix.c
@@ -24,6 +24,14 @@
 
 #include <config.h>
 
+#ifdef __sun
+#  if __STDC_VERSION__ - 0 < 199901L
+#define	_XOPEN_SOURCE	500
+#  else
+#define	_XOPEN_SOURCE	600
+#  endif
+#endif
+
 #include "dbus-internals.h"
 #include "dbus-sysdeps.h"
 #include "dbus-sysdeps-unix.h"


[FILE:1374:patches/patch-dbus_dbus-sysdeps-util-unix.c]
--- dbus/dbus-sysdeps-util-unix.c.orig	2023-09-01 14:23:58 UTC
+++ dbus/dbus-sysdeps-util-unix.c
@@ -43,6 +43,7 @@
 #include <stdio.h>
 #include <errno.h>
 #include <fcntl.h>
+#include <syslog.h>
 #include <limits.h>
 #include <sys/stat.h>
 #ifdef HAVE_SYS_RESOURCE_H
@@ -53,6 +54,10 @@
 #include <dirent.h>
 #include <sys/un.h>
 
+#if defined(__sun) && defined(__SVR4)
+#include <pwd.h>
+#endif
+
 #ifdef HAVE_SYS_PRCTL_H
 #include <sys/prctl.h>
 #endif
@@ -578,8 +583,31 @@ _dbus_user_at_console (const char *usern
 #ifdef DBUS_CONSOLE_AUTH_DIR
   DBusString u, f;
   dbus_bool_t result;
+#if defined(__sun) && defined(__SVR4)
+  struct passwd *passwd_entry;
+#endif
 
   result = FALSE;
+
+#if defined(__sun) && defined(__SVR4)
+  passwd_entry = getpwnam (username);
+  if (passwd_entry != NULL)
+    {
+      struct stat st;
+      uid_t uid;
+
+      uid = passwd_entry->pw_uid;
+
+      if (stat ("/dev/vt/console_user", &st) == 0 && st.st_uid == uid)
+        {
+         /*
+          * Owner is allowed to take over. Before we have real
+          * ownership in HAL, assume it's the console owner.
+          */
+          result = TRUE;
+        }
+    }
+#else
   if (!_dbus_string_init (&f))
     {
       _DBUS_SET_OOM (error);
@@ -604,6 +632,7 @@ _dbus_user_at_console (const char *usern
 
  out:
   _dbus_string_free (&f);
+#endif
 
   return result;
 #else


[FILE:450:patches/patch-doc_Makefile.in]
--- doc/Makefile.in.orig	2023-09-01 14:31:28 UTC
+++ doc/Makefile.in
@@ -906,7 +906,7 @@ catalog.xml: catalog.xml.in
 	$(SED) "s|@DBUS_DTD_DIR@|$(dtddir)|" $< >$@
 
 @DBUS_XML_DOCS_ENABLED_TRUE@%.html: %.xml
-@DBUS_XML_DOCS_ENABLED_TRUE@	$(XMLTO) --stringparam generate.consistent.ids=1 html-nochunks $<
+@DBUS_XML_DOCS_ENABLED_TRUE@	$(XMLTO) html-nochunks $<
 
 @DBUS_XML_DOCS_ENABLED_TRUE@%.1: %.1.xml
 @DBUS_XML_DOCS_ENABLED_TRUE@	$(XMLTO) man $<


[FILE:542:patches/patch-tools_dbus-launch.c]
--- tools/dbus-launch.c.orig	2022-10-02 14:06:53 UTC
+++ tools/dbus-launch.c
@@ -851,6 +851,12 @@ main (int argc, char **argv)
   exit_with_session = FALSE;
   config_file = NULL;
 
+  if (getenv("RAVENADM") != NULL)
+    {
+      fprintf (stderr, "Package building detected, launch not executed.\n");
+      exit (0);
+    }
+
   /* Ensure that the first three fds are open, to ensure that when we
    * create other file descriptors (for example for epoll, inotify or
    * a socket), they never get assigned as fd 0, 1 or 2. If they were,


[FILE:171:files/catalog.in]
OVERRIDE YES
PUBLIC "-//freedesktop//DTD D-BUS Object Introspection 1.0//EN" "introspect.dtd"
PUBLIC "-//freedesktop//DTD D-Bus Bus Configuration 1.0//EN" "busconfig.dtd"


[FILE:479:files/catalog.xml.in]
<?xml version="1.0"?>
<!DOCTYPE catalog PUBLIC "-//OASIS//DTD Entity Resolution XML Catalog V1.0//EN"
	"http://www.oasis-open.org/committees/entity/release/1.0/catalog.dtd">
<catalog xmlns="urn:oasis:names:tc:entity:xmlns:xml:catalog">
  <public publicId="-//freedesktop//DTD D-BUS Object Introspection 1.0//EN" uri="file://%%DTDDIR%%/introspect.dtd" />
  <public publicId="-//freedesktop//DTD D-Bus Bus Configuration 1.0//EN" uri="file://%%DTDDIR%%/busconfig.dtd" />
</catalog>


[FILE:645:files/dbus.in]
#!/bin/sh
#
# $FreeBSD: head/devel/dbus/files/dbus.in 431498 2017-01-14 22:48:49Z tijl $
#
# PROVIDE: dbus
# REQUIRE: DAEMON ldconfig
#
# Add the following lines to /etc/rc.conf to enable the D-BUS messaging system:
#
# dbus_enable="YES"
#

. /etc/rc.subr

: ${dbus_enable=${gnome_enable-NO}} ${dbus_flags="--system"}

name=dbus
rcvar=dbus_enable

command="%%PREFIX%%/bin/dbus-daemon"
pidfile="/var/run/dbus/pid"

start_precmd="dbus_prestart"
stop_postcmd="dbus_poststop"

dbus_prestart()
{
    %%PREFIX%%/bin/dbus-uuidgen --ensure
    mkdir -p /var/run/dbus
}

dbus_poststop()
{
    rm -f $pidfile
}

load_rc_config ${name}
run_rc_command "$1"

