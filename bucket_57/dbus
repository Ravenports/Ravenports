# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		dbus
VERSION=		1.12.0
KEYWORDS=		devel
VARIANTS=		standard
SDESC[standard]=	Message bus system for IPC communication
HOMEPAGE=		http://www.freedesktop.org/Software/dbus
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		http://dbus.freedesktop.org/releases/dbus/
DISTFILE[1]=		dbus-1.12.0.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		expat:static:standard
			minixmlto:single:standard
BUILDRUN_DEPENDS=	expat:shared:standard

USERS=			messagebus
GROUPS=			messagebus
USERGROUP_SPKG=		single

USES=			cpe gmake libtool python:build shebangfix
XORG_COMPONENTS=	ice sm x11

CPE_PRODUCT=		d-bus
CPE_VENDOR=		d-bus_project
FPC_EQUIVALENT=		devel/dbus
SHEBANG_FILES=		tools/GetAllMatchRules.py

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--with-x
			--with-test-socket-dir={{WRKDIR}}
			--disable-doxygen-docs
			--disable-selinux
			--disable-apparmor
			--disable-systemd
CONFIGURE_ENV=		XMLTO={{LOCALBASE}}/bin/minixmlto

INSTALL_TARGET=		install-strip
PLIST_SUB=		VERSION="1.0"
			GROUPS={{GROUPS}}
			SOVERSION=3.19.3
			SOMAJOR=3
RC_SUBR=		dbus:single

post-patch:
	@${REINPLACE_CMD} -e 's|/usr/local|${LOCALBASE}|g' \
		${WRKSRC}/dbus/dbus-sysdeps-unix.c
	@${REINPLACE_CMD} '/^SUBDIRS =/s|test||' ${WRKSRC}/Makefile.in

post-install:
	# delete examples
	${RM} -r ${STAGEDIR}${STD_DOCDIR}

[FILE:392:descriptions/desc.single]
D-BUS supplies both a system daemon (for events such as "new hardware device
added" or "printer queue changed") and a per-user-login-session daemon (for
general IPC needs among user applications). Also, the message bus is built on
top of a general one-to-one message passing framework, which can be used by
any two apps to communicate directly (without going through the message bus
daemon).


[FILE:97:distinfo]
39af0d9267391434b549c5c4adc001b735518c96f7630c3fe7162af1d13ef3c0      2062151 dbus-1.12.0.tar.gz


[FILE:1231:manifests/plist.single]
bin/
 dbus-cleanup-sockets
 dbus-daemon
 dbus-launch
 dbus-monitor
 dbus-run-session
 dbus-send
 dbus-test-tool
 dbus-update-activation-environment
 dbus-uuidgen
etc/dbus-1/
 session.conf
 system.conf
include/dbus-%%VERSION%%/dbus/
 dbus-address.h
 dbus-bus.h
 dbus-connection.h
 dbus-errors.h
 dbus-macros.h
 dbus-memory.h
 dbus-message.h
 dbus-misc.h
 dbus-pending-call.h
 dbus-protocol.h
 dbus-server.h
 dbus-shared.h
 dbus-signature.h
 dbus-syntax.h
 dbus-threads.h
 dbus-types.h
 dbus.h
lib/cmake/DBus1/
 DBus1Config.cmake
 DBus1ConfigVersion.cmake
lib/dbus-%%VERSION%%/include/dbus/dbus-arch-deps.h
lib/
 libdbus-1.a
 libdbus-1.so
 libdbus-1.so.%%SOMAJOR%%
 libdbus-1.so.%%SOVERSION%%
lib/pkgconfig/dbus-1.pc
@(,%%GROUPS%%,4750) libexec/dbus-daemon-launch-helper
share/dbus-1/
 session.conf
 system.conf
share/man/man1/
 dbus-cleanup-sockets.1.gz
 dbus-daemon.1.gz
 dbus-launch.1.gz
 dbus-monitor.1.gz
 dbus-run-session.1.gz
 dbus-send.1.gz
 dbus-test-tool.1.gz
 dbus-update-activation-environment.1.gz
 dbus-uuidgen.1.gz
share/xml/dbus-1/
 busconfig.dtd
 introspect.dtd
@dir share/dbus-1/services
@dir share/dbus-1/session.d
@dir share/dbus-1/system-services
@dir share/dbus-1/system.d
@dir /var/lib/dbus
@dir /var/run/dbus


[FILE:3148:patches/patch-dbus_dbus-connection.c]
--- dbus/dbus-connection.c.orig	2015-09-30 14:48:40 UTC
+++ dbus/dbus-connection.c
@@ -2384,7 +2384,7 @@ _dbus_connection_block_pending_call (DBu
   DBusConnection *connection;
   dbus_uint32_t client_serial;
   DBusTimeout *timeout;
-  int timeout_milliseconds, elapsed_milliseconds;
+  int timeout_milliseconds, elapsed_milliseconds, remain_milliseconds;
 
   _dbus_assert (pending != NULL);
 
@@ -2465,7 +2465,11 @@ _dbus_connection_block_pending_call (DBu
   _dbus_get_monotonic_time (&tv_sec, &tv_usec);
   elapsed_milliseconds = (tv_sec - start_tv_sec) * 1000 +
 	  (tv_usec - start_tv_usec) / 1000;
-  
+  if (timeout_milliseconds != -1)
+    remain_milliseconds = timeout_milliseconds - elapsed_milliseconds;
+  else
+    remain_milliseconds = -1;
+
   if (!_dbus_connection_get_is_connected_unlocked (connection))
     {
       DBusMessage *error_msg;
@@ -2491,7 +2495,7 @@ _dbus_connection_block_pending_call (DBu
            */
           _dbus_verbose ("dbus_connection_send_with_reply_and_block() waiting for more memory\n");
 
-          _dbus_memory_pause_based_on_timeout (timeout_milliseconds - elapsed_milliseconds);
+          _dbus_memory_pause_based_on_timeout (remain_milliseconds);
         }
       else
         {          
@@ -2500,7 +2504,7 @@ _dbus_connection_block_pending_call (DBu
                                                   pending,
                                                   DBUS_ITERATION_DO_READING |
                                                   DBUS_ITERATION_BLOCK,
-                                                  timeout_milliseconds - elapsed_milliseconds);
+                                                  remain_milliseconds);
         }
 
       goto recheck_status;
@@ -2509,7 +2513,7 @@ _dbus_connection_block_pending_call (DBu
     _dbus_verbose ("dbus_connection_send_with_reply_and_block(): clock set backward\n");
   else if (elapsed_milliseconds < timeout_milliseconds)
     {
-      _dbus_verbose ("dbus_connection_send_with_reply_and_block(): %d milliseconds remain\n", timeout_milliseconds - elapsed_milliseconds);
+      _dbus_verbose ("dbus_connection_send_with_reply_and_block(): %d milliseconds remain\n", remain_milliseconds);
       
       if (status == DBUS_DISPATCH_NEED_MEMORY)
         {
@@ -2519,7 +2523,7 @@ _dbus_connection_block_pending_call (DBu
            */
           _dbus_verbose ("dbus_connection_send_with_reply_and_block() waiting for more memory\n");
 
-          _dbus_memory_pause_based_on_timeout (timeout_milliseconds - elapsed_milliseconds);
+          _dbus_memory_pause_based_on_timeout (remain_milliseconds);
         }
       else
         {          
@@ -2528,7 +2532,7 @@ _dbus_connection_block_pending_call (DBu
                                                   NULL,
                                                   DBUS_ITERATION_DO_READING |
                                                   DBUS_ITERATION_BLOCK,
-                                                  timeout_milliseconds - elapsed_milliseconds);
+                                                  remain_milliseconds);
         }
 
       goto recheck_status;


[FILE:274:patches/patch-dbus_dbus-sysdeps-util-unix.c]
--- dbus/dbus-sysdeps-util-unix.c.orig	2015-11-23 21:53:42 UTC
+++ dbus/dbus-sysdeps-util-unix.c
@@ -41,6 +41,7 @@
 #include <stdio.h>
 #include <errno.h>
 #include <fcntl.h>
+#include <syslog.h>
 #include <sys/stat.h>
 #ifdef HAVE_SYS_RESOURCE_H
 #include <sys/resource.h>


[FILE:542:patches/patch-tools_dbus-launch.c]
--- tools/dbus-launch.c.orig	2016-08-15 18:55:42 UTC
+++ tools/dbus-launch.c
@@ -847,6 +847,12 @@ main (int argc, char **argv)
   exit_with_session = FALSE;
   config_file = NULL;
 
+  if (getenv("RAVENADM") != NULL)
+    {
+      fprintf (stderr, "Package building detected, launch not executed.\n");
+      exit (0);
+    }
+
   /* Ensure that the first three fds are open, to ensure that when we
    * create other file descriptors (for example for epoll, inotify or
    * a socket), they never get assigned as fd 0, 1 or 2. If they were,


[FILE:785:files/dbus.in]
#!/bin/sh
#
# $FreeBSD: head/devel/dbus/files/dbus.in 431498 2017-01-14 22:48:49Z tijl $
#
# PROVIDE: dbus
# REQUIRE: DAEMON ldconfig
#
# Add the following lines to /etc/rc.conf to enable the D-BUS messaging system:
#
# dbus_enable="YES"
#

. /etc/rc.subr

: ${dbus_enable=${gnome_enable-NO}} ${dbus_flags="--system"}

name=dbus
rcvar=dbus_enable

command="%%PREFIX%%/bin/dbus-daemon"
pidfile="/var/run/dbus/pid"

start_precmd="dbus_prestart"
stop_postcmd="dbus_poststop"

dbus_prestart()
{
    %%PREFIX%%/bin/dbus-uuidgen --ensure
    mkdir -p /var/run/dbus
}

dbus_poststop()
{
    rm -f $pidfile
# The following two lines may be removed after 2018-01-01
    rm -f /var/db/dbus/machine-id
    [ ! -d /var/db/dbus ] || rmdir /var/db/dbus
}

load_rc_config ${name}
run_rc_command "$1"

