# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		tdb
VERSION=		1.4.11
KEYWORDS=		databases
VARIANTS=		standard
SDESC[standard]=	Trivial Database
HOMEPAGE=		https://tdb.samba.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://download.samba.org/pub/tdb/
			https://ftp.samba.org/pub/tdb/
DISTFILE[1]=		tdb-1.4.11.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			primary
			dev
			tools
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		docbook-xsl:primary:standard
EXRUN[tools]=		tdb:primary:standard

USES=			compiler pkgconfig python gettext shebangfix
GNOME_COMPONENTS=	libxslt

LICENSE=		LGPL3+:primary
LICENSE_TERMS=		primary:{{WRKSRC}}/TERMS
LICENSE_FILE=		LGPL3+:stock
LICENSE_AWK=		TERMS:"^\#include"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/pytdb.c
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		databases/tdb
SHEBANG_FILES=		python/tdbdump.py
			python/tests/simple.py
			buildtools/bin/waf
			buildtools/examples/run_on_target.py
SHEBANG_OLD_PYTHON=	"/usr/bin/env python3"

MUST_CONFIGURE=		yes
CONFIGURE_ARGS=		--prefix={{PREFIX}}
			--mandir={{MANPREFIX}}/man
			--without-gettext

INSTALL_REQ_TOOLCHAIN=	yes
SOVERSION=		1.4.11

post-patch:
	# enable docbook to build manpages
	${REINPLACE_CMD} -e "s|http://docbook.sourceforge.net/release/xsl/current/|file://${LOCALBASE}/share/xsl/docbook/|" \
		${WRKSRC}/buildtools/wafsamba/wafsamba.py \
		${WRKSRC}/buildtools/wafsamba/samba_conftests.py
	${REINPLACE_CMD} -e 's|python3|python${PYTHON_VER}|g' \
		${WRKSRC}/buildtools/wafsamba/samba_python.py \
		${WRKSRC}/third_party/waf/waflib/extras/run_py_script.py

post-install:
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/bin/tdb*
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/lib/libtdb.${LIBEXT}
	${STRIP_CMD} ${STAGEDIR}${PYTHON_SITELIBDIR}/td*.so

[FILE:234:descriptions/desc.primary]
TDB is a Trivial Database. In concept, it is very much like GDBM, and
BSD's DB except that it allows multiple simultaneous writers and uses
locking internally to keep writers from trampling on each other. TDB is
also extremely small.


[FILE:50:descriptions/desc.tools]
This package contains the Trivial database tools.


[FILE:96:distinfo]
4e8ba6d93f383565bbd061be4deee15318232d1bbcca7212f18e17f56bb975a8       747271 tdb-1.4.11.tar.gz


[FILE:445:manifests/plist.primary]
%%ONLY-DRAGONFLY%%%%PYTHON_SITELIBDIR%%/tdb.cpython-%%PYTHON_SUFFIX%%.so
%%ONLY-FREEBSD%%%%PYTHON_SITELIBDIR%%/tdb.cpython-%%PYTHON_SUFFIX%%.so
%%ONLY-LINUX%%%%PYTHON_SITELIBDIR%%/tdb.cpython-%%PYTHON_SUFFIX%%%%PYTHON_ABIVER%%-x86_64-linux-gnu.so
%%ONLY-MIDNIGHTBSD%%%%PYTHON_SITELIBDIR%%/tdb.cpython-%%PYTHON_SUFFIX%%.so
%%ONLY-NETBSD%%%%PYTHON_SITELIBDIR%%/tdb.cpython-%%PYTHON_SUFFIX%%.so
lib/
 libtdb.so.%%SOMAJOR%%
 libtdb.so.%%SOVERSION%%


[FILE:49:manifests/plist.dev]
include/tdb.h
lib/libtdb.so
lib/pkgconfig/tdb.pc


[FILE:81:manifests/plist.tools]
%%PYTHON_SITELIBDIR%%/_tdb_text.py
bin/
 tdbbackup
 tdbdump
 tdbrestore
 tdbtool


[FILE:77:manifests/plist.man]
share/man/man8/
 tdbbackup.8.gz
 tdbdump.8.gz
 tdbrestore.8.gz
 tdbtool.8.gz


[FILE:290:patches/patch-Makefile]
--- Makefile.orig	2023-03-02 09:07:34 UTC
+++ Makefile
@@ -1,6 +1,6 @@
 # simple makefile wrapper to run waf
 
-WAF_BIN=`PATH=buildtools/bin:../../buildtools/bin:$$PATH which waf`
+WAF_BIN=buildtools/bin/waf
 WAF_BINARY=$(PYTHON) $(WAF_BIN)
 WAF=PYTHONHASHSEED=1 WAF_MAKE=1 $(WAF_BINARY)
 


[FILE:2282:patches/patch-buildtools_wafsamba_samba__autoconf.py]
Disable libssp -- it causes segfaults on several platforms, likly some
kind of missing os-specific support or consideration.

--- buildtools/wafsamba/samba_autoconf.py.orig	2024-01-22 08:56:34 UTC
+++ buildtools/wafsamba/samba_autoconf.py
@@ -707,44 +707,6 @@ def SAMBA_CONFIG_H(conf, path=None):
     if not IN_LAUNCH_DIR(conf):
         return
 
-    # we need to build real code that can't be optimized away to test
-    stack_protect_list = ['-fstack-protector-strong', '-fstack-protector']
-    for stack_protect_flag in stack_protect_list:
-        flag_supported = conf.check(fragment='''
-                                    #include <stdio.h>
-
-                                    int main(void)
-                                    {
-                                        char t[100000];
-                                        while (fgets(t, sizeof(t), stdin));
-                                        return 0;
-                                    }
-                                    ''',
-                                    execute=0,
-                                    cflags=[ '-Werror', '-Wp,-D_FORTIFY_SOURCE=2', stack_protect_flag],
-                                    mandatory=False,
-                                    msg='Checking if compiler accepts %s' % (stack_protect_flag))
-        if flag_supported:
-            conf.ADD_CFLAGS('%s' % (stack_protect_flag))
-            break
-
-    flag_supported = conf.check(fragment='''
-                                #include <stdio.h>
-
-                                int main(void)
-                                {
-                                    char t[100000];
-                                    while (fgets(t, sizeof(t), stdin));
-                                    return 0;
-                                }
-                                ''',
-                                execute=0,
-                                cflags=[ '-Werror', '-fstack-clash-protection'],
-                                mandatory=False,
-                                msg='Checking if compiler accepts -fstack-clash-protection')
-    if flag_supported:
-        conf.ADD_CFLAGS('-fstack-clash-protection')
-
     if Options.options.debug:
         conf.ADD_CFLAGS('-g', testflags=True)
 

