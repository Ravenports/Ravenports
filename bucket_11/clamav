# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		clamav
VERSION=		0.103.1
KEYWORDS=		security
VARIANTS=		standard
SDESC[standard]=	Clam Anti-Virus Scanner
HOMEPAGE=		https://www.clamav.net/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://www.clamav.net/downloads/production/
DISTFILE[1]=		clamav-0.103.1.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			primary
			docs

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		json-c:primary:standard
BUILDRUN_DEPENDS=	curl:primary:standard
			libltdl:single:standard
			libmspack:single:standard
			pcre2:primary:standard
RUN_DEPENDS=		arc:single:standard
			arj:single:standard
			unzoo:single:standard

USERS=			clamav
GROUPS=			clamav mail
USERGROUP_SPKG=		primary

USES=			cpe gmake libtool ncurses pkgconfig ssl iconv zlib
			bz2 c++:primary
GNOME_COMPONENTS=	libxml2

LICENSE=		GPLv2:primary
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_FILE=		GPLv2:{{WRKSRC}}/COPYING
LICENSE_AWK=		TERMS:"HAVE_CONFIG_H"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/clamscan/clamscan.c
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		security/clamav

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--libdir={{PREFIX}}/lib
			--enable-ipv6
			--enable-unrar
			--enable-bigstack
			--enable-clamdtop
			--with-pcre
			--with-iconv
			--with-dbdir="/var/db/clamav"
			--with-xml="{{LOCALBASE}}"
			--with-libcurl="{{LOCALBASE}}"
			--with-openssl="{{OPENSSLBASE}}"
			--with-libjson="{{LOCALBASE}}"
			--with-libjson-static="{{LOCALBASE}}/lib/libjson-c_pic.a"
			--with-system-libmspack="{{LOCALBASE}}/lib/libmspack.so"
			--disable-check
			--disable-milter

INSTALL_TARGET=		install-strip
INSTALL_REQ_TOOLCHAIN=	yes
SOVERSION=		9.0.5
PLIST_SUB=		CLAMAVGROUP=clamav
			CLAMAVUSER=clamav
			DBDIR=/var/db/clamav
			LOGDIR=/var/log/clamav
			RUNDIR=/var/run/clamav
			FRESH_SOMAJOR=2
			FRESH_SOVERSION=2.0.1
RC_SUBR=		clamav-clamd:primary
			clamav-freshclam:primary
SUB_FILES=		pkg-deinstall-primary
SUB_LIST=		CHMOD={{CHMOD}}
			CHOWN={{CHOWN}}
			CLAMAV_CLAMD_PIDFILE=/var/run/clamav/clamd.pid
			CLAMAV_CLAMD_SOCKET=/var/run/clamav/clamd.sock
			CLAMAV_MILTER_SOCKET=/var/run/clamav/clmilter.sock
			CLAMAVGROUP=clamav
			CLAMAVUSER=clamav
			DBDIR=/var/db/clamav
			LOGDIR=/var/log/clamav
			RUNDIR=/var/run/clamav

VAR_OPSYS[freebsd]=	LDFLAGS=-lthr

post-patch:
	${REINPLACE_CMD} -E -e \
		's|^\#?(Example)$$|\#\1|' -e \
		's|^\#?((Update)?LogFile) .*/([a-z]+\.log)$$|\1 /var/log/clamav/\3|' \
		-e 's|^\#?(PidFile) .*/([a-z\-]+\.pid)$$|\1 /var/run/clamav/\2|' -e \
		's|^\#?(LocalSocket) .*$$|\1 ${CLAMAV_CLAMD_SOCKET}|' -e \
		's|^\#?(User) .*$$|\1 ${CLAMAVUSER}|' -e \
		's|^\#?(AllowSupplementaryGroups).*$$|\1 yes|' -e \
		's|^\#?(ScanMail).*$$|\1 yes|' -e \
		's|^\#?(DatabaseDirectory) .*$$|\1 /var/db/clamav|' -e \
		's|^\#?(DatabaseOwner) .*$$|\1 ${CLAMAVUSER}|' -e \
		's|^\#?(FixStaleSocket).*$$|\1 yes|' -e \
		's|^\#?(NotifyClamd) .*$$|\1 ${PREFIX}/etc/clamd.conf|' -e \
		's|^\#?(MilterSocket) */tmp.*$$|\1 ${CLAMAV_MILTER_SOCKET}|' -e \
		's|^\#?(ClamdSocket).*$$|\1 unix:${CLAMAV_CLAMD_SOCKET}|' \
	${WRKSRC}/etc/clamd.conf.sample \
	${WRKSRC}/etc/freshclam.conf.sample \
	${WRKSRC}/etc/clamav-milter.conf.sample

post-install:
	${INSTALL_DATA} ${WRKSRC}/clamav-config.h ${STAGEDIR}${PREFIX}/include
	${MKDIR} ${STAGEDIR}${STD_DOCDIR}/html \
		  ${STAGEDIR}/var/db/clamav \
		  ${STAGEDIR}/var/log/clamav \
		  ${STAGEDIR}/var/run/clamav
	(cd ${WRKSRC}/docs/html && \
		${COPYTREE_SHARE} . ${STAGEDIR}${STD_DOCDIR}/html)

[FILE:317:descriptions/desc.primary]
This the stable version of Clam Antivirus.

Clam Antivirus is command line virus scanner written entirely in C
and its database is kept up to date. It also detects polymorphic
viruses, scans compressed files and supported by AMaViS.
Optionally you can use the clamav-milter interface to connect
clamav with sendmail.


[FILE:100:distinfo]
7308c47b89b268af3b9f36140528927a49ff3e633a9c9c0aac2712d81056e257     13369791 clamav-0.103.1.tar.gz


[FILE:1045:manifests/plist.primary]
@sample etc/clamd.conf.sample
@sample etc/freshclam.conf.sample
bin/
 clamav-config
 clambc
 clamconf
 clamdscan
 clamdtop
 clamscan
 clamsubmit
 freshclam
 sigtool
include/
 clamav-config.h
 clamav-types.h
 clamav-version.h
 clamav.h
 libfreshclam.h
lib/
 libclamav.so
 libclamav.so.%%SOMAJOR%%
 libclamav.so.%%SOVERSION%%
 libclamunrar.so
 libclamunrar.so.%%SOMAJOR%%
 libclamunrar.so.%%SOVERSION%%
 libclamunrar_iface.so
 libclamunrar_iface.so.%%SOMAJOR%%
 libclamunrar_iface.so.%%SOVERSION%%
 libfreshclam.so
 libfreshclam.so.%%FRESH_SOMAJOR%%
 libfreshclam.so.%%FRESH_SOVERSION%%
lib/pkgconfig/libclamav.pc
sbin/clamd
share/man/man1/
 clambc.1.gz
 clamconf.1.gz
 clamdscan.1.gz
 clamdtop.1.gz
 clamscan.1.gz
 clamsubmit.1.gz
 freshclam.1.gz
 sigtool.1.gz
share/man/man5/
 clamav-milter.conf.5.gz
 clamd.conf.5.gz
 freshclam.conf.5.gz
share/man/man8/
 clamav-milter.8.gz
 clamd.8.gz
@dir(%%CLAMAVUSER%%,%%CLAMAVGROUP%%,0755) %%DBDIR%%
@dir(%%CLAMAVUSER%%,%%CLAMAVGROUP%%,0755) %%LOGDIR%%
@dir(%%CLAMAVUSER%%,%%CLAMAVGROUP%%,0755) %%RUNDIR%%


[FILE:881:manifests/plist.docs]
share/doc/clamav/html/UserManual.html
share/doc/clamav/html/UserManual/
 Installation-Unix.html
 Installation-Windows.html
 Introduction.html
 OnAccess.html
 Signatures.html
 Usage.html
 development.html
 libclamav.html
share/doc/clamav/html/UserManual/Installation-Unix/
 Steps-Debian-Ubuntu.html
 Steps-Redhat-CentOS.html
 Steps-macOS.html
share/doc/clamav/html/UserManual/Signatures/
 AllowLists.html
 AuthenticodeRules.html
 BodySignatureFormat.html
 BytecodeSignatures.html
 ContainerMetadata.html
 DatabaseInfo.html
 DynamicConfig.html
 EncryptedArchives.html
 ExtendedSignatures.html
 FileTypeMagic.html
 FileTypes.html
 FunctionalityLevels.html
 HashSignatures.html
 LogicalSignatures.html
 PhishSigs.html
 YaraRules.html
share/doc/clamav/html/UserManual/Usage/
 Configuration.html
 Scanning.html
 SignatureManagement.html
share/doc/clamav/html/UserManual/images/demon.png


[FILE:680:patches/patch-configure]
The USES=libtool is adding dragonfly to "freebsd*)" in unwanted places.
This is an unintended side effect, avoid it by limiting to freebsd 10+.

--- configure.orig	2020-09-13 00:27:48 UTC
+++ configure
@@ -26405,7 +26405,7 @@ freebsd[45]*)
 $as_echo "#define C_BSD 1" >>confdefs.h
 
     ;;
-freebsd*)
+freebsd1*)
     if test "$have_pthreads" = "yes"; then
 	THREAD_LIBS="-lthr"
 	TH_SAFE="-thread-safe"
@@ -30081,7 +30081,7 @@ fi
 
 
 case "$host_os" in
-freebsd*)
+freebsd1*)
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for kinfo_getvmmap in -lutil" >&5
 $as_echo_n "checking for kinfo_getvmmap in -lutil... " >&6; }
 if ${ac_cv_lib_util_kinfo_getvmmap+:} false; then :


[FILE:398:patches/patch-libclamav_c++_configure]
The USES=libtool is adding dragonfly to "freebsd*)" in unwanted places.
This is an unintended side effect, avoid it by limiting to freebsd 10+.

--- libclamav/c++/configure.orig	2020-09-13 00:27:38 UTC
+++ libclamav/c++/configure
@@ -17007,7 +17007,7 @@ case "$target_os" in
 freebsd[45]*)
     THREAD_LIBS="-pthread -lc_r"
     ;;
-freebsd*)
+freebsd1*)
     THREAD_LIBS="-lthr"
     ;;
 darwin*)


[FILE:1152:files/clamav-clamd.in]
#!/bin/sh

# PROVIDE: clamav_clamd
# REQUIRE: LOGIN
# BEFORE: mail
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable clamd:
#
# clamav_clamd_enable="YES"
# clamav_clamd_flags="<set as needed>"
#
# See clamd(8) for flags
#

. /etc/rc.subr

name=clamav_clamd
rcvar=clamav_clamd_enable

# read settings, set default values
load_rc_config "$name"

: ${clamav_clamd_enable:=NO}
: ${clamav_clamd_socket="%%CLAMAV_CLAMD_SOCKET%%"}
: ${clamav_clamd_pidfile="%%CLAMAV_CLAMD_PIDFILE%%"}
: ${clamav_clamd_user="%%CLAMAVUSER%%"}

command=%%PREFIX%%/sbin/clamd
required_dirs=%%DBDIR%%
required_files=%%PREFIX%%/etc/clamd.conf

start_precmd=clamav_clamd_precmd
extra_commands=reload
reload_cmd="%%PREFIX%%/bin/clamdscan --reload"

#clamav .93 won't start without a valid main.c[vl]d file
clamav_clamd_precmd()
{
	local rundir=${clamav_clamd_pidfile%/*}
	if [ ! -d $rundir ] ; then
		install -d -m 0755 -o ${clamav_clamd_user} -g ${clamav_clamd_user} $rundir
	fi
	if [ ! -f %%DBDIR%%/main.cvd -a ! -f %%DBDIR%%/main.cld ];then
		echo "Missing %%DBDIR%%/*.cvd or *.cld files.  You must run freshclam first"
		exit 1
	fi
}

run_rc_command "$1"


[FILE:980:files/clamav-freshclam.in]
#!/bin/sh

# PROVIDE: clamav_freshclam
# REQUIRE: LOGIN clamav_clamd
# BEFORE: mail
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable the freshclam daemon:
#
# clamav_freshclam_enable="YES"
# clamav_freshclam_flags="<set as needed>"
#
# See freshclam(1) for flags
#

. /etc/rc.subr

name=clamav_freshclam
rcvar=clamav_freshclam_enable

# read settings, set default values
load_rc_config ${name}

: ${clamav_freshclam_enable:=NO}
: ${clamav_freshclam_pidfile=%%RUNDIR%%/freshclam.pid}
: ${clamav_freshclam_user=%%CLAMAVUSER%%}

command=%%PREFIX%%/bin/freshclam
pidfile=${clamav_freshclam_pidfile}
command_args="--daemon -p ${pidfile}"
required_dirs=%%DBDIR%%
required_files=%%PREFIX%%/etc/freshclam.conf

start_precmd=clamav_freshclam_precmd

clamav_freshclam_precmd()
{
	local rundir=${clamav_freshclam_pidfile%/*}
	if [ ! -d $rundir ] ; then
		install -d -m 0755 -o ${clamav_freshclam_user} -g ${clamav_freshclam_user} $rundir
	fi
}

run_rc_command "$1"


[FILE:513:files/pkg-deinstall-primary.in]
#!/bin/sh

if [ "$2" != "POST-DEINSTALL" ]; then
	exit 0
fi

CLAMAVUSER=%%CLAMAVUSER%%

echo
echo "===================================================="
echo
echo "If you want remove clamav permanently from you system"
echo "execute following commands:"
echo
echo " # rm -rf %%LOGDIR%%"
echo " # rm -rf %%RUNDIR%%"
echo " # rm -rf %%DBDIR%%"
if pw usershow "${CLAMAVUSER}" 2>/dev/null 1>&2; then
	echo " # pw userdel ${CLAMAVUSER}"
fi
echo
echo "===================================================="
echo

exit 0

