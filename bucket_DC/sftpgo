# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		sftpgo
VERSION=		2.7.0
KEYWORDS=		ftp
VARIANTS=		std
SDESC[std]=		Fully featured and highly configurable SFTP serve
HOMEPAGE=		https://sftpgo.com/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://github.com/drakkan/sftpgo/releases/download/v2.7.0/
DISTFILE[1]=		sftpgo_v2.7.0_src_with_deps.tar.xz:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		golang:single:std

USERS=			sftpgo
GROUPS=			sftpgo
USERGROUP_SPKG=		primary

EXTRACT_DIRTY=		1

LICENSE=		AGPLv3:primary CUSTOM1:primary
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_NAME=		CUSTOM1:"Additional Terms under GNU AGPL"
LICENSE_FILE=		AGPLv3:{{WRKSRC}}/LICENSE
			CUSTOM1:{{WRKSRC}}/NOTICE
LICENSE_AWK=		TERMS:"^package"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/main.go
LICENSE_SCHEME=		dual

FPC_EQUIVALENT=		ftp/sftpgo

MAKE_ENV=		GOPROXY=off
			GOFLAGS="-trimpath -mod=vendor -modcacherw"
			GO_NO_VENDOR_CHECKS=1
			GOMAXPROCS={{MAKE_JOBS_NUMBER}}
			GO_WRKSRC={{WRKSRC}}
			GOBIN={{WRKDIR}}/bin
			GO111MODULE=on

RC_SUBR=		sftpgo:primary

MOUNT_PROCFS=		yes

do-build:
	(cd ${WRKSRC} && ${SETENVI} ${MAKE_ENV} \
		go build -buildmode=exe -v -o ${WRKDIR}/bin/sftpgo)

post-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/share/sftpgo
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/bash_completion.d
	${MKDIR} ${STAGEDIR}${PREFIX}/share/fish/completions
	${MKDIR} ${STAGEDIR}${PREFIX}/share/zsh/site-functions
	cd ${WRKSRC} && \
		${COPYTREE_SHARE} templates ${STAGEDIR}${PREFIX}/share/sftpgo && \
		${COPYTREE_SHARE} static ${STAGEDIR}${PREFIX}/share/sftpgo
	${INSTALL_DATA} ${WRKSRC}/sftpgo.json ${STAGEDIR}${PREFIX}/etc/sftpgo.json.sample
	${INSTALL_DATA} ${WRKDIR}/bash_completions \
		${STAGEDIR}${PREFIX}/etc/bash_completion.d/sftpgo
	${INSTALL_DATA} ${WRKDIR}/fish_completions \
		${STAGEDIR}${PREFIX}/share/fish/completions/sftpgo.fish
	${INSTALL_DATA} ${WRKDIR}/zsh_completions \
		${STAGEDIR}${PREFIX}/share/zsh/site-functions/_sftpgo
	${FIND} ${WRKDIR}/manpages -type f -execdir \
		${INSTALL_MAN} {} ${STAGEDIR}${PREFIX}/share/man/man1 \;

post-build:
	${WRKDIR}/bin/sftpgo gen completion bash > ${WRKDIR}/bash_completions
	${WRKDIR}/bin/sftpgo gen completion fish > ${WRKDIR}/fish_completions
	${WRKDIR}/bin/sftpgo gen completion zsh > ${WRKDIR}/zsh_completions
	${MKDIR} ${WRKDIR}/manpages
	${WRKDIR}/bin/sftpgo gen man --dir ${WRKDIR}/manpages

pre-configure:
	${REINPLACE_CMD} -e 's|"templates"|"${PREFIX}/share/sftpgo/templates"|; \
		s|"static"|"${PREFIX}/share/sftpgo/static"|; \
		s|"sftpgo.db"|"/var/db/sftpgo/sftpgo.db"|' \
		${WRKSRC}/sftpgo.json

do-install:
	${INSTALL_PROGRAM} ${WRKDIR}/bin/sftpgo ${STAGEDIR}${PREFIX}/bin

[FILE:272:descriptions/desc.primary]
Fully featured and highly configurable SFTP server with optional FTP/S and
WebDAV support, written in Go. Several storage backends are supported:
local filesystem, encrypted local filesystem, S3 (compatible) Object
Storage, Google Cloud Storage, Azure Blob Storage, SFTP.


[FILE:113:distinfo]
7d70361aa52857816d2c14ff8b306429476f0864a10d99d9139b6ef1a8aaa45e     11463260 sftpgo_v2.7.0_src_with_deps.tar.xz


[FILE:3003:manifests/plist.primary]
@sample etc/sftpgo.json.sample
bin/sftpgo
etc/bash_completion.d/sftpgo
share/fish/completions/sftpgo.fish
share/sftpgo/static/favicon.png
share/sftpgo/static/assets/css/style.bundle.css
share/sftpgo/static/assets/js/scripts.bundle.js
share/sftpgo/static/assets/plugins/custom/datatables/
 datatables.bundle.css
 datatables.bundle.js
share/sftpgo/static/assets/plugins/custom/flatpickr/l10n/
 de.js
 fr.js
 it.js
share/sftpgo/static/assets/plugins/custom/formrepeater/formrepeater.bundle.js
share/sftpgo/static/assets/plugins/global/
 plugins.bundle.css
 plugins.bundle.js
share/sftpgo/static/assets/plugins/global/fonts/keenicons/
 keenicons-duotone.eot
 keenicons-duotone.svg
 keenicons-duotone.ttf
 keenicons-duotone.woff
 keenicons-outline.eot
 keenicons-outline.svg
 keenicons-outline.ttf
 keenicons-outline.woff
 keenicons-solid.eot
 keenicons-solid.svg
 keenicons-solid.ttf
 keenicons-solid.woff
share/sftpgo/static/img/
 login_image.png
 logo.png
 openid-logo.png
share/sftpgo/static/locales/de/translation.json
share/sftpgo/static/locales/en/translation.json
share/sftpgo/static/locales/fr/translation.json
share/sftpgo/static/locales/it/translation.json
share/sftpgo/static/vendor/codemirror/cm6.bundle.min.js
share/sftpgo/static/vendor/file-saver/FileSaver.min.js
share/sftpgo/static/vendor/fonts/inter/v12/
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7SUc.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7SUc.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7SUc.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7SUc.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7SUc.woff2
 UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7SUc.woff2
share/sftpgo/static/vendor/glightbox/
 glightbox.min.css
 glightbox.min.js
share/sftpgo/static/vendor/humanize-duration/humanize-duration.min.js
share/sftpgo/static/vendor/i18next/
 i18next.min.js
 i18nextBrowserLanguageDetector.min.js
 i18nextChainedBackend.min.js
 i18nextHttpBackend.min.js
 i18nextLocalStorageBackend.min.js
 jquery-i18next.min.js
share/sftpgo/static/vendor/papaparse/papaparse.min.js
share/sftpgo/static/vendor/pdfobject/pdfobject.min.js
share/sftpgo/templates/common/
 base.html
 baselogin.html
 changepassword.html
 forgot-password.html
 login.html
 message.html
 reset-password.html
 twofactor-recovery.html
 twofactor.html
share/sftpgo/templates/email/
 password-expiration.html
 reset-password.html
share/sftpgo/templates/webadmin/
 admin.html
 admins.html
 adminsetup.html
 base.html
 configs.html
 connections.html
 defender.html
 eventaction.html
 eventactions.html
 eventrule.html
 eventrules.html
 events.html
 folder.html
 folders.html
 fsconfig.html
 group.html
 groups.html
 iplist.html
 iplists.html
 maintenance.html
 mfa.html
 profile.html
 role.html
 roles.html
 status.html
 user.html
 users.html
share/sftpgo/templates/webclient/
 base.html
 editfile.html
 files.html
 mfa.html
 profile.html
 share.html
 sharedownload.html
 sharelogin.html
 shares.html
 shareupload.html
 viewpdf.html
share/zsh/site-functions/_sftpgo


[FILE:402:manifests/plist.man]
share/man/man1/
 sftpgo-acme-run.1
 sftpgo-acme.1
 sftpgo-gen-completion-bash.1
 sftpgo-gen-completion-fish.1
 sftpgo-gen-completion-powershell.1
 sftpgo-gen-completion-zsh.1
 sftpgo-gen-completion.1
 sftpgo-gen-man.1
 sftpgo-gen.1
 sftpgo-initprovider.1
 sftpgo-ping.1
 sftpgo-portable.1
 sftpgo-resetprovider.1
 sftpgo-resetpwd.1
 sftpgo-revertprovider.1
 sftpgo-serve.1
 sftpgo-smtptest.1
 sftpgo.1


[FILE:1923:files/sftpgo.in]
#!/bin/sh

# PROVIDE: sftpgo
# REQUIRE: LOGIN
# KEYWORD: shutdown
#
# Add the following line to /etc/rc.conf to enable SFTPGo:
#
# sftpgo_enable (bool):    Set to "NO" by default.
#                          Set to "YES" to enable SFTPGo.
# sftpgo_user (str):       Default to "sftpgo".
# sftpgo_group (str):      Default to "sftpgo".
#                          User and group to run SFTPGo with.
# sftpgo_flags (str):      Additional flags to append to "sftpgo serve" command.
#                          Read sftpgo(1) for more information.
# sftpgo_config (str):     Default to "%%PREFIX%%/etc/sftpgo.json".
#                          SFTPGo config directory.
# sftpgo_configdir (str):  Default to "/var/db/sftpgo".
#                          Directory for private keys, SQLite database etc.
# sftpgo_logdir (str):     Default to "/var/log/sftpgo".
#                          Directory to store sftpgo logs

. /etc/rc.subr

name=sftpgo
rcvar=sftpgo_enable
desc=SFTPGo

load_rc_config sftpgo

: ${sftpgo_enable:=NO}
: ${sftpgo_user:=sftpgo}
: ${sftpgo_group:=sftpgo}
: ${sftpgo_config=%%PREFIX%%/etc/sftpgo.json}
: ${sftpgo_configdir=/var/db/sftpgo}
: ${sftpgo_logdir=/var/log/sftpgo}

pidfile=/var/run/${name}/${name}.pid
start_precmd=sftpgo_precmd
procname="%%PREFIX%%/bin/sftpgo"
required_files="${sftpgo_config}"
command=/usr/sbin/daemon
command_args="-cf -p ${pidfile} ${procname} serve --config-dir ${sftpgo_configdir} --config-file ${sftpgo_config} --log-file-path ${sftpgo_logdir}/sftpgo.log ${sftpgo_flags}"

sftpgo_precmd()
{
    # Create PID file directory
    install -d -o ${sftpgo_user} -g ${sftpgo_group} -m 0755 "$(dirname ${pidfile})"

    install -d -o ${sftpgo_user} -g ${sftpgo_group} -m 0755 "${sftpgo_configdir}"
    install -d -o ${sftpgo_user} -g ${sftpgo_group} -m 0755 "${sftpgo_logdir}"

    # Remove default flags, they're added in `command_args` manually
    rc_flags=""
}

run_rc_command "$1"

