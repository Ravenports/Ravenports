# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		spidermonkey60
VERSION=		60.9.0
KEYWORDS=		lang
VARIANTS=		standard
SDESC[standard]=	Standalone JS interpreter from Mozilla 60-esr
HOMEPAGE=		https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey
CONTACT=		Michael_Reim[kraileth@elderlinux.org]

DOWNLOAD_GROUPS=	main
SITES[main]=		MOZILLA/firefox/releases/60.9.0esr/source
DISTFILE[1]=		firefox-60.9.0esr.source.tar.xz:main
DF_INDEX=		1
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		autoconf213:single:standard
			zip:single:standard
BUILDRUN_DEPENDS=	icu:single:standard
			nspr:single:standard

USES=			gmake perl pkgconfig python:py27,build zlib readline

DISTNAME=		firefox-60.9.0/js/src

LICENSE=		MPL:single
LICENSE_TERMS=		single:{{WRKDIR}}/TERMS
LICENSE_FILE=		MPL:stock
LICENSE_AWK=		TERMS:"^$$"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/js-config.h.in
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		lang/spidermonkey60

MUST_CONFIGURE=		yes
CONFIGURE_OUTSOURCE=	yes
CONFIGURE_ARGS=		--prefix={{PREFIX}}
			--target={{CONFIGURE_TARGET}}
			--host={{CONFIGURE_TARGET}}
			--disable-debug
			--disable-debug-symbols
			--disable-jemalloc
			--disable-replace-malloc
			--enable-readline
			--enable-release
			--enable-shared-js
			--enable-tests
			--with-intl-api
			--with-pthreads
			--with-system-nspr
			--with-system-icu
			--with-system-zlib

PLIST_SUB=		MOZJS_MAJOR=60
			MOZJS_MINOR=9

CPPFLAGS=		-Wno-class-memaccess
			-Wno-attributes
			-Wno-maybe-uninitialized

post-install:
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/bin/js60
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/lib/libmozjs-60.so

[FILE:166:descriptions/desc.single]
SpiderMonkey is Mozilla's JavaScript engine written in C and C++. It is 
used in various Mozilla products, including Firefox.

This legacy version exists for polkit.


[FILE:110:distinfo]
9f453c8cc5669e46e38f977764d49a36295bf0d023619d9aac782e6bb3e8c53f    269089044 firefox-60.9.0esr.source.tar.xz


[FILE:2789:manifests/plist.single]
%%ONLY-LINUX%%include/mozjs-%%MOZJS_MAJOR%%/mozilla/LinuxSignal.h
bin/
 js%%MOZJS_MAJOR%%
 js%%MOZJS_MAJOR%%-config
include/mozjs-%%MOZJS_MAJOR%%/
 fdlibm.h
 js-config.h
 js.msg
 jsapi.h
 jsfriendapi.h
 jsperf.h
 jspubtd.h
 jstypes.h
 malloc_decls.h
 mozjemalloc_types.h
 mozmemory.h
 mozmemory_wrap.h
include/mozjs-%%MOZJS_MAJOR%%/double-conversion/
 double-conversion.h
 utils.h
include/mozjs-%%MOZJS_MAJOR%%/js/
 AllocPolicy.h
 CallArgs.h
 CallNonGenericMethod.h
 CharacterEncoding.h
 Class.h
 Conversions.h
 Date.h
 Debug.h
 GCAPI.h
 GCAnnotations.h
 GCHashTable.h
 GCPolicyAPI.h
 GCVariant.h
 GCVector.h
 HashTable.h
 HeapAPI.h
 Id.h
 Initialization.h
 MemoryMetrics.h
 Principals.h
 Printf.h
 ProfilingFrameIterator.h
 ProfilingStack.h
 ProtoKey.h
 Proxy.h
 Realm.h
 RefCounted.h
 RequiredDefines.h
 Result.h
 RootingAPI.h
 SliceBudget.h
 Stream.h
 StructuredClone.h
 SweepingAPI.h
 TraceKind.h
 TracingAPI.h
 TrackedOptimizationInfo.h
 TypeDecls.h
 UbiNode.h
 UbiNodeBreadthFirst.h
 UbiNodeCensus.h
 UbiNodeDominatorTree.h
 UbiNodePostOrder.h
 UbiNodeShortestPaths.h
 UniquePtr.h
 Utility.h
 Value.h
 Vector.h
 WeakMapPtr.h
 Wrapper.h
include/mozjs-%%MOZJS_MAJOR%%/mozilla/
 Alignment.h
 AllocPolicy.h
 AlreadyAddRefed.h
 Array.h
 ArrayUtils.h
 Assertions.h
 Atomics.h
 Attributes.h
 AutoProfilerLabel.h
 BinarySearch.h
 BloomFilter.h
 BufferList.h
 Casting.h
 ChaosMode.h
 Char16.h
 CheckedInt.h
 Compiler.h
 Compression.h
 DebugOnly.h
 Decimal.h
 DefineEnum.h
 DoublyLinkedList.h
 EndianUtils.h
 EnumSet.h
 EnumTypeTraits.h
 EnumeratedArray.h
 EnumeratedRange.h
 FStream.h
 FastBernoulliTrial.h
 FloatingPoint.h
 GuardObjects.h
 HashFunctions.h
 IndexSequence.h
 IntegerPrintfMacros.h
 IntegerRange.h
 IntegerTypeTraits.h
 JSONWriter.h
 Likely.h
 LinkedList.h
 MacroArgs.h
 MacroForEach.h
 MathAlgorithms.h
 Maybe.h
 MaybeOneOf.h
 MemoryChecking.h
 MemoryReporting.h
 Move.h
 NotNull.h
 NullPtr.h
 Opaque.h
 OperatorNewExtensions.h
 Pair.h
 Path.h
 PlatformConditionVariable.h
 PlatformMutex.h
 PodOperations.h
 Poison.h
 Printf.h
 Range.h
 RangedArray.h
 RangedPtr.h
 ReentrancyGuard.h
 RefCountType.h
 RefCounted.h
 RefPtr.h
 Result.h
 ResultExtensions.h
 ReverseIterator.h
 RollingMean.h
 SHA1.h
 Saturate.h
 ScopeExit.h
 Scoped.h
 SegmentedVector.h
 SmallPointerArray.h
 Span.h
 SplayTree.h
 Sprintf.h
 StackWalk.h
 StaticAnalysisFunctions.h
 TaggedAnonymousMemory.h
 TemplateLib.h
 TextUtils.h
 ThreadLocal.h
 ThreadSafeWeakPtr.h
 TimeStamp.h
 ToString.h
 Tuple.h
 TypeTraits.h
 TypedEnumBits.h
 Types.h
 UniquePtr.h
 UniquePtrExtensions.h
 Unused.h
 Variant.h
 Vector.h
 WeakPtr.h
 WrappingOperations.h
 XorShift128PlusRNG.h
 fallible.h
 mozalloc.h
 mozalloc_abort.h
 mozalloc_oom.h
lib/
 libjs_static.ajs
 libmozjs-%%MOZJS_MAJOR%%.so
lib/pkgconfig/mozjs-%%MOZJS_MAJOR%%.pc


[FILE:525:patches/patch-.._.._mfbt_Poison.cpp]
--- ../../mfbt/Poison.cpp.orig	2019-09-01 13:09:47 UTC
+++ ../../mfbt/Poison.cpp
@@ -105,9 +105,9 @@ static void ReleaseRegion(void* aRegion,
 }
 
 static bool ProbeRegion(uintptr_t aRegion, uintptr_t aSize) {
-#ifdef XP_SOLARIS
-  if (posix_madvise(reinterpret_cast<void*>(aRegion), aSize,
-                    POSIX_MADV_NORMAL)) {
+#ifdef __sun__
+  //if (madvise(reinterpret_cast<caddr_t>(aRegion), aSize, MADV_NORMAL)) {
+  if (1) {
 #else
   if (madvise(reinterpret_cast<void*>(aRegion), aSize, MADV_NORMAL)) {
 #endif


[FILE:517:patches/patch-.._.._mfbt_tests_TestPoisonArea.cpp]
--- ../../mfbt/tests/TestPoisonArea.cpp.orig	2019-09-01 13:09:48 UTC
+++ ../../mfbt/tests/TestPoisonArea.cpp
@@ -269,8 +269,9 @@ ReleaseRegion(void* aPage)
 static bool
 ProbeRegion(uintptr_t aPage)
 {
-#ifdef XP_SOLARIS
-  return !!posix_madvise(reinterpret_cast<void*>(aPage), PageSize(), POSIX_MADV_NORMAL);
+#ifdef __sun__
+  //return !!madvise(reinterpret_cast<caddr_t>(aPage), PageSize(), MADV_NORMAL);
+  return !!0;
 #else
   return !!madvise(reinterpret_cast<void*>(aPage), PageSize(), MADV_NORMAL);
 #endif


[FILE:553:patches/patch-build_moz.configure_init.configure]
--- ../../build/moz.configure/init.configure.orig	2019-09-01 13:09:05 UTC
+++ ../../build/moz.configure/init.configure
@@ -637,8 +637,8 @@ def split_triplet(triplet, allow_unknown
     if cpu.endswith('86') or (cpu.startswith('i') and '86' in cpu):
         canonical_cpu = 'x86'
         endianness = 'little'
-    elif cpu in ('x86_64', 'ia64'):
-        canonical_cpu = cpu
+    elif cpu in ('x86_64', 'ia64', 'amd64'):
+        canonical_cpu = 'x86_64'
         endianness = 'little'
     elif cpu in ('s390', 's390x'):
         canonical_cpu = cpu


[FILE:1476:patches/patch-gc_Memory.cpp]
--- gc/Memory.cpp.orig	2019-09-01 13:09:17 UTC
+++ gc/Memory.cpp
@@ -18,9 +18,12 @@
 #include "util/Windows.h"
 #include <psapi.h>
 
-#elif defined(SOLARIS)
+#elif defined(__sun__)
 
 #include <sys/mman.h>
+#include <sys/stat.h>
+#include <sys/types.h>
+#include <sys/resource.h>
 #include <unistd.h>
 
 #elif defined(XP_UNIX)
@@ -419,6 +422,7 @@ static inline void* MapMemoryAt(void* de
                                 off_t offset = 0) {
 
 #if defined(__ia64__) || defined(__aarch64__) ||  \
+    (defined(__sun__) && defined(__x86_64__)) ||  \
     (defined(__sparc__) && defined(__arch64__) && \
      (defined(__NetBSD__) || defined(__linux__)))
   MOZ_ASSERT((0xffff800000000000ULL & (uintptr_t(desired) + length - 1)) == 0);
@@ -468,6 +472,7 @@ static inline void* MapMemory(size_t len
   }
   return region;
 #elif defined(__aarch64__) || \
+    (defined(__sun__) && defined(__x86_64__)) || \
     (defined(__sparc__) && defined(__arch64__) && defined(__linux__))
   /*
    * There might be similar virtual address issue on arm64 which depends on
@@ -655,8 +660,9 @@ bool MarkPagesUnused(void* p, size_t siz
   if (!DecommitEnabled()) return false;
 
   MOZ_ASSERT(OffsetFromAligned(p, pageSize) == 0);
-#if defined(XP_SOLARIS)
-  int result = posix_madvise(p, size, POSIX_MADV_DONTNEED);
+#ifdef __sun__
+  //int result = madvise(reinterpret_cast<caddr_t>(p), size, MADV_DONTNEED);
+  int result = 0;
 #else
   int result = madvise(p, size, MADV_DONTNEED);
 #endif


[FILE:366:patches/patch-python_mach_mach_mixin_process.py]
--- ../../python/mach/mach/mixin/process.py.orig	2019-09-01 13:09:52 UTC
+++ ../../python/mach/mach/mixin/process.py
@@ -26,7 +26,7 @@ elif 'MOZILLABUILD' in os.environ:
 elif 'COMSPEC' in os.environ:
     _current_shell = os.environ['COMSPEC']
 else:
-    raise Exception('Could not detect environment shell!')
+    _current_shell = "/bin/sh"
 
 _in_msys = False
 


[FILE:572:patches/patch-python_mozbuild_mozbuild_configure_____init____.py]
--- ../../python/mozbuild/mozbuild/configure/__init__.py.orig	2019-09-01 13:09:56 UTC
+++ ../../python/mozbuild/mozbuild/configure/__init__.py
@@ -421,7 +421,7 @@ class ConfigureSandbox(dict):
         # All options should have been removed (handled) by now.
         for arg in self._helper:
             without_value = arg.split('=', 1)[0]
-            raise InvalidOptionError('Unknown option: %s' % without_value)
+            print('Ignoring', without_value, ': Unknown option')
 
         # Run the execution queue
         for func, args in self._execution_queue:


[FILE:659:patches/patch-python_mozbuild_mozbuild_configure_options.py]
--- ../../python/mozbuild/mozbuild/configure/options.py.orig	2019-09-01 13:09:52 UTC
+++ ../../python/mozbuild/mozbuild/configure/options.py
@@ -420,7 +420,11 @@ class CommandLineHelper(object):
 
     def add(self, arg, origin='command-line', args=None):
         assert origin != 'default'
-        prefix, name, values = Option.split_option(arg)
+        try:
+            prefix, name, values = Option.split_option(arg)
+        except InvalidOptionError as e:
+            print('Ignoring', arg, ':', e)
+            return
         if args is None:
             args = self._extra_args
         if args is self._extra_args and name in self._extra_args:


[FILE:353:patches/patch-threading_posix_Thread.cpp]
--- threading/posix/Thread.cpp.orig	2019-09-01 13:09:20 UTC
+++ threading/posix/Thread.cpp
@@ -160,6 +160,8 @@ void js::ThisThread::SetName(const char*
   rv = 0;
 #elif defined(__NetBSD__)
   rv = pthread_setname_np(pthread_self(), "%s", (void*)name);
+#elif defined(__sun__)
+  rv = 0;
 #else
   rv = pthread_setname_np(pthread_self(), name);
 #endif


[FILE:261:patches/patch-util_NativeStack.cpp]
--- util/NativeStack.cpp.orig	2019-09-01 13:09:39 UTC
+++ util/NativeStack.cpp
@@ -30,7 +30,7 @@ void* js::GetNativeStackBaseImpl() {
   return static_cast<void*>(pTib->StackBase);
 }
 
-#elif defined(SOLARIS)
+#elif defined(__sun__)
 
 #include <ucontext.h>
 

