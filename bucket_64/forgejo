# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		forgejo
VERSION=		12.0.4
KEYWORDS=		www
VARIANTS=		std
SDESC[std]=		Painless, self-hosted Git service (GitHub-like)
HOMEPAGE=		https://forgejo.org/
CONTACT=		Michael_Reim[kraileth@elderlinux.org]

DOWNLOAD_GROUPS=	main bundles
SITES[main]=		https://codeberg.org/forgejo/forgejo/releases/download/v12.0.4/
DISTFILE[1]=		forgejo-src-12.0.4.tar.gz:main
DF_INDEX=		1
SPKGS[std]=		single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		golang:single:std
RUN_DEPENDS=		git-lfs:primary:std

USERS=			forgejo
GROUPS=			forgejo
USERGROUP_SPKG=		single

USES=			gmake

DISTNAME=		forgejo-src-12.0.4

LICENSE=		MIT:single
LICENSE_FILE=		MIT:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

MAKE_ENV=		GOFLAGS="-mod=vendor"
			TAGS="bindata sqlite sqlite_unlock_notify"

INSTALL_REQ_TOOLCHAIN=	yes
RC_SUBR=		forgejo:single
SUB_FILES=		app.ini.sample
			messages-single.ucl
SUB_LIST=		GITUSER=forgejo

MOUNT_PROCFS=		yes

post-install:
	${INSTALL_PROGRAM} ${WRKSRC}/gitea ${STAGEDIR}${PREFIX}/bin
	${LN} -s gitea ${STAGEDIR}${PREFIX}/bin/forgejo
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/forgejo/conf
	${INSTALL_DATA} ${WRKSRC}/custom/conf/app.example.ini ${STAGEDIR}${PREFIX}/etc/forgejo/conf/app.ini.examples
	${INSTALL_DATA} ${WRKDIR}/app.ini.sample ${STAGEDIR}${PREFIX}/etc/forgejo/conf/app.ini.sample

post-extract:
	${ECHO_CMD} 12.0.4 > ${WRKSRC}/VERSION

[FILE:524:descriptions/desc.single]
Forgejo is a self-hosted lightweight software forge written in Go. Easy to 
install and low maintenance, it just does the job if you're looking for an 
alternative to GitHub.

It is currently a "soft" fork of Gitea which is a fork of Gogs. Forgejo 
was started by members of the Gitea community who were unhappy that the 
leaders founded a for-profit company and acted rather intransparently in 
that regard. Other than being guaranteed to always remain Free Software, 
it puts its focus on scaling, federation and privacy.


[FILE:104:distinfo]
b1adeec3f5f446c63996250a334be62baf0cd8fbb9ad71a3316a5896cb327d08     54124346 forgejo-src-12.0.4.tar.gz


[FILE:95:manifests/plist.single]
@sample etc/forgejo/conf/app.ini.sample
bin/
 forgejo
 gitea
etc/forgejo/conf/app.ini.examples


[FILE:2653:files/app.ini.sample.in]
#
# Sample Configuration for Forgejo using SQLite
#
# For information on the available settings, consult the online
# documentation, or see the accompanying file app.ini.examples, which
# contains the settings incorporated into the gitea binary.
#
# This sample configuration runs Forgejo with a local database.  Before
# running this configuration, make sure to change the INTERNAL_TOKEN,
# JWT_SECRET, and SECRET_KEY variables.  SECRET_KEY is a password of your
# choosing, INTERNAL_TOKEN is a 64-byte random number in BASE64 encoding,
# JWT_SECRET is a 32-byte random number in BASE64 encoding.
# 
# You can generate the token using for example:
#   openssl rand -base64 64
# 
# You can let Forgejo add these to the config for you; you need to make
# app.ini writeable by the configured user (default: forgejo).
#
# There are no pre-configured users; the first user to register becomes an
# admin.  In this sample configuration, the HTTP server only listens on
# localhost.
#
# If you'd rather use the web-based installer, remove this conf/app.ini file
# and make %%PREFIX%%/etc/forgejo/conf writeable to the configured user.

APP_NAME = Gitea: Git with a cup of tea
RUN_USER = %%GITUSER%%
RUN_MODE = prod

[database]
DB_TYPE  = sqlite3
HOST     = 127.0.0.1:3306
NAME     = forgejo
PASSWD   = 
PATH     = /var/db/forgejo/forgejo.db
SSL_MODE = disable
USER     = root

[indexer]
ISSUE_INDEXER_PATH = /var/db/forgejo/indexers/issues.bleve

[log]
ROOT_PATH = /var/log/forgejo
MODE      = file
LEVEL     = Info

[mailer]
ENABLED = false

[oauth2]
JWT_SECRET = D56bmu6xCtEKs9vKKgMKnsa4X9FDwo64HVyaS4fQ4mY

[picture]
AVATAR_UPLOAD_PATH      = /var/db/forgejo/data/avatars
DISABLE_GRAVATAR        = false
ENABLE_FEDERATED_AVATAR = false

[repository]
ROOT = /var/db/forgejo/forgejo-repositories
# Forgejo's default is 'bash', so if you have bash installed, you can comment
# this out.
SCRIPT_TYPE = sh

[repository.upload]
TEMP_PATH = /var/db/forgejo/data/tmp/uploads

[security]
INSTALL_LOCK = true
INTERNAL_TOKEN = 1FFhAklka01JhgJTRUrFujWYiv4ijqcTIfXJ9o4n1fWxz+XVQdXhrqDTlsnD7fvz7gugdhgkx0FY2Lx6IBdPQw==
SECRET_KEY   = ChangeMeBeforeRunning

[session]
PROVIDER = file
PROVIDER_CONFIG = /var/db/forgejo/data/sessions

[server]
DOMAIN       = localhost
HTTP_ADDR    = 127.0.0.1
HTTP_PORT    = 3000
ROOT_URL     = http://localhost:3000/
DISABLE_SSH  = false
SSH_DOMAIN   = %(DOMAIN)s
SSH_PORT     = 22
OFFLINE_MODE = false
APP_DATA_PATH = /var/db/forgejo/data

[service]
REGISTER_EMAIL_CONFIRM = false
ENABLE_NOTIFY_MAIL     = false
DISABLE_REGISTRATION   = false
ENABLE_CAPTCHA         = true
REQUIRE_SIGNIN_VIEW    = false

[git]
PATH = %%PREFIX%%/bin/git


[FILE:1050:files/forgejo.in]
#!/bin/sh

# PROVIDE: forgejo
# REQUIRE: NETWORKING SYSLOG
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf to enable forgejo:
#
#forgejo_enable="YES"

. /etc/rc.subr

name="forgejo"
rcvar="forgejo_enable"

load_rc_config $name

: ${forgejo_user:="%%GITUSER%%"}
: ${forgejo_enable:="NO"}
: ${forgejo_facility:="daemon"}
: ${forgejo_priority:="debug"}
: ${forgejo_shared:="%%PREFIX%%/share/${name}"}
: ${forgejo_custom:="%%PREFIX%%/etc/${name}"}

command="%%PREFIX%%/bin/${name} web"
procname="%%PREFIX%%/bin/${name}"
githome="$(eval echo ~${forgejo_user})"

pidfile="/var/run/${name}.pid"

start_cmd="${name}_start"

forgejo_start() {
	for d in /var/db/forgejo /var/log/forgejo; do
		if [ ! -e "$d" ]; then
			mkdir "$d"
			chown ${forgejo_user} "$d"
		fi
	done
	/usr/sbin/daemon -f \
		-u ${forgejo_user} -p ${pidfile} \
		/usr/bin/env -i \
		"GITEA_WORK_DIR=${forgejo_shared}" \
		"GITEA_CUSTOM=${forgejo_custom}" \
		"HOME=${githome}" \
		"PATH=%%PREFIX%%/bin:${PATH}" \
		"USER=${forgejo_user}" \
		$command
}

run_rc_command "$1"


[FILE:230:files/messages-single.ucl.in]
single: {
  type: "install"
  message: <<EOM
A sample configuration using SQLite has been installed as 
%%PREFIX%%/etc/forgejo/conf/app.ini. Change according to your
needs or use as-is to quickly get Forgejo up for testing.
EOM
}

