# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		zig
VERSION=		0.10.1
KEYWORDS=		devel lang
VARIANTS=		standard
SDESC[standard]=	Programming language
HOMEPAGE=		https://ziglang.org/
CONTACT=		Tse_[tse@tse.gratis]

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/ziglang:zig:0.10.1
DISTFILE[1]=		generated:main
DF_INDEX=		1
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BROKEN[linux]=		final linking: undefined reference to `getrandom'
BROKEN[netbsd]=		The .build/zig2 build-exe command fails
ONLY_FOR_OPSYS=		freebsd dragonfly netbsd linux midnightbsd

BUILD_DEPENDS=		clang15:compiler:standard
			lld15:single:standard
			llvm15:tools:standard
			llvm15:dev:standard
BUILDRUN_DEPENDS=	clang15:dynlibs:standard

USES=			cmake ncurses execinfo zlib:build
GNOME_COMPONENTS=	libxml2

LICENSE=		MIT:single
LICENSE_FILE=		MIT:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		lang/zig

INSTALL_REQ_TOOLCHAIN=	yes

VAR_OPSYS[midnightbsd]=	MAKEFILE_LINE=CONFIGURE_TARGET=x86_64-raven-freebsd12.3

pre-build:
	${REINPLACE_CMD} \
		-e 's|@GCC_TARGET_LIBDIR@|${LOCALBASE}/toolchain/ravensys-gcc/${ASLIB}/gcc/${CONFIGURE_TARGET}/11.2.0|' \
		${WRKSRC}/src/link/Elf.zig \

pre-configure-linux:
	${REINPLACE_CMD} -e 's|EXE_LDFLAGS " "|EXE_LDFLAGS "-Wl,-rpath,${LOCALBASE}/lib "|'\
		${WRKSRC}/CMakeLists.txt

post-install:
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/bin/zig
	# remove empty directories
	${FIND} ${STAGEDIR}${PREFIX}/lib -type d -empty -delete
	# remove licenses out of place
	${RM} ${STAGEDIR}${PREFIX}/lib/zig/*/LICENSE.TXT
	${RM} ${STAGEDIR}${PREFIX}/lib/zig/libc/glibc/LICENSES
	# automatic plist for much of the manifest (influenced by clang)
	@(cd ${STAGEDIR}${PREFIX} && ${FIND} \
		lib/zig/compiler_rt \
		lib/zig/include \
		lib/zig/libc \
		lib/zig/libcxx \
		lib/zig/libcxxabi \
		lib/zig/std \
		lib/zig/tsan \
	\( -type f -o -type l \) 2>/dev/null | ${SORT}) \
	>> ${WRKDIR}/.manifest.single.mktmp

pre-configure:
	${REINPLACE_CMD} -e 's|/usr/local|${PREFIX}|g' \
		${WRKSRC}/cmake/Findclang.cmake \
		${WRKSRC}/cmake/Findllvm.cmake \
		${WRKSRC}/cmake/Findlld.cmake
	${FIND} ${WRKSRC} -name "*.orig" -delete

[FILE:94:descriptions/desc.single]
General purpose programming language designed for robustness, optimality, and maintainability


[FILE:104:distinfo]
b511709d5276eca9bd706924d7928c7477fe799ad62d5d37f5f90d7dceadfa2a     23135590 ziglang-zig-0.10.1.tar.gz


[FILE:984:manifests/plist.single]
@comment lib/zig autolist: compiler_rt, include, libc, libcxx, libcxxabi, std, tsan
bin/zig
lib/zig/
 build_runner.zig
 c.zig
 compiler_rt.zig
 ssp.zig
 test_runner.zig
 zig.h
lib/zig/docs/
 index.html
 main.js
lib/zig/init-exe/build.zig
lib/zig/init-exe/src/main.zig
lib/zig/init-lib/build.zig
lib/zig/init-lib/src/main.zig
lib/zig/libunwind/include/
 __libunwind_config.h
 libunwind.h
 unwind.h
 unwind_arm_ehabi.h
 unwind_itanium.h
lib/zig/libunwind/include/mach-o/compact_unwind_encoding.h
lib/zig/libunwind/src/
 AddressSpace.hpp
 CompactUnwinder.hpp
 DwarfInstructions.hpp
 DwarfParser.hpp
 EHHeaderParser.hpp
 FrameHeaderCache.hpp
 RWMutex.hpp
 Registers.hpp
 Unwind-EHABI.cpp
 Unwind-EHABI.h
 Unwind-seh.cpp
 Unwind-sjlj.c
 UnwindCursor.hpp
 UnwindLevel1-gcc-ext.c
 UnwindLevel1.c
 UnwindRegistersRestore.S
 UnwindRegistersSave.S
 Unwind_AIXExtras.cpp
 Unwind_AppleExtras.cpp
 assembly.h
 cet_unwind.h
 config.h
 dwarf2.h
 gcc_personality_v0.c
 libunwind.cpp
 libunwind_ext.h


[FILE:268:patches/patch-CMakeLists.txt]
--- CMakeLists.txt.orig	2023-01-17 23:40:56 UTC
+++ CMakeLists.txt
@@ -1089,6 +1089,7 @@ set(ZIG_BUILD_ARGS
     "-Dtarget=${ZIG_TARGET_TRIPLE}"
     "-Dcpu=${ZIG_TARGET_MCPU}"
     "-Dversion-string=${ZIG_VERSION}"
+    "--verbose"
 )
 
 add_custom_target(stage3 ALL


[FILE:1313:patches/patch-build.zig]
--- build.zig.orig	2023-01-17 23:40:56 UTC
+++ build.zig
@@ -609,19 +609,11 @@ fn addCmakeCfgOptionsToExe(
             .ios, .macos, .watchos, .tvos => {
                 exe.linkSystemLibrary("c++");
             },
-            .freebsd => {
-                if (static) {
-                    try addCxxKnownPath(b, cfg, exe, b.fmt("libc++.{s}", .{lib_suffix}), null, need_cpp_includes);
-                    try addCxxKnownPath(b, cfg, exe, b.fmt("libgcc_eh.{s}", .{lib_suffix}), null, need_cpp_includes);
-                } else {
-                    try addCxxKnownPath(b, cfg, exe, b.fmt("libc++.{s}", .{lib_suffix}), null, need_cpp_includes);
-                }
-            },
             .openbsd => {
                 try addCxxKnownPath(b, cfg, exe, b.fmt("libc++.{s}", .{lib_suffix}), null, need_cpp_includes);
                 try addCxxKnownPath(b, cfg, exe, b.fmt("libc++abi.{s}", .{lib_suffix}), null, need_cpp_includes);
             },
-            .netbsd, .dragonfly => {
+            .netbsd, .dragonfly, .freebsd => {
                 if (static) {
                     try addCxxKnownPath(b, cfg, exe, b.fmt("libstdc++.{s}", .{lib_suffix}), null, need_cpp_includes);
                     try addCxxKnownPath(b, cfg, exe, b.fmt("libgcc_eh.{s}", .{lib_suffix}), null, need_cpp_includes);


[FILE:424:patches/patch-lib_tsan_sanitizer__common_sanitizer__freebsd.h]
--- lib/tsan/sanitizer_common/sanitizer_freebsd.h.orig	2023-01-17 23:40:56 UTC
+++ lib/tsan/sanitizer_common/sanitizer_freebsd.h
@@ -19,8 +19,7 @@
 // x86-64 FreeBSD 9.2 and older define 'ucontext_t' incorrectly in
 // 32-bit mode.
 #if SANITIZER_FREEBSD && (SANITIZER_WORDSIZE == 32)
-#include <osreldate.h>
-#if __FreeBSD_version <= 902001  // v9.2
+#if 0
 #include <link.h>
 #include <sys/param.h>
 #include <ucontext.h>


[FILE:444:patches/patch-lib_tsan_sanitizer__common_sanitizer__linux.cpp]
--- lib/tsan/sanitizer_common/sanitizer_linux.cpp.orig	2023-01-17 23:40:56 UTC
+++ lib/tsan/sanitizer_common/sanitizer_linux.cpp
@@ -142,7 +142,7 @@ const int FUTEX_WAKE_PRIVATE = FUTEX_WAK
 # define SANITIZER_USE_GETRANDOM 0
 #endif  // SANITIZER_LINUX && defined(__NR_getrandom)
 
-#if SANITIZER_FREEBSD && __FreeBSD_version >= 1200000
+#if SANITIZER_FREEBSD
 #  define SANITIZER_USE_GETENTROPY 1
 #else
 #  define SANITIZER_USE_GETENTROPY 0


[FILE:467:patches/patch-lib_tsan_sanitizer__common_sanitizer__linux__libcdep.cpp]
--- lib/tsan/sanitizer_common/sanitizer_linux_libcdep.cpp.orig	2023-01-17 23:40:56 UTC
+++ lib/tsan/sanitizer_common/sanitizer_linux_libcdep.cpp
@@ -577,7 +577,7 @@ void GetThreadStackAndTls(bool main, upt
 
 #if !SANITIZER_FREEBSD
 typedef ElfW(Phdr) Elf_Phdr;
-#elif SANITIZER_WORDSIZE == 32 && __FreeBSD_version <= 902001  // v9.2
+#elif 0
 #define Elf_Phdr XElf32_Phdr
 #define dl_phdr_info xdl_phdr_info
 #define dl_iterate_phdr(c, b) xdl_iterate_phdr((c), (b))


[FILE:461:patches/patch-lib_tsan_sanitizer__common_sanitizer__procmaps__bsd.cpp]
--- lib/tsan/sanitizer_common/sanitizer_procmaps_bsd.cpp.orig	2023-01-17 23:40:56 UTC
+++ lib/tsan/sanitizer_common/sanitizer_procmaps_bsd.cpp
@@ -29,13 +29,6 @@
 
 #include <limits.h>
 
-// Fix 'kinfo_vmentry' definition on FreeBSD prior v9.2 in 32-bit mode.
-#if SANITIZER_FREEBSD && (SANITIZER_WORDSIZE == 32)
-#include <osreldate.h>
-#if __FreeBSD_version <= 902001 // v9.2
-#define kinfo_vmentry xkinfo_vmentry
-#endif
-#endif
 
 namespace __sanitizer {
 


[FILE:2390:patches/patch-src_link_Elf.zig]
--- src/link/Elf.zig.orig	2023-01-17 23:40:56 UTC
+++ src/link/Elf.zig
@@ -3191,19 +3191,22 @@ const CsuObjects = struct {
             const crt_dir_path = lci.crt_dir orelse return error.LibCInstallationMissingCRTDir;
             switch (link_options.target.os.tag) {
                 .dragonfly => {
+                    const gcc_dir_path = "@GCC_TARGET_LIBDIR@";
                     if (result.crt0) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
                     if (result.crti) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
                     if (result.crtn) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
 
-                    var gccv: []const u8 = undefined;
-                    if (link_options.target.os.version_range.semver.isAtLeast(.{ .major = 5, .minor = 4 }) orelse true) {
-                        gccv = "gcc80";
-                    } else {
-                        gccv = "gcc54";
-                    }
+                    if (result.crtbegin) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ gcc_dir_path, obj.* });
+                    if (result.crtend) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ gcc_dir_path, obj.* });
+                },
+                .freebsd => {
+                    const gcc_dir_path = "@GCC_TARGET_LIBDIR@";
+                    if (result.crt0) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
+                    if (result.crti) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
+                    if (result.crtn) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, obj.* });
 
-                    if (result.crtbegin) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, gccv, obj.* });
-                    if (result.crtend) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ crt_dir_path, gccv, obj.* });
+                    if (result.crtbegin) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ gcc_dir_path, obj.* });
+                    if (result.crtend) |*obj| obj.* = try fs.path.join(arena, &[_][]const u8{ gcc_dir_path, obj.* });
                 },
                 .haiku => {
                     const gcc_dir_path = lci.gcc_dir orelse return error.LibCInstallationMissingCRTDir;


[FILE:474:patches/patch-src_target.zig]
--- src/target.zig.orig	2023-01-17 23:40:56 UTC
+++ src/target.zig
@@ -448,7 +448,7 @@ pub fn libcFullLinkFlags(target: std.Tar
     // The linking order of these is significant and should match the order other
     // c compilers such as gcc or clang use.
     return switch (target.os.tag) {
-        .netbsd, .openbsd => &[_][]const u8{
+        .netbsd, .openbsd, .freebsd, .dragonfly => &[_][]const u8{
             "-lm",
             "-lpthread",
             "-lc",

