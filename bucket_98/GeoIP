# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		GeoIP
VERSION=		1.6.12
KEYWORDS=		net geography
VARIANTS=		std
SDESC[std]=		Legacy API library for geolocation queries
HOMEPAGE=		https://dev.maxmind.com/geoip/legacy/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/maxmind:geoip-api-c:v1.6.12
DISTFILE[1]=		generated:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			dev
			tools
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

EXRUN[tools]=		primary

USES=			autoreconf libtool

MUST_CONFIGURE=		gnu

INSTALL_TARGET=		install-strip
SOVERSION=		1.6.12
SUB_FILES=		messages-tools.ucl
			geoipupdate.sh

post-install:
	${MKDIR} ${STAGEDIR}${PREFIX}/share/GeoIP
	${INSTALL_SCRIPT} ${WRKDIR}/geoipupdate.sh ${STAGEDIR}${PREFIX}/bin

[FILE:112:distinfo]
99b119f8e21e94f1dfd6d49fbeed29a70df1544896e76cd456f25e397b07d476       160826 maxmind-geoip-api-c-1.6.12.tar.gz


[FILE:57:manifests/plist.primary]
lib/
 libGeoIP.so.%%SOMAJOR%%
 libGeoIP.so.%%SOVERSION%%


[FILE:84:manifests/plist.dev]
include/
 GeoIP.h
 GeoIPCity.h
lib/
 libGeoIP.a
 libGeoIP.so
lib/pkgconfig/geoip.pc


[FILE:65:manifests/plist.tools]
bin/
 geoiplookup
 geoiplookup6
 geoipupdate.sh
@dir share/GeoIP


[FILE:47:manifests/plist.man]
share/man/man1/
 geoiplookup.1
 geoiplookup6.1


[FILE:593:patches/patch-man__Makefile.am]
--- man/Makefile.am.orig	2015-04-30 04:26:22 UTC
+++ man/Makefile.am
@@ -1,4 +1,4 @@
-man_MANS = geoiplookup6.1 geoiplookup.1
+NOINST_man_MANS = geoiplookup6.1 geoiplookup.1
 
 EXTRA_DIST = geoiplookup6.1.in geoiplookup.1.in
 
@@ -20,7 +20,7 @@ CLEANFILES = geoiplookup6.1 geoiplookup.
 LOOKUP_MAN = $(mandir)/man1/geoiplookup.1
 LOOKUP6_MAN = $(mandir)/man1/geoiplookup6.1
 
-install-data-hook:
+install-data-hook: $(NOINST_man_MANS)
 	cat geoiplookup.1 | sed s,DATADIR,$(pkgdatadir), > $(DESTDIR)$(LOOKUP_MAN)
 	cat geoiplookup6.1 | sed s,DATADIR,$(pkgdatadir), > $(DESTDIR)$(LOOKUP6_MAN)
 


[FILE:1701:files/geoipupdate.sh.in]
#!/bin/sh

# You can set the following environment variables:
#
# GEOIP_DB_SERVER: The default download server is geolite.maxmind.com
# GEOIP_FETCH_CITY: If set (to anything), download the GeoLite City DB
# GEOIP_FETCH_ASN: If set, download the GeoIP ASN DB

GEOIP_DB_SERVER=${GEOIP_DB_SERVER:=geolite.maxmind.com}
GEOIP_FETCH_CITY=${GEOIP_FETCH_CITY:=}
GEOIP_FETCH_ASN=${GEOIP_FETCH_ASN:=}

set -eu
echo Fetching GeoIP.dat and GeoIPv6.dat...

# arguments:
# $1 URL
# $2 output file name
_fetch() {
    url="$1"
    out="$2"
    TEMPDIR="$(mktemp -d '%%DATADIR%%/GeoIPupdate.XXXXXX')"
    trap 'rc=$? ; set +e ; rm -rf "'"$TEMPDIR"'" ; exit $rc' 0
    if fetch -o "$TEMPDIR/$out.gz" "$url"; then
        gunzip "$TEMPDIR/$out.gz"
        chmod 444 "$TEMPDIR/$out"
        if ! mv -f "$TEMPDIR/$out" "%%DATADIR%%"/"$2"; then
            echo "Unable to replace %%DATADIR%%/$2"
            return 2
        fi
    else
        echo "$2 download failed"
        return 1
    fi
    rmdir "$TEMPDIR"
    trap - 0
    return 0
}

_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz" GeoIP.dat
_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoIPv6.dat.gz" GeoIPv6.dat

if [ -n "$GEOIP_FETCH_CITY" ]; then
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCity.dat.gz" GeoLiteCity.dat
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCityv6-beta/GeoLiteCityv6.dat.gz" GeoLiteCityv6.dat
fi
if [ -n "$GEOIP_FETCH_ASN" ]; then
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/asnum/GeoIPASNum.dat.gz" GeoIPASNum.dat
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/asnum/GeoIPASNumv6.dat.gz" GeoIPASNumv6.dat
fi


[FILE:175:files/messages-tools.ucl.in]
tools: {
  type: "install"
  message: <<EOM
GeoIP does not ship with the actual data files. You must download
them yourself! Please run:
# %%PREFIX%%/bin/geoipupdate.sh
EOM
}

