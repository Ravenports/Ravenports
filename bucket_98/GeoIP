# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		GeoIP
VERSION=		1.6.11
KEYWORDS=		net
VARIANTS=		standard
SDESC[standard]=	Legacy API library for geolocation queries
HOMEPAGE=		https://dev.maxmind.com/geoip/legacy/
CONTACT=		Jay_Leno[jay@aarp.org]

DOWNLOAD_GROUPS=	main
SITES[main]=		GITHUB/maxmind:geoip-api-c:v1.6.11
DISTFILE[1]=		generated:main
DF_INDEX=		1
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

USES=			autoreconf libtool

FPC_EQUIVALENT=		net/GeoIP

MUST_CONFIGURE=		gnu

INSTALL_TARGET=		install-strip
PLIST_SUB=		SOVERSION=1.6.11
			SOMAJOR=1
SUB_FILES=		pkg-message-single
			geoipupdate.sh

post-install:
	@${MKDIR} ${STAGEDIR}${PREFIX}/share/GeoIP
	${INSTALL_SCRIPT} ${WRKDIR}/geoipupdate.sh ${STAGEDIR}${PREFIX}/bin

[FILE:659:descriptions/desc.single]
GeoIP is a C library that enables the user to find the country that any
IP address or hostname originates from.  It uses a file based database
that is accurate as of March 2002.  This database simply contains IP blocks
as keys, and countries as values.  This database should be more complete and
accurate than using reverse DNS lookups.

This module can be used to automatically select the geographically closest
mirror, to analyze your web server logs to determine the countries of your
visitors, for credit card fraud detection, and for software export controls.

This port includes a helper script, geoipupdate.sh, to help you keep the
library up-to-date.


[FILE:112:distinfo]
8859cb7c9cb63e77f4aedb40a4622024359b956b251aba46b255acbe190c34e0       161934 maxmind-geoip-api-c-1.6.11.tar.gz


[FILE:254:manifests/plist.single]
bin/
 geoiplookup
 geoiplookup6
 geoipupdate.sh
include/
 GeoIP.h
 GeoIPCity.h
lib/
 libGeoIP.a
 libGeoIP.so
 libGeoIP.so.%%SOMAJOR%%
 libGeoIP.so.%%SOVERSION%%
lib/pkgconfig/geoip.pc
share/man/man1/
 geoiplookup.1.gz
 geoiplookup6.1.gz
@dir share/GeoIP


[FILE:593:patches/patch-man__Makefile.am]
--- man/Makefile.am.orig	2015-04-30 04:26:22 UTC
+++ man/Makefile.am
@@ -1,4 +1,4 @@
-man_MANS = geoiplookup6.1 geoiplookup.1
+NOINST_man_MANS = geoiplookup6.1 geoiplookup.1
 
 EXTRA_DIST = geoiplookup6.1.in geoiplookup.1.in
 
@@ -20,7 +20,7 @@ CLEANFILES = geoiplookup6.1 geoiplookup.
 LOOKUP_MAN = $(mandir)/man1/geoiplookup.1
 LOOKUP6_MAN = $(mandir)/man1/geoiplookup6.1
 
-install-data-hook:
+install-data-hook: $(NOINST_man_MANS)
 	cat geoiplookup.1 | sed s,DATADIR,$(pkgdatadir), > $(DESTDIR)$(LOOKUP_MAN)
 	cat geoiplookup6.1 | sed s,DATADIR,$(pkgdatadir), > $(DESTDIR)$(LOOKUP6_MAN)
 


[FILE:1701:files/geoipupdate.sh.in]
#!/bin/sh

# You can set the following environment variables:
#
# GEOIP_DB_SERVER: The default download server is geolite.maxmind.com
# GEOIP_FETCH_CITY: If set (to anything), download the GeoLite City DB
# GEOIP_FETCH_ASN: If set, download the GeoIP ASN DB

GEOIP_DB_SERVER=${GEOIP_DB_SERVER:=geolite.maxmind.com}
GEOIP_FETCH_CITY=${GEOIP_FETCH_CITY:=}
GEOIP_FETCH_ASN=${GEOIP_FETCH_ASN:=}

set -eu
echo Fetching GeoIP.dat and GeoIPv6.dat...

# arguments:
# $1 URL
# $2 output file name
_fetch() {
    url="$1"
    out="$2"
    TEMPDIR="$(mktemp -d '%%DATADIR%%/GeoIPupdate.XXXXXX')"
    trap 'rc=$? ; set +e ; rm -rf "'"$TEMPDIR"'" ; exit $rc' 0
    if fetch -o "$TEMPDIR/$out.gz" "$url"; then
        gunzip "$TEMPDIR/$out.gz"
        chmod 444 "$TEMPDIR/$out"
        if ! mv -f "$TEMPDIR/$out" "%%DATADIR%%"/"$2"; then
            echo "Unable to replace %%DATADIR%%/$2"
            return 2
        fi
    else
        echo "$2 download failed"
        return 1
    fi
    rmdir "$TEMPDIR"
    trap - 0
    return 0
}

_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz" GeoIP.dat
_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoIPv6.dat.gz" GeoIPv6.dat

if [ -n "$GEOIP_FETCH_CITY" ]; then
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCity.dat.gz" GeoLiteCity.dat
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/GeoLiteCityv6-beta/GeoLiteCityv6.dat.gz" GeoLiteCityv6.dat
fi
if [ -n "$GEOIP_FETCH_ASN" ]; then
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/asnum/GeoIPASNum.dat.gz" GeoIPASNum.dat
	_fetch "http://${GEOIP_DB_SERVER}/download/geoip/database/asnum/GeoIPASNumv6.dat.gz" GeoIPASNumv6.dat
fi


[FILE:125:files/pkg-message-single.in]
GeoIP does not ship with the actual data files. You must download
them yourself! Please run:
# %%PREFIX%%/bin/geoipupdate.sh

