# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		polari
VERSION=		49.0
REVISION=		2
KEYWORDS=		irc
VARIANTS=		std
SDESC[std]=		Internet Relay Chat client for GNOME
HOMEPAGE=		https://apps.gnome.org/Polari/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		GNOME/polari/49
DISTFILE[1]=		polari-49.0.tar.xz:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			nls

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		appstream-glib:set:std
			itstool:single:std
			gjs:dev:std
			telepathy-glib:dev:std
			tinysparql:dev:std
BUILDRUN_DEPENDS=	telepathy-glib:primary:std
			gjs:primary:std
			tinysparql:primary:std
RUN_DEPENDS=		telepathy-idle:primary:std
			telepathy-logger:primary:std
			telepathy-mission-control:primary:std
			libadwaita:primary:std
			gspell:tools:std

USES=			meson pkgconfig schemas:primary
			desktop-utils:primary
GNOME_COMPONENTS=	introspection

LICENSE=		GPLv2+:primary
LICENSE_TERMS=		primary:{{WRKDIR}}/TERMS
LICENSE_FILE=		GPLv2+:{{WRKSRC}}/LICENSES/GPL-2.0-or-later.txt
LICENSE_AWK=		TERMS:"<girepository"
LICENSE_SOURCE=		TERMS:{{WRKSRC}}/src/polari.c
LICENSE_SCHEME=		solo

FPC_EQUIVALENT=		irc/polari
GLIB_SCHEMAS=		org.gnome.Polari.gschema.xml

[FILE:387:descriptions/desc.primary]
Talk to people on IRC

A simple Internet Relay Chat (IRC) client that is designed to integrate
seamlessly with GNOME; it features a simple and beautiful interface which
allows you to focus on your conversations.

You can use Polari to publicly chat with people in a channel, and to have
private one-to-one conversations. Notifications make sure that you never
miss an important message.


[FILE:97:distinfo]
52626fde3909921ac586cc4cc10f30f123aaf6155a177ef8861ca0e55d6de850       950612 polari-49.0.tar.xz


[FILE:6019:manifests/plist.primary]
bin/polari
lib/polari/libpolari-1.0.so
lib/polari/girepository-1.0/Polari-1.0.typelib
share/applications/org.gnome.Polari.desktop
share/dbus-1/services/
 org.freedesktop.Telepathy.Client.Polari.service
 org.gnome.Polari.service
share/help/C/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/C/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/ca/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/ca/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/cs/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/cs/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/da/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/da/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/de/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/de/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/el/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/el/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/es/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/es/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/eu/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/eu/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/fr/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/fr/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/hu/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/hu/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/id/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/id/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/nl/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/nl/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/pl/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/pl/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/pt/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/pt/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/pt_BR/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/pt_BR/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/ru/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/ru/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/sv/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/sv/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/tr/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/tr/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/help/uk/polari/
 index.page
 introduction.page
 irc-commands.page
 irc-join-room.page
 irc-nick-password.page
 irc-start-conversation.page
 legal.xml
 network-connect.page
 overview.page
 sharing.page
share/help/uk/polari/images/
 Polari.png
 polari-paste.png
 polari-screenshot.png
share/icons/hicolor/scalable/apps/
 org.gnome.Polari.Devel.svg
 org.gnome.Polari.svg
share/icons/hicolor/symbolic/apps/org.gnome.Polari-symbolic.svg
share/metainfo/org.gnome.Polari.metainfo.xml
share/polari/thumbnailer.js
share/polari/gir-1.0/Polari-1.0.gir
share/telepathy/clients/Polari.client


[FILE:2426:manifests/plist.nls]
share/locale/af/LC_MESSAGES/polari.mo
share/locale/ar/LC_MESSAGES/polari.mo
share/locale/as/LC_MESSAGES/polari.mo
share/locale/be/LC_MESSAGES/polari.mo
share/locale/bg/LC_MESSAGES/polari.mo
share/locale/bs/LC_MESSAGES/polari.mo
share/locale/ca/LC_MESSAGES/polari.mo
share/locale/ca@valencia/LC_MESSAGES/polari.mo
share/locale/ckb/LC_MESSAGES/polari.mo
share/locale/cs/LC_MESSAGES/polari.mo
share/locale/da/LC_MESSAGES/polari.mo
share/locale/de/LC_MESSAGES/polari.mo
share/locale/el/LC_MESSAGES/polari.mo
share/locale/en_GB/LC_MESSAGES/polari.mo
share/locale/eo/LC_MESSAGES/polari.mo
share/locale/es/LC_MESSAGES/polari.mo
share/locale/et/LC_MESSAGES/polari.mo
share/locale/eu/LC_MESSAGES/polari.mo
share/locale/fa/LC_MESSAGES/polari.mo
share/locale/fi/LC_MESSAGES/polari.mo
share/locale/fr/LC_MESSAGES/polari.mo
share/locale/fur/LC_MESSAGES/polari.mo
share/locale/gl/LC_MESSAGES/polari.mo
share/locale/he/LC_MESSAGES/polari.mo
share/locale/hi/LC_MESSAGES/polari.mo
share/locale/hr/LC_MESSAGES/polari.mo
share/locale/hu/LC_MESSAGES/polari.mo
share/locale/id/LC_MESSAGES/polari.mo
share/locale/is/LC_MESSAGES/polari.mo
share/locale/it/LC_MESSAGES/polari.mo
share/locale/ja/LC_MESSAGES/polari.mo
share/locale/ka/LC_MESSAGES/polari.mo
share/locale/kk/LC_MESSAGES/polari.mo
share/locale/ko/LC_MESSAGES/polari.mo
share/locale/lo/LC_MESSAGES/polari.mo
share/locale/lt/LC_MESSAGES/polari.mo
share/locale/lv/LC_MESSAGES/polari.mo
share/locale/ml/LC_MESSAGES/polari.mo
share/locale/ms/LC_MESSAGES/polari.mo
share/locale/nb/LC_MESSAGES/polari.mo
share/locale/ne/LC_MESSAGES/polari.mo
share/locale/nl/LC_MESSAGES/polari.mo
share/locale/oc/LC_MESSAGES/polari.mo
share/locale/pa/LC_MESSAGES/polari.mo
share/locale/pl/LC_MESSAGES/polari.mo
share/locale/pt/LC_MESSAGES/polari.mo
share/locale/pt_BR/LC_MESSAGES/polari.mo
share/locale/ro/LC_MESSAGES/polari.mo
share/locale/ru/LC_MESSAGES/polari.mo
share/locale/sk/LC_MESSAGES/polari.mo
share/locale/sl/LC_MESSAGES/polari.mo
share/locale/sr/LC_MESSAGES/polari.mo
share/locale/sr@latin/LC_MESSAGES/polari.mo
share/locale/sv/LC_MESSAGES/polari.mo
share/locale/te/LC_MESSAGES/polari.mo
share/locale/tg/LC_MESSAGES/polari.mo
share/locale/th/LC_MESSAGES/polari.mo
share/locale/tr/LC_MESSAGES/polari.mo
share/locale/uk/LC_MESSAGES/polari.mo
share/locale/vi/LC_MESSAGES/polari.mo
share/locale/zh_CN/LC_MESSAGES/polari.mo
share/locale/zh_HK/LC_MESSAGES/polari.mo
share/locale/zh_TW/LC_MESSAGES/polari.mo


[FILE:1807:patches/patch-0001-joinDialog-Fix-detecting-pointer-devices]
From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ball=C3=B3=20Gy=C3=B6rgy?= <ballogyor@gmail.com>
Date: Fri, 30 Aug 2024 16:44:15 +0000
Subject: [PATCH] joinDialog: Fix detecting pointer devices

Gtk.get_current_event_device() is not available in GTK4.

Closes: https://gitlab.gnome.org/GNOME/polari/-/issues/209
---
 src/serverRoomManager.js | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

--- src/serverRoomManager.js.orig
+++ src/serverRoomManager.js
@@ -3,7 +3,6 @@
 //
 // SPDX-License-Identifier: GPL-2.0-or-later
 
-import Gdk from 'gi://Gdk';
 import Gio from 'gi://Gio';
 import GLib from 'gi://GLib';
 import GObject from 'gi://GObject';
@@ -179,15 +178,23 @@ class ServerRoomList extends Gtk.Box {
                 this._toggleChecked(this._list.model.get_path(iter));
         });
 
+        let pointerDeviceEvent = false;
+        const clickController = new Gtk.GestureClick();
+        clickController.connect('pressed', (_controller, _nPress, _x, _y) => {
+            pointerDeviceEvent = true;
+        });
+        this._list.add_controller(clickController);
+
         this._list.connect('row-activated', (view, path, _column) => {
             this._toggleChecked(path);
+            pointerDeviceEvent = false;
         });
 
         this._toggleRenderer.connect('toggled', (cell, pathStr) => {
             // For pointer devices, ::row-activated is emitted as well
-            const dev = Gtk.get_current_event_device();
-            if (dev && dev.input_source === Gdk.InputSource.KEYBOARD)
+            if (!pointerDeviceEvent)
                 this._toggleChecked(Gtk.TreePath.new_from_string(pathStr));
+            pointerDeviceEvent = false;
         });
 
         this._manager = ServerRoomManager.getDefault();


[FILE:3431:patches/patch-0002-mainWindow-Disconnect-event-handler-on-destroy]
From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ball=C3=B3=20Gy=C3=B6rgy?= <ballogyor@gmail.com>
Date: Wed, 13 Nov 2024 13:39:36 +0100
Subject: [PATCH] mainWindow: Disconnect event handler on destroy

Without this, it remains active when the main window is closed and
reopened, causing a crash.

Closes: https://gitlab.gnome.org/GNOME/polari/-/issues/233
---
 src/mainWindow.js | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

--- src/mainWindow.js.orig
+++ src/mainWindow.js
@@ -96,49 +96,50 @@ class MainWindow extends Adw.ApplicationWindow {
             }
         });
 
-        const app = this.application;
-        if (app.isTestInstance)
+        this._app = this.application;
+        if (this._app.isTestInstance)
             this.add_css_class('test-instance');
         if (GLib.get_application_name().toLowerCase().includes('snapshot'))
             this.add_css_class('snapshot');
 
         const actions = [{
             name: 'search',
             handler: () => this._searchButton.activate(),
         }];
         actions.forEach(a => {
-            app.lookup_action(a.name).connect('activate', a.handler);
+            this._app.lookup_action(a.name).connect('activate', a.handler);
         });
 
         this._roomStack.connect('notify::view-height',
             () => this.notify('view-height'));
 
         this._accountsMonitor = AccountsMonitor.getDefault();
         this._accountsChangedId = this._accountsMonitor.connect(
             'accounts-changed', this._onAccountsChanged.bind(this));
         this._onAccountsChanged(this._accountsMonitor);
 
         this._accountReachableId = this._accountsMonitor.connect(
             'account-reachable-changed', this._onAccountsReachableChanged.bind(this));
         this._onAccountsReachableChanged();
 
         this._roomManager = RoomManager.getDefault();
         this._roomsLoadedId = this._roomManager.connect('rooms-loaded',
             this._onRoomsLoaded.bind(this));
         this._roomRemovedId = this._roomManager.connect('room-removed',
             this._onRoomRemoved.bind(this));
         this._onRoomsLoaded();
 
         this._updateUserListLabel();
 
-        this._userListAction = app.lookup_action('user-list');
+        this._userListAction = this._app.lookup_action('user-list');
 
-        app.connect('action-state-changed::user-list', (group, name, value) => {
-            if (value.get_boolean())
-                this._userListPopover.popup();
-            else
-                this._userListPopover.popdown();
-        });
+        this._userListActionStateChangedId =
+            this._app.connect('action-state-changed::user-list', (group, name, value) => {
+                if (value.get_boolean())
+                    this._userListPopover.popup();
+                else
+                    this._userListPopover.popdown();
+            });
         this._userListPopover.connect('notify::visible', () => {
             if (!this._userListPopover.visible)
                 this._userListAction.change_state(GLib.Variant.new('b', false));
@@ -207,6 +208,8 @@ class MainWindow extends Adw.ApplicationWindow {
 
         this._roomManager.disconnect(this._roomsLoadedId);
         this._roomManager.disconnect(this._roomRemovedId);
+
+        this._app.disconnect(this._userListActionStateChangedId);
     }
 
     _onAccountsChanged() {


[FILE:2621:patches/patch-0003-Add-option-to-disable-URL-preview-feature]
From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ball=C3=B3=20Gy=C3=B6rgy?= <ballogyor@gmail.com>
Date: Wed, 13 Nov 2024 14:13:28 +0100
Subject: [PATCH] Add option to disable URL preview feature

It has security and privacy concerns.

Closes: https://gitlab.gnome.org/GNOME/polari/-/issues/133
---
 data/org.gnome.Polari.gschema.xml | 5 +++++
 data/ui/main-window.ui            | 4 ++++
 src/application.js                | 2 ++
 src/chatView.js                   | 3 ++-
 4 files changed, 13 insertions(+), 1 deletion(-)

--- data/org.gnome.Polari.gschema.xml.orig
+++ data/org.gnome.Polari.gschema.xml
@@ -36,6 +36,11 @@ SPDX-FileCopyrightText: 2015 Florian MÃ¼llner <fmuellner@gnome.or>
       <summary>Last active channel</summary>
       <description>Last active (selected) channel</description>
     </key>
+    <key type="b" name="url-preview">
+      <default>false</default>
+      <summary>URL Preview</summary>
+      <description>Show preview for URLs.</description>
+    </key>
   </schema>
 
   <schema id="org.gnome.Polari.Account">
--- data/ui/main-window.ui.orig
+++ data/ui/main-window.ui
@@ -21,6 +21,10 @@ SPDX-License-Identifier: GPL-2.0-or-later
         <attribute name="action">app.run-in-background</attribute>
         <attribute name="label" translatable="yes">Run in Background</attribute>
       </item>
+      <item>
+        <attribute name="action">app.url-preview</attribute>
+        <attribute name="label" translatable="yes">URL Preview</attribute>
+      </item>
     </section>
     <section>
       <item>
--- src/application.js.orig
+++ src/application.js
@@ -361,6 +361,8 @@ class Application extends Adw.Application {
         this._settings = new Gio.Settings({schema_id: 'org.gnome.Polari'});
         let action = this._settings.create_action('run-in-background');
         this.add_action(action);
+        action = this._settings.create_action('url-preview');
+        this.add_action(action);
 
         action = this.lookup_action('user-list');
         action.connect('notify::enabled', () => {
--- src/chatView.js.orig
+++ src/chatView.js
@@ -1305,7 +1305,8 @@ class ChatView extends Gtk.ScrolledWindow {
             this._insertWithTags(iter,
                 url.name, tags.concat(this._lookupTag('url'), tag));
 
-            if (GLib.uri_parse_scheme(url.url).startsWith('http'))
+            if (this._app._settings.get_boolean('url-preview') &&
+                GLib.uri_parse_scheme(url.url).startsWith('http'))
                 previews.push(new URLPreview({uri: url.url}));
 
             pos = url.pos + url.name.length;

