# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		pkg-bsd
VERSION=		1.10.99.7
REVISION=		2
KEYWORDS=		raven
VARIANTS=		standard
SDESC[standard]=	BSD binary package manager
HOMEPAGE=		https://github.com/freebsd/pkg/blob/master/README.md
CONTACT=		nobody

DOWNLOAD_GROUPS=	main sqlite
SITES[main]=		GITHUB/jrmarino:pkg:dec24aa
SITES[sqlite]=		https://www.sqlite.org/2018/
			http://www2.sqlite.org/2018/
DISTFILE[1]=		generated:main
DISTFILE[2]=		sqlite-autoconf-3230100.tar.gz:sqlite
DF_INDEX=		1 2
SPKGS[standard]=	shared
			static

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		libarchive-devel:static:standard
			zlib:static:standard
			bzip2:static:standard
			autoconf:single:standard
			automake:single:standard
BUILDRUN_DEPENDS=	libarchive-devel:shared:standard
B_DEPS[sunos]=		libbsd4sol:single:standard musl-fts:single:standard
BR_DEPS[linux]=		libbsd:single:standard

USES=			libtool:build

LICENSE=		BSD2CLAUSE:shared
LICENSE_SCHEME=		solo
LICENSE_FILE=		BSD2CLAUSE:{{WRKSRC}}/COPYING

FPC_EQUIVALENT=		ports-mgmt/pkg

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--disable-maintainer-mode
			--mandir={{MANPREFIX}}/man

SINGLE_JOB=		yes

INSTALL_TARGET=		install-strip
SUB_FILES=		pkg.c

CFLAGS=			-Wno-error
VAR_OPSYS[sunos]=	CFLAGS=-I{{LOCALBASE}}/include/bsd

post-patch-linux:
	${REINPLACE_CMD} -e '/libpkg_la_LDFLAGS =/ s/= /= -ldl /' \
		${WRKSRC}/libpkg/Makefile.in

pre-patch:
	${REINPLACE_CMD} -e 's/larchive/larchive-devel/' \
		${WRKSRC}/libpkg/Makefile.am \
		${WRKSRC}/tests/Makefile.am \
		${WRKSRC}/src/Makefile.am
	${REINPLACE_CMD} -e 's/\[archive\]/[archive-devel]/' \
		${WRKSRC}/configure.ac
	(cd ${WRKSRC} && ./autogen.sh)

post-install:
	${RM} ${STAGEDIR}${PREFIX}/sbin/pkg2ng
	${MV} ${STAGEDIR}${PREFIX}/lib/libpkg_static.a \
		${STAGEDIR}${PREFIX}/lib/libpkg.a
	${MV} ${STAGEDIR}${PREFIX}/sbin/pkg \
		${STAGEDIR}${PREFIX}/sbin/pkg-dynamic
	${MV} ${WRKDIR}/pkg-selector ${STAGEDIR}${PREFIX}/sbin/pkg
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/411.pkg-backup \
		${WRKSRC}/scripts/periodic/490.status-pkg-changes \
		${STAGEDIR}${PREFIX}/etc/periodic/daily/
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/460.pkg-checksum \
		${WRKSRC}/scripts/periodic/410.pkg-audit \
		${STAGEDIR}${PREFIX}/etc/periodic/security/
	${INSTALL_SCRIPT} ${WRKSRC}/scripts/periodic/400.status-pkg \
		${STAGEDIR}${PREFIX}/etc/periodic/weekly/
	${MKDIR} ${STAGEDIR}${PREFIX}/etc/pkg/repos

post-build:
	(cd ${WRKDIR} && ${CC} pkg.c -o pkg-selector)

post-extract:
	# Use a newer sqlite than the provided 3.15.2 version
	(cd ${WRKDIR}/sqlite-autoconf-3230100/ && \
		cp sqlite3.[ch] shell.c ${WRKSRC}/external/sqlite/)
	${REINPLACE_CMD} -e 's|SQLITE_CDECL main|SQLITE_CDECL sqlite3_shell|'\
		${WRKSRC}/external/sqlite/shell.c

post-patch-sunos:
	${REINPLACE_CMD} -e 's|-lutil ||' \
		${WRKSRC}/libpkg/Makefile.in \
		${WRKSRC}/tests/Makefile.in
	${REINPLACE_CMD} -e '/enable-new-dtags/d' \
		${WRKSRC}/src/Makefile.in

[FILE:297:descriptions/desc.shared]
The pkg program is the package management tool used natively on FreeBSD and
DragonFly, and has also been successfully demonstrated on NetBSD, OpenBSD,
Darwin, Solaris and its derivatives.

This package manager handles the manipulation of both locally-built and
remotely available binary packages.


[FILE:509:descriptions/desc.static]
The pkg program is the package management tool used natively on FreeBSD and
DragonFly, and has also been successfully demonstrated on NetBSD, OpenBSD,
Darwin, Solaris and its derivatives.

This package manager handles the manipulation of both locally-built and
remotely available binary packages.

This package contains just the statically-linked version (pkg-static)
and a selector program (pkg) that preferentially forks into pkg-dynamic
with the same arguments and falls back to pkg-static when not found.


[FILE:215:distinfo]
b138b5b5ba784f26fd727ffc7a4041d7608c07faca96ca29f6dcf5a1178dff32      3400346 jrmarino-pkg-dec24aa.tar.gz
92842b283e5e744eff5da29ed3c69391de7368fccc4d0ee6bf62490ce555ef25      2675362 sqlite-autoconf-3230100.tar.gz


[FILE:1048:manifests/plist.shared]
@dir etc/pkg/repos
@sample etc/pkg.conf.sample
etc/bash_completion.d/_pkg.bash
etc/periodic/daily/
 411.pkg-backup
 490.status-pkg-changes
etc/periodic/security/
 410.pkg-audit
 460.pkg-checksum
etc/periodic/weekly/400.status-pkg
include/pkg.h
lib/
 libpkg.a
 libpkg.so
 libpkg.so.4
 libpkg.so.4.0.0
libdata/pkgconfig/pkg.pc
sbin/pkg-dynamic
share/man/man3/
 pkg_printf.3.gz
 pkg_repos.3.gz
share/man/man5/
 pkg-repository.5.gz
 pkg.conf.5.gz
share/man/man8/
 pkg-add.8.gz
 pkg-alias.8.gz
 pkg-annotate.8.gz
 pkg-audit.8.gz
 pkg-autoremove.8.gz
 pkg-backup.8.gz
 pkg-check.8.gz
 pkg-clean.8.gz
 pkg-config.8.gz
 pkg-create.8.gz
 pkg-delete.8.gz
 pkg-fetch.8.gz
 pkg-info.8.gz
 pkg-install.8.gz
 pkg-lock.8.gz
 pkg-query.8.gz
 pkg-register.8.gz
 pkg-remove.8.gz
 pkg-repo.8.gz
 pkg-rquery.8.gz
 pkg-search.8.gz
 pkg-set.8.gz
 pkg-shell.8.gz
 pkg-shlib.8.gz
 pkg-ssh.8.gz
 pkg-static.8.gz
 pkg-stats.8.gz
 pkg-unlock.8.gz
 pkg-update.8.gz
 pkg-updating.8.gz
 pkg-upgrade.8.gz
 pkg-version.8.gz
 pkg-which.8.gz
 pkg.8.gz
share/zsh/site-functions/_pkg


[FILE:23:manifests/plist.static]
sbin/
 pkg
 pkg-static


[FILE:943:files/pkg.c.in]
/*
 * This program will check if %%PREFIX%%/bin/pkg-dynamic exists.
 * If it does, that program will be executed with the same arguments
 * provided to this one.  The fallback action is to execute
 * %%PREFIX/bin/pkg-static with the same arguments instead.  That
 * program is installed together with this one, so it's assumed to exist.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>


int
main(int argc, char **argv)
{
	int x;
	char *cmd;
	char *PKG_STATIC  = "%%PREFIX%%/sbin/pkg-static";
	char *PKG_DYNAMIC = "%%PREFIX%%/sbin/pkg-dynamic";

	if (access(PKG_DYNAMIC, F_OK) != -1) {
		cmd = PKG_DYNAMIC;
	} else {
		cmd = PKG_STATIC;
	}

	argv[0] = cmd;
	execv(cmd, argv);

	/*
	 * Execution failed, so write out an error message
	 */
	printf ("Command execution failed: %s", cmd);
	printf ("               arguments:");
	for (x = 1; x < argc; x++)
		printf (" %s", argv[x]);
	printf ("\n");
	exit (1);
}


[FILE:1251:sunos/patch-src_Makefile.in]
--- src/Makefile.in.orig	2017-11-29 15:11:29.492036841 +0000
+++ src/Makefile.in	2017-11-29 15:14:04.599048348 +0000
@@ -602,7 +602,7 @@
 			which.c
 
 pkg_LDADD = @OS_LDFLAGS@ $(top_builddir)/libpkg/libpkg.la \
-	$(top_builddir)/compat/libbsd_compat.la @LIBJAIL_LIB@ -lutil \
+	$(top_builddir)/compat/libbsd_compat.la @LIBJAIL_LIB@ @OS_LIBS@ \
 	-lcrypto $(am__append_5)
 pkg_CFLAGS = @OS_CFLAGS@ \
 			-I$(top_srcdir)/libpkg \
@@ -710,9 +710,18 @@
 	@rm -f pkg$(EXEEXT)
 	$(AM_V_CCLD)$(pkg_LINK) $(pkg_OBJECTS) $(pkg_LDADD) $(LIBS)
 
-pkg-static$(EXEEXT): $(pkg_static_OBJECTS) $(pkg_static_DEPENDENCIES) $(EXTRA_pkg_static_DEPENDENCIES) 
+pkg-static: $(pkg_OBJECTS) $(pkg_DEPENDENCIES) $(EXTRA_pkg_DEPENDENCIES) 
 	@rm -f pkg-static$(EXEEXT)
-	$(AM_V_CCLD)$(pkg_static_LINK) $(pkg_static_OBJECTS) $(pkg_static_LDADD) $(LIBS)
+	$(CCLD) $(pkg_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o ${.TARGET} \
+	$(pkg_OBJECTS) -pthread \
+	../libpkg/.libs/libpkg_static.a \
+	../external/.libs/libelf_static.a \
+	../compat/.libs/libbsd_compat.a \
+	-Wl,-Bstatic \
+	-lfts -lssl -lcrypto -lbsd -larchive-devel -lz -lbz2 -llzma -lzstd \
+	-Wl,-Bdynamic \
+	-lm -lrt -lresolv -lsocket -lgen \
+	-Wl,-R${prefix}/lib
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)


[FILE:922:linux/patch-src_Makefile.in]
--- src/Makefile.in.orig	2017-05-16 18:01:51 UTC
+++ src/Makefile.in
@@ -710,9 +710,18 @@ pkg$(EXEEXT): $(pkg_OBJECTS) $(pkg_DEPEN
 	@rm -f pkg$(EXEEXT)
 	$(AM_V_CCLD)$(pkg_LINK) $(pkg_OBJECTS) $(pkg_LDADD) $(LIBS)
 
-pkg-static$(EXEEXT): $(pkg_static_OBJECTS) $(pkg_static_DEPENDENCIES) $(EXTRA_pkg_static_DEPENDENCIES) 
+pkg-static: $(pkg_OBJECTS) $(pkg_DEPENDENCIES) $(EXTRA_pkg_DEPENDENCIES) 
 	@rm -f pkg-static$(EXEEXT)
-	$(AM_V_CCLD)$(pkg_static_LINK) $(pkg_static_OBJECTS) $(pkg_static_LDADD) $(LIBS)
+	$(CCLD) $(pkg_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) $(LDFLAGS) -o ${.TARGET} \
+	$(pkg_OBJECTS) -pthread \
+	../libpkg/.libs/libpkg_static.a \
+	../external/.libs/libelf_static.a \
+	../compat/.libs/libbsd_compat.a \
+	-Wl,-Bstatic \
+	-lutil -lssl -lcrypto -lbsd -lresolv -larchive-devel -lzstd -lz -lbz2 -llzma \
+	-Wl,-Bdynamic \
+	-lm \
+	-Wl,-rpath -Wl,${prefix}/lib
 
 mostlyclean-compile:
 	-rm -f *.$(OBJEXT)

