# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		opensmtpd
VERSION=		7.3.0p0
KEYWORDS=		mail
VARIANTS=		standard
SDESC[standard]=	Free implementation of server-side SMTP protocol
HOMEPAGE=		https://www.opensmtpd.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://www.opensmtpd.org/archives/
DISTFILE[1]=		opensmtpd-7.3.0p0.tar.gz:main
DF_INDEX=		1
SPKGS[standard]=	complete
			primary
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		groff:primary:standard
			libevent:dev:standard
BUILDRUN_DEPENDS=	libevent:primary:standard
			libasr:single:standard
RUN_DEPENDS=		nss:caroot:standard

USERS=			_smtpd _smtpq
GROUPS=			_smtpd _smtpq
USERGROUP_SPKG=		primary

USES=			cpe libtool ssl:libressl-devel zlib

LICENSE=		ISCL:primary
LICENSE_FILE=		ISCL:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

CPE_VENDOR=		openbsd
FPC_EQUIVALENT=		mail/opensmtpd

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--without-table-db
			--with-mantype=man
			--with-libasr={{LOCALBASE}}
			--with-libevent={{LOCALBASE}}
			--with-libssl={{OPENSSLBASE}}
			--sysconfdir={{PREFIX}}/etc/mail

RC_SUBR=		smtpd:primary
SUB_FILES=		pkg-message-primary

post-patch-dragonfly:
	${RM} -rf ${WRKSRC}/openbsd-compat/vis.h \
		${WRKSRC}/openbsd-compat/sys
	${REINPLACE_CMD} -e 's|TAILQ_FOREACH_SAFE|TAILQ_FOREACH_MUTABLE|' \
		${WRKSRC}/usr.sbin/smtpd/parse.y

post-install:
	${LN} -sf ../../sbin/smtpctl \
		${STAGEDIR}${PREFIX}/libexec/opensmtpd/makemap

[FILE:340:descriptions/desc.primary]
OpenSMTPD is a FREE implementation of the server-side SMTP protocol as
defined by RFC 5321, with some additional standard extensions. It allows
ordinary machines to exchange emails with other systems speaking the SMTP
protocol.

Started out of dissatisfaction with other implementations, OpenSMTPD is a
fairly complete SMTP implementation.


[FILE:103:distinfo]
2dd7a5a8ca127be7eb491540405684acb3dd04d93ad23d7709accd2b0450cae6       849880 opensmtpd-7.3.0p0.tar.gz


[FILE:188:manifests/plist.primary]
@sample etc/mail/smtpd.conf.sample
bin/smtp
libexec/opensmtpd/
 encrypt
 lockspool
 mail.lmtp
 mail.local
 mail.maildir
 mail.mboxfile
 mail.mda
 makemap
@(,,2555) sbin/smtpctl
sbin/smtpd


[FILE:325:manifests/plist.man]
share/man/man1/
 lockspool.1.gz
 smtp.1.gz
share/man/man5/
 aliases.5.gz
 forward.5.gz
 smtpd.conf.5.gz
 table.5.gz
share/man/man7/smtpd-filters.7.gz
share/man/man8/
 mail.lmtp.8.gz
 mail.local.8.gz
 mail.maildir.8.gz
 mail.mboxfile.8.gz
 mail.mda.8.gz
 makemap.8.gz
 newaliases.8.gz
 sendmail.8.gz
 smtpctl.8.gz
 smtpd.8.gz


[FILE:845:patches/patch-mk_smtpd_Makefile.in]
--- mk/smtpd/Makefile.in.orig	2023-06-15 08:39:48 UTC
+++ mk/smtpd/Makefile.in
@@ -1469,13 +1469,7 @@ install-exec-hook: $(CONFIGFILES) $(MANP
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)5
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)7
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)8
-
-	@if [ ! -f $(DESTDIR)$(sysconfdir)/smtpd.conf ]; then			\
-		$(INSTALL) -m 644 smtpd.conf.out $(DESTDIR)$(sysconfdir)/smtpd.conf; \
-	else									\
-		echo "$(DESTDIR)$(sysconfdir)/smtpd.conf already exists, install will not overwrite"; \
-	fi
-
+	$(INSTALL) -m 644 smtpd.conf.out	$(DESTDIR)$(sysconfdir)/smtpd.conf.sample
 	$(INSTALL) -m 644 aliases.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/aliases.5
 	$(INSTALL) -m 644 forward.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/forward.5
 	$(INSTALL) -m 644 table.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/table.5


[FILE:398:patches/patch-openbsd-compat_arc4random.c]
--- openbsd-compat/arc4random.c.orig	2023-05-09 17:50:35 UTC
+++ openbsd-compat/arc4random.c
@@ -161,6 +161,7 @@ _rs_random_u32(uint32_t *val)
 	return;
 }
 
+#if !defined(HAVE_ARC4RANDOM) && !defined(LIBRESSL_VERSION_NUMBER)
 void
 arc4random_stir(void)
 {
@@ -168,6 +169,7 @@ arc4random_stir(void)
 	_rs_stir();
 	_ARC4_UNLOCK();
 }
+#endif
 
 void
 arc4random_addrandom(u_char *dat, int datlen)


[FILE:233:patches/patch-openbsd-compat_includes.h]
--- openbsd-compat/includes.h.orig	2023-05-09 17:48:24 UTC
+++ openbsd-compat/includes.h
@@ -65,6 +65,7 @@
 #endif
 
 #include <openssl/opensslv.h> /* For OPENSSL_VERSION_NUMBER */
+#include <openssl/ssl.h>
 
 #include "defines.h"
 


[FILE:662:files/pkg-message-primary.in]
If you are upgrading from OpenSMTPD version 5.7.3 or earlier, please
follow the procedure below to update the permissions on the OpenSMTPD
spool directories:

  1. Stop 'smtpd' service:

     # %%PREFIX%%/sbin/smtpctl stop

  2. Update permissions:

     # chown -R _smtpq:wheel /var/spool/smtpd/corrupt
     # chown -R root:_smtpq /var/spool/smtpd/offline
     # chown -R _smtpq:wheel /var/spool/smtpd/purge
     # chown -R _smtpq:wheel /var/spool/smtpd/queue
     # chown -R _smtpq:wheel /var/spool/smtpd/temporary
     # chmod -R 770 /var/spool/smtpd/offline
     # chmod -R 700 /var/spool/smtpd/purge

  3. Start 'smtpd' service:

     # service smtpd start


[FILE:1220:files/smtpd.in]
#!/bin/sh
#
# PROVIDE: smtpd mail
# REQUIRE: LOGIN
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf to enable smtpd:
# smtpd_enable (bool):        Set it to "YES" to enable OpenSMTPD.
#                             Default is "NO".
# smtpd_config (string):      Path to OpenSMTPD configuration file.
#                             Default is "%%PREFIX%%/etc/mail/smtpd.conf"
# smtpd_flags (string):       Additional flags to be passed to smtpd.
#                             Default is "".
#

. /etc/rc.subr

name="smtpd"
rcvar=smtpd_enable

start_precmd="smtpd_precmd"
restart_precmd="smtpd_checkconfig"
configtest_cmd="smtpd_checkconfig"
extra_commands="configtest"

load_rc_config $name

: ${smtpd_enable:="NO"}
: ${smtpd_config:="%%PREFIX%%/etc/mail/${name}.conf"}
: ${smtpd_procname:="%%PREFIX%%/sbin/${name}"}
: ${smtpd_flags:=""}

command=${smtpd_procname}
command_args="-f ${smtpd_config} ${command_args}"
required_files="${smtpd_config}"

procname=${smtpd_procname}
pidfile="/var/run/${name}.pid"

smtpd_checkconfig()
{
    echo "Performing sanity check on smtpd configuration:"
    eval ${command} ${command_args} ${smtpd_flags} -n
}

smtpd_precmd()
{
    smtpd_checkconfig
}

run_rc_command "$1"

