# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		opensmtpd
VERSION=		7.6.0p0
KEYWORDS=		mail
VARIANTS=		std
SDESC[std]=		Free implementation of server-side SMTP protocol
HOMEPAGE=		https://www.opensmtpd.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main
SITES[main]=		https://www.opensmtpd.org/archives/
DISTFILE[1]=		opensmtpd-7.6.0p0.tar.gz:main
DF_INDEX=		1
SPKGS[std]=		set
			primary
			man

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

BUILD_DEPENDS=		groff:primary:std
			libevent:dev:std
BUILDRUN_DEPENDS=	libevent:primary:std
			libasr:single:std
RUN_DEPENDS=		nss:caroot:std

USERS=			_smtpd _smtpq
GROUPS=			_smtpd _smtpq
USERGROUP_SPKG=		primary

USES=			cpe libtool ssl:libressl-devel zlib

LICENSE=		ISCL:primary
LICENSE_FILE=		ISCL:{{WRKSRC}}/LICENSE
LICENSE_SCHEME=		solo

CPE_VENDOR=		openbsd
FPC_EQUIVALENT=		mail/opensmtpd

MUST_CONFIGURE=		gnu
CONFIGURE_ARGS=		--without-table-db
			--with-libasr={{LOCALBASE}}
			--with-libevent={{LOCALBASE}}
			--with-libssl={{OPENSSLBASE}}
			--sysconfdir={{PREFIX}}/etc/mail

MAKE_ARGS=		mansubdir=man

RC_SUBR=		smtpd:primary
SUB_FILES=		messages-primary.ucl

post-install:
	${LN} -sf ../../sbin/smtpctl \
		${STAGEDIR}${PREFIX}/libexec/opensmtpd/makemap

pre-configure:
	# --with-mantype fails for some reason
	${REINPLACE_CMD} -e 's/MANTYPE=doc/MANTYPE=man/' \
		${WRKSRC}/configure

pre-configure-dragonfly:
	${RM} -rf ${WRKSRC}/openbsd-compat/vis.h \
		${WRKSRC}/openbsd-compat/sys
	${REINPLACE_CMD} -e 's|TAILQ_FOREACH_SAFE|TAILQ_FOREACH_MUTABLE|' \
		${WRKSRC}/usr.sbin/smtpd/parse.y

[FILE:340:descriptions/desc.primary]
OpenSMTPD is a FREE implementation of the server-side SMTP protocol as
defined by RFC 5321, with some additional standard extensions. It allows
ordinary machines to exchange emails with other systems speaking the SMTP
protocol.

Started out of dissatisfaction with other implementations, OpenSMTPD is a
fairly complete SMTP implementation.


[FILE:103:distinfo]
4cc7f8caf0ba74a2932361e17dd03bd1c938178347a91c7f0c57a68a50623ce5       933054 opensmtpd-7.6.0p0.tar.gz


[FILE:188:manifests/plist.primary]
@sample etc/mail/smtpd.conf.sample
bin/smtp
libexec/opensmtpd/
 encrypt
 lockspool
 mail.lmtp
 mail.local
 mail.maildir
 mail.mboxfile
 mail.mda
 makemap
@(,,2555) sbin/smtpctl
sbin/smtpd


[FILE:292:manifests/plist.man]
share/man/man1/
 lockspool.1
 smtp.1
share/man/man5/
 aliases.5
 forward.5
 smtpd.conf.5
 table.5
share/man/man7/
 smtpd-filters.7
 smtpd-tables.7
share/man/man8/
 mail.lmtp.8
 mail.local.8
 mail.maildir.8
 mail.mboxfile.8
 mail.mda.8
 makemap.8
 newaliases.8
 sendmail.8
 smtpctl.8
 smtpd.8


[FILE:845:patches/patch-mk_smtpd_Makefile.in]
--- mk/smtpd/Makefile.in.orig	2023-11-09 09:15:21 UTC
+++ mk/smtpd/Makefile.in
@@ -2025,13 +2025,7 @@ install-exec-hook: $(CONFIGFILES) $(MANP
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)5
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)7
 	$(MKDIR_P) $(DESTDIR)$(mandir)/$(mansubdir)8
-
-	@if [ ! -f $(DESTDIR)$(sysconfdir)/smtpd.conf ]; then			\
-		$(INSTALL) -m 644 smtpd.conf.out $(DESTDIR)$(sysconfdir)/smtpd.conf; \
-	else									\
-		echo "$(DESTDIR)$(sysconfdir)/smtpd.conf already exists, install will not overwrite"; \
-	fi
-
+	$(INSTALL) -m 644 smtpd.conf.out	$(DESTDIR)$(sysconfdir)/smtpd.conf.sample
 	$(INSTALL) -m 644 aliases.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/aliases.5
 	$(INSTALL) -m 644 forward.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/forward.5
 	$(INSTALL) -m 644 table.5.out		$(DESTDIR)$(mandir)/$(mansubdir)5/table.5


[FILE:398:patches/patch-openbsd-compat_arc4random.c]
--- openbsd-compat/arc4random.c.orig	2023-09-29 15:10:20 UTC
+++ openbsd-compat/arc4random.c
@@ -155,6 +155,7 @@ _rs_random_u32(uint32_t *val)
 	return;
 }
 
+#if !defined(HAVE_ARC4RANDOM) && !defined(LIBRESSL_VERSION_NUMBER)
 void
 arc4random_stir(void)
 {
@@ -162,6 +163,7 @@ arc4random_stir(void)
 	_rs_stir();
 	_ARC4_UNLOCK();
 }
+#endif
 
 void
 arc4random_addrandom(u_char *dat, int datlen)


[FILE:714:files/messages-primary.ucl.in]
primary: {
  type: "install"
  message: <<EOM
If you are upgrading from OpenSMTPD version 5.7.3 or earlier, please
follow the procedure below to update the permissions on the OpenSMTPD
spool directories:

  1. Stop 'smtpd' service:

     # %%PREFIX%%/sbin/smtpctl stop

  2. Update permissions:

     # chown -R _smtpq:wheel /var/spool/smtpd/corrupt
     # chown -R root:_smtpq /var/spool/smtpd/offline
     # chown -R _smtpq:wheel /var/spool/smtpd/purge
     # chown -R _smtpq:wheel /var/spool/smtpd/queue
     # chown -R _smtpq:wheel /var/spool/smtpd/temporary
     # chmod -R 770 /var/spool/smtpd/offline
     # chmod -R 700 /var/spool/smtpd/purge

  3. Start 'smtpd' service:

     # service smtpd start
EOM
}


[FILE:1220:files/smtpd.in]
#!/bin/sh
#
# PROVIDE: smtpd mail
# REQUIRE: LOGIN
# KEYWORD: shutdown
#
# Add the following lines to /etc/rc.conf to enable smtpd:
# smtpd_enable (bool):        Set it to "YES" to enable OpenSMTPD.
#                             Default is "NO".
# smtpd_config (string):      Path to OpenSMTPD configuration file.
#                             Default is "%%PREFIX%%/etc/mail/smtpd.conf"
# smtpd_flags (string):       Additional flags to be passed to smtpd.
#                             Default is "".
#

. /etc/rc.subr

name="smtpd"
rcvar=smtpd_enable

start_precmd="smtpd_precmd"
restart_precmd="smtpd_checkconfig"
configtest_cmd="smtpd_checkconfig"
extra_commands="configtest"

load_rc_config $name

: ${smtpd_enable:="NO"}
: ${smtpd_config:="%%PREFIX%%/etc/mail/${name}.conf"}
: ${smtpd_procname:="%%PREFIX%%/sbin/${name}"}
: ${smtpd_flags:=""}

command=${smtpd_procname}
command_args="-f ${smtpd_config} ${command_args}"
required_files="${smtpd_config}"

procname=${smtpd_procname}
pidfile="/var/run/${name}.pid"

smtpd_checkconfig()
{
    echo "Performing sanity check on smtpd configuration:"
    eval ${command} ${command_args} ${smtpd_flags} -n
}

smtpd_precmd()
{
    smtpd_checkconfig
}

run_rc_command "$1"

