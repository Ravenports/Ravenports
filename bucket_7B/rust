# Buildsheet autogenerated by ravenadm tool -- Do not edit.

NAMEBASE=		rust
VERSION=		1.66.0
KEYWORDS=		lang
VARIANTS=		standard
SDESC[standard]=	Systems programming language from Mozilla
HOMEPAGE=		https://www.rust-lang.org/
CONTACT=		nobody

DOWNLOAD_GROUPS=	main curl dflyboot
SITES[main]=		https://static.rust-lang.org/dist/
SITES[curl]=		http://curl.haxx.se/download/
SITES[dflyboot]=	https://leaf.dragonflybsd.org/~marino/dports-src/rust/
DISTFILE[1]=		rustc-1.66.0-src.tar.xz:main
DISTFILE[2]=		rustc-1.65.0-x86_64-unknown-dragonfly.tar.zst:dflyboot
DISTFILE[3]=		rust-std-1.65.0-x86_64-unknown-dragonfly.tar.zst:dflyboot
DISTFILE[4]=		cargo-1.65.0-x86_64-unknown-dragonfly.tar.zst:dflyboot
DISTFILE[5]=		rustc-1.65.0-x86_64-unknown-freebsd.tar.gz:main
DISTFILE[6]=		rust-std-1.65.0-x86_64-unknown-freebsd.tar.gz:main
DISTFILE[7]=		cargo-1.65.0-x86_64-unknown-freebsd.tar.gz:main
DISTFILE[8]=		rustc-1.65.0-x86_64-unknown-linux-gnu.tar.gz:main
DISTFILE[9]=		rust-std-1.65.0-x86_64-unknown-linux-gnu.tar.gz:main
DISTFILE[10]=		cargo-1.65.0-x86_64-unknown-linux-gnu.tar.gz:main
DISTFILE[11]=		rustc-1.65.0-x86_64-unknown-netbsd.tar.gz:main
DISTFILE[12]=		rust-std-1.65.0-x86_64-unknown-netbsd.tar.gz:main
DISTFILE[13]=		cargo-1.65.0-x86_64-unknown-netbsd.tar.gz:main
DISTFILE[14]=		curl-7.87.0.tar.xz:main
DF_INDEX=		1 14
SPKGS[standard]=	single

OPTIONS_AVAILABLE=	none
OPTIONS_STANDARD=	none

ONLY_FOR_OPSYS=		dragonfly freebsd linux netbsd

BUILD_DEPENDS=		bash:primary:standard
			cmake:single:standard
			ncurses:primary:standard
			nss:caroot:standard
EXRUN[single]=		ravensys-gcc:compilers:standard

USES=			cpe gmake zlib:build python:build shebangfix
			execinfo:build c++:single dos2unix ssl:build

DISTNAME=		rustc-1.66.0-src
EXTRACT_ONLY=		1 14

LICENSE=		APACHE20:single MIT:single
LICENSE_TERMS=		single:{{WRKSRC}}/COPYRIGHT
LICENSE_FILE=		APACHE20:{{WRKSRC}}/LICENSE-APACHE
			MIT:{{WRKSRC}}/LICENSE-MIT
LICENSE_SCHEME=		dual

CPE_VENDOR=		rust-lang
DOS2UNIX_FILES=		vendor/openssl-probe/src/lib.rs
FPC_EQUIVALENT=		lang/rust
SHEBANG_FILES=		src/llvm-project/compiler-rt/lib/sanitizer_common/symbolizer/scripts/*.sh
			src/llvm-project/compiler-rt/lib/asan/scripts/asan_device_setup
			src/llvm-project/compiler-rt/lib/tsan/*.sh
			src/llvm-project/compiler-rt/lib/fuzzer/scripts/*.py
			src/llvm-project/compiler-rt/lib/dfsan/scripts/build-libc-list.py
			src/llvm-project/compiler-rt/lib/sanitizer_common/scripts/*.py
			src/llvm-project/compiler-rt/lib/asan/scripts/asan_symbolize.py
			library/core/src/unicode/printable.py
			library/backtrace/ci/debuglink.sh

MUST_CONFIGURE=		yes
CONFIGURE_ARGS=		--release-channel=stable
			--enable-rpath
			--enable-extended
			--enable-vendor
			--enable-locked-deps
			--local-rust-root={{WRKDIR}}/bootstrap
			--prefix={{PREFIX}}
			--disable-ninja
			--default-linker={{LOCALBASE}}/toolchain/ravensys-gcc/bin/cc

MAKE_ENV=		LD_LIBRARY_PATH={{WRKDIR}}/bootstrap/lib
			LIBSSH2_SYS_USE_PKG_CONFIG=1
			OPENSSL_NO_PKG_CONFIG=1
			RUST_BACKTRACE=1
			PROFILE=release
			OPENSSL_DIR="{{OPENSSLBASE}}"
			HOME="{{WRKDIR}}"

INSTALL_REQ_TOOLCHAIN=	yes

VAR_OPSYS[freebsd]=	MAKEFILE_LINE=BOOTSTRAP_RUST=1.65.0
			MAKEFILE_LINE=BOOTSTRAP_CARGO=1.65.0
VAR_OPSYS[linux]=	MAKEFILE_LINE=BOOTSTRAP_RUST=1.65.0
			MAKEFILE_LINE=BOOTSTRAP_CARGO=1.65.0
VAR_OPSYS[netbsd]=	MAKEFILE_LINE=BOOTSTRAP_RUST=1.65.0
			MAKEFILE_LINE=BOOTSTRAP_CARGO=1.65.0
VAR_OPSYS[dragonfly]=	MAKEFILE_LINE=BOOTSTRAP_RUST=1.65.0
			MAKEFILE_LINE=BOOTSTRAP_CARGO=1.65.0

pre-build:
	${MKDIR} ${WRKDIR}/bootstrap
	# Extract OS-specific bootstrap components
	# then install bootstrap components
	for F in ${SRC_RUSTC} ${SRC_RUSTSTD} ${SRC_CARGO}; do\
	   ${TAR} -C ${WRKDIR} -xf ${DISTDIR}/$$F.tar.${COMPEXT}\
	     --no-same-owner --no-same-permissions;\
	   ${LOCALBASE}/bin/bash ${WRKDIR}/$$F/install.sh\
	     --prefix=${WRKDIR}/bootstrap;\
	done

pre-build-freebsd:
	${LN} -s ${LOCALBASE}/toolchain/ravensys-gcc/lib/libstdc++.so \
	${LOCALBASE}/lib/libc++.so

pre-build-linux:
	${LN} -s ${LOCALBASE}/lib/libz.so.1 ${WRKDIR}/bootstrap/lib

do-build:
	(cd ${BUILD_WRKSRC} && ${SETENV} ${MAKE_ENV} \
		${PYTHON_CMD} x.py build --verbose --config ./config.toml \
		--jobs ${MAKE_JOBS_NUMBER})

post-install:
	${RM} ${STAGEDIR}${PREFIX}/lib/rustlib/install.log
	${RM} ${STAGEDIR}${PREFIX}/lib/rustlib/uninstall.sh
	${RM} -r ${STAGEDIR}${PREFIX}/share/doc/rust
	# Taken from FreeBSD Ports
	# In post-install, we use the manifests generated during Rust install
	# to in turn generate the PLIST. We do that because several libraries
	# have a computed filename based on the absolute path of the source
	# files. As it is user-specific, we can't know the filename in advance.
	#
	# Both rustc and Cargo components install the same README.md and
	# LICENSE files. The install process backs up the first copy to
	# install the second. Thus here, we need to remove those backups.
	# Actually we remove the entire share/doc/rust contents.
	# We also need to dedup the entries in the generated PLIST, because
	# both components manifests list them.
	#
	# We fix manpage entries in the generated manifests because Rust
	# installs them uncompressed but the Ports framework compresses them.
	for f in ${STAGEDIR}${PREFIX}/lib/rustlib/manifest-*; do \
	    ${SED} -i'' -E \
		-e '/share\/doc\/rust/d' \
	        -e 's|:${STAGEDIR}|:|' \
	        -e 's|(man/man[1-9]/.*\.[0-9])|\1.gz|' \
	        $$f; \
	    ${AWK} '\
	        /^file:/ { \
	            file=$$0; \
	            sub(/^file:/, "", file); \
	            print file; \
	        } \
	        /^dir:/ { \
	            dir=$$0; \
	            sub(/^dir:/, "", dir); \
	            system("find ${STAGEDIR}" dir " -type f | ${SED} -E -e \"s|${STAGEDIR}||\""); \
	        }' \
	        $$f >> ${WRKDIR}/.manifest.gen.unsorted; \
	    ${RM} $$f; \
	done
	${SORT} -u ${WRKDIR}/.manifest.gen.unsorted > ${WRKDIR}/.manifest.gen.sorted
	${CAT} ${WRKDIR}/.manifest.gen.sorted >> ${WRKDIR}/.manifest.single.mktmp
	# Strip binaries and libraries
	${STRIP_CMD} \
		${STAGEDIR}${PREFIX}/bin/cargo \
		${STAGEDIR}${PREFIX}/bin/cargo-clippy \
		${STAGEDIR}${PREFIX}/bin/cargo-fmt \
		${STAGEDIR}${PREFIX}/bin/clippy-driver \
		${STAGEDIR}${PREFIX}/bin/rustc \
		${STAGEDIR}${PREFIX}/bin/rustdoc \
		${STAGEDIR}${PREFIX}/bin/rustfmt \
		${STAGEDIR}${PREFIX}/bin/rust-analyzer \
		${STAGEDIR}${PREFIX}/bin/rust-demangler \
		${STAGEDIR}${PREFIX}/libexec/cargo-credential-1password \
		${STAGEDIR}${PREFIX}/libexec/rust-analyzer-proc-macro-srv \
		${STAGEDIR}${PREFIX}/lib/*.so \
		${STAGEDIR}${PREFIX}/lib/rustlib/*/lib/*.so

pre-configure:
	# Use rpath suitable for libz et al.
	${REINPLACE_CMD} -e 's|@PREFIX@|${PREFIX}|g' \
		-e 's|@OPENSSLLIB@|${OPENSSLLIB}|g' \
		${WRKSRC}/src/bootstrap/builder.rs
	# Disable vendor checksums
	${REINPLACE_CMD} -e 's/"files":{[^}]*}/"files":{}/' \
		 ${WRKSRC}/vendor/*/.cargo-checksum.json
	# Enable rust to find certificates
	${REINPLACE_CMD} -e 's|@PREFIX@|${PREFIX}|' \
		${WRKSRC}/vendor/openssl-probe/src/lib.rs
	# remove link to shared libressl, execinfo and zlib
	# replace static versions with PIC versions
	(cd ${LOCALBASE}/libressl/lib \
		&& ${CP} libssl_pic.a libssl.a \
		&& ${CP} libcrypto_pic.a libcrypto.a \
		&& ${CP} libtls_pic.a libtls.a \
		&& ${RM} lib*.so)
	(cd ${LOCALBASE}/lib \
		&& ${CP} libexecinfo_pic.a libexecinfo.a \
		&& ${CP} libz_pic.a libz.a \
		&& ${RM} libexecinfo.so \
		&& ${RM} libz.so)
	# build curl here.
	${SH} ${FILESDIR}/build_curl.sh "${PREFIX}" "${CONFIGURE_TARGET}"
	(cd ${WRKDIR}/curl-* && ${MAKE_CMD})
	${INSTALL_DATA} ${WRKDIR}/curl-7.87.0/lib/.libs/libcurl.a \
		${LOCALBASE}/lib/

post-build-freebsd:
	${RM} ${LOCALBASE}/lib/libc++.so

pre-build-netbsd:
	${LN} -s ${LOCALBASE}/toolchain/ravensys-gcc/lib/libgcc_s.so.1 \
	${WRKDIR}/bootstrap/lib/libgcc_s.so.1

do-install:
	(cd ${BUILD_WRKSRC} && ${SETENV} ${MAKE_ENV} DESTDIR=${STAGEDIR} \
		${PYTHON_CMD} x.py install --verbose --config ./config.toml \
		--jobs ${MAKE_JOBS_NUMBER})

pre-build-dragonfly:
	${LN} -s ${LOCALBASE}/toolchain/ravensys-gcc/lib/libgcc_s.so \
	${WRKDIR}/bootstrap/lib/rustlib/${SFX}/lib/libgcc_pic.so

[FILE:753:descriptions/desc.single]
Rust is a systems programming language that runs blazingly fast, prevents
segfaults, and guarantees thread safety.

Performance
Rust is blazingly fast and memory-efficient: with no runtime or garbage
collector, it can power performance-critical services, run on embedded
devices, and easily integrate with other languages.

Reliability
Rust's rich type system and ownership model guarantee memory-safety and
thread-safety -- and enable you to eliminate many classes of bugs at
compile-time.

Productivity
Rust has great documentation, a friendly compiler with useful error
messages, and top-notch tooling -- an integrated package manager and
build tool, smart multi-editor support with auto-completion and type
inspections, an auto-formatter, and more.


[FILE:1675:distinfo]
0dc176e34fae9871f855a6ba4cb30fa19d69c5b4428d29281a07419c4950715c    141582844 rustc-1.66.0-src.tar.xz
010ac480c460865910e3edc6db924a263af12bd530cd956ed4a0e36ea9611246     55946169 rustc-1.65.0-x86_64-unknown-dragonfly.tar.zst
64e560077e8a2c3ad7d9cf29d114754be67d058f7bceed1d854a06efbe6e72c1     35130504 rust-std-1.65.0-x86_64-unknown-dragonfly.tar.zst
3c22303cd0e9e10be3c68106c536cb0545554cb2cd84809fc2e9880ae5eb73ae      5769929 cargo-1.65.0-x86_64-unknown-dragonfly.tar.zst
e6104c86d66a19527c48e4e533c28e1b7b74cd2c4e3dfc3eba139c4b152ea121    124191245 rustc-1.65.0-x86_64-unknown-freebsd.tar.gz
eab943166d86021dad01e65a2f304fcc2914d48e34bcba9f710f362401770e0a     47971940 rust-std-1.65.0-x86_64-unknown-freebsd.tar.gz
a896973695382f4c622b98544f6126c088b21d6a625c129131b113ac36d777a8      9729237 cargo-1.65.0-x86_64-unknown-freebsd.tar.gz
6a30ffca17a244ad6bfb1d257572155f4e2b08d3ca2d852c2fc7420e264c6baa     88820470 rustc-1.65.0-x86_64-unknown-linux-gnu.tar.gz
8c194b0e3814efecb87fc4779767ef17d25399fbd476dbfc92f9a7f88b98f784     49616647 rust-std-1.65.0-x86_64-unknown-linux-gnu.tar.gz
f7d67cf3b34a7d82fa2b22d42ad2aed20ee8f4be95ab97f88b8bf03a397217c2      9553293 cargo-1.65.0-x86_64-unknown-linux-gnu.tar.gz
5af04405b78b7a4062e163b7926014fda0a7ef851d75ed50bcaf3f472c277028     95887188 rustc-1.65.0-x86_64-unknown-netbsd.tar.gz
d0405e239dff6b7d840a5a6e45f60c7f661fd428d5a310b25e44de4e7fcb8eec     44824234 rust-std-1.65.0-x86_64-unknown-netbsd.tar.gz
fc41c57eabf4a601bdfd78b8586f0e639404305ca0b61ad62284be4623394de3      9692185 cargo-1.65.0-x86_64-unknown-netbsd.tar.gz
ee5f1a1955b0ed413435ef79db28b834ea5f0fb7c8cfb1ce47175cc3bee08fff      2547932 curl-7.87.0.tar.xz


[FILE:96:manifests/plist.single]
@comment generated from lib/rustlib/manifest-*
lib/rustlib/
 components
 rust-installer-version


[FILE:972:patches/patch-compiler_rustc__llvm_build.rs]
--- compiler/rustc_llvm/build.rs.orig	2022-12-12 16:02:12 UTC
+++ compiler/rustc_llvm/build.rs
@@ -323,23 +323,7 @@ fn main() {
     }
 
     let llvm_static_stdcpp = tracked_env_var_os("LLVM_STATIC_STDCPP");
-    let llvm_use_libcxx = tracked_env_var_os("LLVM_USE_LIBCXX");
-
-    let stdcppname = if target.contains("openbsd") {
-        if target.contains("sparc64") { "estdc++" } else { "c++" }
-    } else if target.contains("darwin")
-        || target.contains("freebsd")
-        || target.contains("windows-gnullvm")
-    {
-        "c++"
-    } else if target.contains("netbsd") && llvm_static_stdcpp.is_some() {
-        // NetBSD uses a separate library when relocation is required
-        "stdc++_pic"
-    } else if llvm_use_libcxx.is_some() {
-        "c++"
-    } else {
-        "stdc++"
-    };
+    let stdcppname = "stdc++";
 
     // RISC-V GCC erroneously requires libatomic for sub-word
     // atomic operations. Some BSD uses Clang as its system


[FILE:542:patches/patch-library_unwind_build.rs]
--- library/unwind/build.rs.orig	2022-12-12 16:02:12 UTC
+++ library/unwind/build.rs
@@ -36,7 +36,7 @@ fn main() {
     } else if target.contains("illumos") {
         println!("cargo:rustc-link-lib=gcc_s");
     } else if target.contains("dragonfly") {
-        println!("cargo:rustc-link-lib=gcc_pic");
+        println!("cargo:rustc-link-lib=gcc_s");
     } else if target.ends_with("pc-windows-gnu") {
         // This is handled in the target spec with late_link_args_[static|dynamic]
     } else if target.contains("uwp-windows-gnu") {


[FILE:1517:patches/patch-missing-miri]
From e5c92bc2b6f0bd69856ad3c4d3056c7f0c0ad72d Mon Sep 17 00:00:00 2001
From: Oli Scherer <git-spam-no-reply9815368754983@oli-obk.de>
Date: Mon, 19 Dec 2022 14:48:45 +0000
Subject: [PATCH] Don't panic on stable since miri is not available there

---
 src/bootstrap/install.rs | 12 ++++++++----
 1 file changed, 8 insertions(+), 4 deletions(-)
index c53d0d7e4cb7c..1815a0973072b 100644
--- src/bootstrap/install.rs.orig	2022-12-12 16:02:12 UTC
+++ src/bootstrap/install.rs
@@ -200,10 +200,14 @@ install!((self, builder, _config),
         install_sh(builder, "clippy", self.compiler.stage, Some(self.target), &tarball);
     };
     Miri, alias = "miri", Self::should_build(_config), only_hosts: true, {
-        let tarball = builder
-            .ensure(dist::Miri { compiler: self.compiler, target: self.target })
-            .expect("missing miri");
-        install_sh(builder, "miri", self.compiler.stage, Some(self.target), &tarball);
+        if let Some(tarball) = builder.ensure(dist::Miri { compiler: self.compiler, target: self.target }) {
+            install_sh(builder, "miri", self.compiler.stage, Some(self.target), &tarball);
+        } else {
+            // Miri is only available on nightly
+            builder.info(
+                &format!("skipping Install miri stage{} ({})", self.compiler.stage, self.target),
+            );
+        }
     };
     Rustfmt, alias = "rustfmt", Self::should_build(_config), only_hosts: true, {
         if let Some(tarball) = builder.ensure(dist::Rustfmt {


[FILE:758:patches/patch-src_bootstrap_builder.rs]
--- src/bootstrap/builder.rs.orig	2022-12-12 16:02:12 UTC
+++ src/bootstrap/builder.rs
@@ -1711,12 +1711,13 @@ impl<'a> Builder<'a> {
                 Some("-Wl,-rpath,@loader_path/../lib")
             } else if !target.contains("windows") {
                 rustflags.arg("-Clink-args=-Wl,-z,origin");
-                Some("-Wl,-rpath,$ORIGIN/../lib")
+                Some("-Wl,-rpath,$ORIGIN/../lib:@OPENSSLLIB@")
             } else {
                 None
             };
             if let Some(rpath) = rpath {
-                rustflags.arg(&format!("-Clink-args={}", rpath));
+                rustflags.arg(&format!("-Clink-arg={}", "-Wl,-z,origin"));
+                rustflags.arg(&format!("-Clink-arg={}", rpath));
             }
         }
 


[FILE:714:patches/patch-vendor_libc-0.2.126_src_unix_bsd_freebsdlike_dragonfly_mod.rs]
--- vendor/libc-0.2.126/src/unix/bsd/freebsdlike/dragonfly/mod.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/libc-0.2.126/src/unix/bsd/freebsdlike/dragonfly/mod.rs
@@ -387,8 +387,8 @@ s_no_extra_traits! {
         pub d_fileno: ::ino_t,
         pub d_namlen: u16,
         pub d_type: u8,
-        __unused1: u8,
-        __unused2: u32,
+        pub d_unused1: u8,
+        pub d_unused2: u32,
         pub d_name: [::c_char; 256],
     }
 
@@ -846,6 +846,7 @@ cfg_if! {
 
 pub const RAND_MAX: ::c_int = 0x7fff_ffff;
 pub const PTHREAD_STACK_MIN: ::size_t = 16384;
+pub const CPU_SETSIZE: ::c_int = 256;
 pub const SIGSTKSZ: ::size_t = 40960;
 pub const SIGCKPT: ::c_int = 33;
 pub const SIGCKPTEXIT: ::c_int = 34;


[FILE:476:patches/patch-vendor_libc_src_unix_bsd_freebsdlike_dragonfly_errno.rs]
--- vendor/libc/src/unix/bsd/freebsdlike/dragonfly/errno.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/libc/src/unix/bsd/freebsdlike/dragonfly/errno.rs
@@ -1,7 +1,6 @@
 // DragonFlyBSD's __error function is declared with "static inline", so it must
 // be implemented in the libc crate, as a pointer to a static thread_local.
 f! {
-    #[deprecated(since = "0.2.77", note = "Use `__errno_location()` instead")]
     pub fn __error() -> *mut ::c_int {
         &mut errno
     }


[FILE:424:patches/patch-vendor_libc_src_unix_bsd_freebsdlike_dragonfly_mod.rs]
--- vendor/libc/src/unix/bsd/freebsdlike/dragonfly/mod.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/libc/src/unix/bsd/freebsdlike/dragonfly/mod.rs
@@ -442,8 +442,8 @@ s_no_extra_traits! {
         pub d_fileno: ::ino_t,
         pub d_namlen: u16,
         pub d_type: u8,
-        __unused1: u8,
-        __unused2: u32,
+        pub d_unused1: u8,
+        pub d_unused2: u32,
         pub d_name: [::c_char; 256],
     }
 


[FILE:459:patches/patch-vendor_libssh2-sys_libssh2_src_openssl.h]
--- vendor/libssh2-sys/libssh2/src/openssl.h.orig	2022-12-12 18:23:58 UTC
+++ vendor/libssh2-sys/libssh2/src/openssl.h
@@ -57,8 +57,9 @@
 #include <openssl/pem.h>
 #include <openssl/rand.h>
 
-#if OPENSSL_VERSION_NUMBER >= 0x10100000L && \
-    !defined(LIBRESSL_VERSION_NUMBER)
+#if (OPENSSL_VERSION_NUMBER >= 0x10100000L && \
+    !defined(LIBRESSL_VERSION_NUMBER)) || \
+    LIBRESSL_VERSION_NUMBER >= 0x3050000fL
 # define HAVE_OPAQUE_STRUCTS 1
 #endif
 


[FILE:436:patches/patch-vendor_openssl-probe_src_lib.rs]
--- vendor/openssl-probe/src/lib.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/openssl-probe/src/lib.rs
@@ -26,10 +26,7 @@ fn cert_dirs_iter() -> impl Iterator<Ite
     [
         "/var/ssl",
         "/usr/share/ssl",
-        "/usr/local/ssl",
-        "/usr/local/openssl",
-        "/usr/local/etc/openssl",
-        "/usr/local/share",
+        "@PREFIX@/share",
         "/usr/lib/ssl",
         "/usr/ssl",
         "/etc/openssl",


[FILE:471:patches/patch-vendor_openssl-sys_build_main.rs]
--- vendor/openssl-sys/build/main.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/openssl-sys/build/main.rs
@@ -254,6 +254,9 @@ See rust-openssl README for more informa
             (3, 3, _) => ('3', '3', 'x'),
             (3, 4, 0) => ('3', '4', '0'),
             (3, 4, _) => ('3', '4', 'x'),
+            (3, 5, _) => ('3', '5', 'x'),
+            (3, 6, 0) => ('3', '6', '0'),
+            (3, 6, _) => ('3', '6', 'x'),
             _ => version_error(),
         };
 


[FILE:824:patches/patch-vendor_os__info_src_freebsd_mod.rs]
--- vendor/os_info/src/freebsd/mod.rs.orig	2022-12-12 18:23:58 UTC
+++ vendor/os_info/src/freebsd/mod.rs
@@ -30,17 +30,7 @@ fn get_os() -> Type {
         .expect("Failed to get OS");
 
     match str::from_utf8(&os.stdout) {
-        Ok("FreeBSD\n") => {
-            let check_hardening = Command::new("sysctl")
-                .arg("hardening.version")
-                .output()
-                .expect("Failed to check if is hardened");
-            match str::from_utf8(&check_hardening.stderr) {
-                Ok("0\n") => Type::HardenedBSD,
-                Ok(_) => Type::FreeBSD,
-                Err(_) => Type::FreeBSD,
-            }
-        }
+        Ok("FreeBSD\n") => Type::FreeBSD,
         Ok("MidnightBSD\n") => Type::MidnightBSD,
         Ok(_) => Type::Unknown,
         Err(_) => Type::Unknown,


[FILE:2531:patches/patch-vendor_rustix_src_imp_libc_fs_dir.rs]
--- vendor/rustix/src/imp/libc/fs/dir.rs.orig	2022-12-12 18:23:59 UTC
+++ vendor/rustix/src/imp/libc/fs/dir.rs
@@ -172,10 +172,10 @@ unsafe fn read_dirent(input: &libc_diren
     )))]
     let d_ino = input.d_ino;
 
-    #[cfg(any(target_os = "freebsd", target_os = "netbsd", target_os = "openbsd"))]
+    #[cfg(any(target_os = "freebsd", target_os = "netbsd", target_os = "openbsd", target_os = "dragonfly"))]
     let d_fileno = input.d_fileno;
 
-    #[cfg(not(target_os = "wasi"))]
+    #[cfg(not(any(target_os = "wasi", target_os = "dragonfly")))]
     let d_reclen = input.d_reclen;
 
     #[cfg(any(
@@ -184,12 +184,18 @@ unsafe fn read_dirent(input: &libc_diren
         target_os = "openbsd",
         target_os = "ios",
         target_os = "macos",
+        target_os = "dragonfly",
     ))]
     let d_namlen = input.d_namlen;
 
     #[cfg(any(target_os = "ios", target_os = "macos"))]
     let d_seekoff = input.d_seekoff;
 
+    #[cfg(target_os = "dragonfly")]
+    let d_unused1 = input.d_unused1;
+    #[cfg(target_os = "dragonfly")]
+    let d_unused2 = input.d_unused2;
+
     // Construct the input. Rust will give us an error if any OS has a input
     // with a field that we missed here. And we can avoid blindly copying the
     // whole `d_name` field, which may not be entirely allocated.
@@ -213,9 +219,9 @@ unsafe fn read_dirent(input: &libc_diren
             target_os = "openbsd",
         )))]
         d_ino,
-        #[cfg(any(target_os = "freebsd", target_os = "netbsd", target_os = "openbsd"))]
+        #[cfg(any(target_os = "freebsd", target_os = "netbsd", target_os = "openbsd", target_os = "dragonfly"))]
         d_fileno,
-        #[cfg(not(target_os = "wasi"))]
+        #[cfg(not(any(target_os = "wasi", target_os = "dragonfly")))]
         d_reclen,
         #[cfg(any(
             target_os = "freebsd",
@@ -223,10 +229,15 @@ unsafe fn read_dirent(input: &libc_diren
             target_os = "macos",
             target_os = "netbsd",
             target_os = "openbsd",
+            target_os = "dragonfly",
         ))]
         d_namlen,
         #[cfg(any(target_os = "ios", target_os = "macos"))]
         d_seekoff,
+        #[cfg(target_os = "dragonfly")]
+        d_unused1,
+        #[cfg(target_os = "dragonfly")]
+        d_unused2,
         // The `d_name` field is NUL-terminated, and we need to be careful not
         // to read bytes past the NUL, even though they're within the nominal
         // extent of the `struct dirent`, because they may not be allocated. So


[FILE:1312:patches/patch-vendor_rustix_src_imp_libc_process_types.rs]
--- vendor/rustix/src/imp/libc/process/types.rs.orig	2022-12-12 18:23:59 UTC
+++ vendor/rustix/src/imp/libc/process/types.rs
@@ -197,6 +197,7 @@ pub enum Signal {
         target_os = "macos",
         target_os = "netbsd",
         target_os = "openbsd",
+        target_os = "dragonfly",
         all(
             any(target_os = "android", target_os = "linux"),
             any(target_arch = "mips", target_arch = "mips64"),
@@ -239,6 +240,7 @@ pub enum Signal {
         target_os = "macos",
         target_os = "netbsd",
         target_os = "openbsd",
+        target_os = "dragonfly",
     )))]
     #[doc(alias = "Pwr")]
     Power = c::SIGPWR,
@@ -274,6 +276,7 @@ impl Signal {
                 target_os = "macos",
                 target_os = "netbsd",
                 target_os = "openbsd",
+                target_os = "dragonfly",
                 all(
                     any(target_os = "android", target_os = "linux"),
                     any(target_arch = "mips", target_arch = "mips64"),
@@ -299,6 +302,7 @@ impl Signal {
                 target_os = "macos",
                 target_os = "netbsd",
                 target_os = "openbsd",
+                target_os = "dragonfly",
             )))]
             c::SIGPWR => Some(Self::Power),
             c::SIGSYS => Some(Self::Sys),


[FILE:891:files/build_curl.sh]
#!/bin/sh

PREFIX="$1"
CONFIGURE_TARGET="$2"

cd /construction/rust/curl-* || exit
CONFIG_GUESS_DIRS=$(find * -name config.guess -o -name config.sub | xargs -n 1 dirname 2>/dev/null)
for _D in ${CONFIG_GUESS_DIRS}; do \
	rm "${_D}/config.guess"; \
	cp /xports/Mk/Templates/config.guess "${_D}/config.guess"; \
	chmod a+rx "${_D}/config.guess"; \
	rm "${_D}/config.sub"; \
	cp /xports/Mk/Templates/config.sub "${_D}/config.sub"; \
	chmod a+rx "${_D}/config.sub"; \
done

env MAKE=gmake \
	CONFIG_SITE=/xports/Mk/Templates/config.site \
/bin/sh configure \
	--prefix="${PREFIX}" \
	--build="${CONFIGURE_TARGET}" \
	--disable-werror \
	--disable-shared \
	--disable-imap \
	--disable-pop3 \
	--disable-smtp \
	--with-ca-bundle="${PREFIX}/share/certs/ca-root-nss.crt" \
	--enable-cookies \
	--without-nghttp2 \
	--with-ssl="${PREFIX}/libressl" \
	--enable-pthreads \
	--enable-threaded-resolver


[FILE:478:files/special.mk]
.if "${OPSYS}" == "DragonFly"
DF_INDEX+=		2 3 4
COMPEXT=		zst
.elif "${OPSYS}" == "FreeBSD"
DF_INDEX+=		5 6 7
COMPEXT=		gz
.elif "${OPSYS}" == "Linux"
DF_INDEX+=		8 9 10
COMPEXT=		gz
SFX=			${ARCH_STANDARD}-unknown-linux-gnu
.elif "${OPSYS}" == "NetBSD"
DF_INDEX+=		11 12 13
COMPEXT=		gz
.endif
SFX?=			${ARCH_STANDARD}-unknown-${OPSYS:tl}
SRC_RUSTC?=		rustc-${BOOTSTRAP_RUST}-${SFX}
SRC_RUSTSTD?=		rust-std-${BOOTSTRAP_RUST}-${SFX}
SRC_CARGO?=		cargo-${BOOTSTRAP_CARGO}-${SFX}

